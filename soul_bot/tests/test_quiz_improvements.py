"""
–¢–µ—Å—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π –∫–≤–∏–∑–∞ (TIER 1 + TIER 2)

–ü—Ä–æ–≤–µ—Ä—è–µ–º:
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –∫ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –æ—Ç–≤–µ—Ç–æ–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
"""
import pytest


def test_add_emoji_to_option():
    """–¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ –∫ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –æ—Ç–≤–µ—Ç–æ–≤"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–Ω–µ—Å—Ç–∏ –≤ utils –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
    from bot.handlers.user.quiz import _add_emoji_to_option
    
    # –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏
    assert _add_emoji_to_option("–ü–∞–Ω–∏–∫–∞ –∏ —Å—Ç—ã–¥") == "üò∞ –ü–∞–Ω–∏–∫–∞ –∏ —Å—Ç—ã–¥"
    assert _add_emoji_to_option("–ó–ª—é—Å—å –Ω–∞ –±–∞–Ω–∫") == "üò§ –ó–ª—é—Å—å –Ω–∞ –±–∞–Ω–∫"
    assert _add_emoji_to_option("–°–º—É—â—ë–Ω–Ω–æ –∏–∑–≤–∏–Ω—è—é—Å—å") == "üòÖ –°–º—É—â—ë–Ω–Ω–æ –∏–∑–≤–∏–Ω—è—é—Å—å"
    
    # –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏
    assert _add_emoji_to_option("–°–ø–æ–∫–æ–π–Ω–æ –¥–æ—Å—Ç–∞—é –∫–∞—Ä—Ç—É") == "üòå –°–ø–æ–∫–æ–π–Ω–æ –¥–æ—Å—Ç–∞—é –∫–∞—Ä—Ç—É"
    assert _add_emoji_to_option("–†–∞–¥–æ—Å—Ç—å") == "üòä –†–∞–¥–æ—Å—Ç—å"
    
    # –ß–∞—Å—Ç–æ—Ç–∞ (scale)
    assert _add_emoji_to_option("–ù–∏–∫–æ–≥–¥–∞") == "‚≠ï –ù–∏–∫–æ–≥–¥–∞"
    assert _add_emoji_to_option("–†–µ–¥–∫–æ") == "üü° –†–µ–¥–∫–æ"
    assert _add_emoji_to_option("–ò–Ω–æ–≥–¥–∞") == "üü† –ò–Ω–æ–≥–¥–∞"
    assert _add_emoji_to_option("–ß–∞—Å—Ç–æ") == "üî¥ –ß–∞—Å—Ç–æ"
    assert _add_emoji_to_option("–ü–æ—Å—Ç–æ—è–Ω–Ω–æ") == "üî• –ü–æ—Å—Ç–æ—è–Ω–Ω–æ"
    
    # –ë–µ–∑ —ç–º–æ–¥–∑–∏ (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
    assert _add_emoji_to_option("–ß—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ") == "–ß—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ"
    
    # –£–∂–µ –µ—Å—Ç—å —ç–º–æ–¥–∑–∏ - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
    assert _add_emoji_to_option("üò∞ –ü–∞–Ω–∏–∫–∞") == "üò∞ –ü–∞–Ω–∏–∫–∞"


def test_add_emoji_case_insensitive():
    """–≠–º–æ–¥–∑–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞"""
    from bot.handlers.user.quiz import _add_emoji_to_option
    
    assert _add_emoji_to_option("–ü–ê–ù–ò–ö–ê") == "üò∞ –ü–ê–ù–ò–ö–ê"
    assert _add_emoji_to_option("–Ω–∏–∫–æ–≥–¥–∞") == "‚≠ï –Ω–∏–∫–æ–≥–¥–∞"
    assert _add_emoji_to_option("–°–ø–û–∫–û–π–ù–æ") == "üòå –°–ø–û–∫–û–π–ù–æ"


def test_add_emoji_partial_match():
    """–≠–º–æ–¥–∑–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ —á–∞—Å—Ç–∏ —Å–ª–æ–≤–∞"""
    from bot.handlers.user.quiz import _add_emoji_to_option
    
    # "—Å–º—É—â" –¥–æ–ª–∂–µ–Ω –º–∞—Ç—á–∏—Ç—å "–°–º—É—â—ë–Ω–Ω–æ –∏–∑–≤–∏–Ω—è—é—Å—å"
    assert _add_emoji_to_option("–°–º—É—â—ë–Ω–Ω–æ –∏–∑–≤–∏–Ω—è—é—Å—å") == "üòÖ –°–º—É—â—ë–Ω–Ω–æ –∏–∑–≤–∏–Ω—è—é—Å—å"
    
    # "—Å–ø–æ–∫–æ–π–Ω–æ" –¥–æ–ª–∂–µ–Ω –º–∞—Ç—á–∏—Ç—å "–°–ø–æ–∫–æ–π–Ω–æ –¥–æ—Å—Ç–∞—é –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É"
    assert _add_emoji_to_option("–°–ø–æ–∫–æ–π–Ω–æ –¥–æ—Å—Ç–∞—é –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É") == "üòå –°–ø–æ–∫–æ–π–Ω–æ –¥–æ—Å—Ç–∞—é –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É"


def test_question_formatting():
    """–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤"""
    from bot.services.quiz_service.generator import format_question_for_telegram
    
    # –í–æ–ø—Ä–æ—Å —Å preface
    question = {
        'text': '–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ?',
        'type': 'text',
        'category': 'relationships',
        'preface': '–î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ.'
    }
    
    result = format_question_for_telegram(question, current=1, total=10)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    assert '‚ù§Ô∏è' in result  # –≠–º–æ–¥–∑–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    assert '–í–æ–ø—Ä–æ—Å 1 –∏–∑ 10' in result  # "–∏–∑" –≤–º–µ—Å—Ç–æ "/"
    assert '<b>–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ?</b>' in result  # –í–æ–ø—Ä–æ—Å –∂–∏—Ä–Ω—ã–º
    assert '<i>–î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ.</i>' in result  # Preface –∫—É—Ä—Å–∏–≤–æ–º
    assert '‚úçÔ∏è' in result  # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ \n –ø–æ–¥—Ä—è–¥)
    assert '\n\n' in result


def test_question_formatting_without_preface():
    """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ preface"""
    from bot.services.quiz_service.generator import format_question_for_telegram
    
    question = {
        'text': '–ö–∞–∫ —á–∞—Å—Ç–æ —Ç—ã —ç—Ç–æ –¥–µ–ª–∞–µ—à—å?',
        'type': 'scale',
        'category': 'money',
        'options': ['–ù–∏–∫–æ–≥–¥–∞', '–†–µ–¥–∫–æ', '–ò–Ω–æ–≥–¥–∞', '–ß–∞—Å—Ç–æ', '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ']
    }
    
    result = format_question_for_telegram(question, current=5, total=10)
    
    assert 'üí∞' in result  # –≠–º–æ–¥–∑–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–µ–Ω—å–≥–∏
    assert '–í–æ–ø—Ä–æ—Å 5 –∏–∑ 10' in result
    assert '<b>–ö–∞–∫ —á–∞—Å—Ç–æ —Ç—ã —ç—Ç–æ –¥–µ–ª–∞–µ—à—å?</b>' in result
    assert 'üìä' in result  # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è scale –≤–æ–ø—Ä–æ—Å–∞
    assert '–ù–∏–∫–æ–≥–¥–∞ ‚Üí –ü–æ—Å—Ç–æ—è–Ω–Ω–æ' in result  # Preview —à–∫–∞–ª—ã


if __name__ == '__main__':
    # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    test_add_emoji_to_option()
    test_add_emoji_case_insensitive()
    test_add_emoji_partial_match()
    test_question_formatting()
    test_question_formatting_without_preface()
    print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!")

