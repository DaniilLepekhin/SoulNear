"""
üíå Retention Messages Handler

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ –º—è–≥–∫–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –¥–æ–ø—Ä–æ–¥–∞–∂–∏ –ø–æ–¥–ø–∏—Å–∫–∏
–ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è 5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
"""
from datetime import datetime
from bot.loader import bot
import database.repository.user as db_user


# 10-15 retention —Å–æ–æ–±—â–µ–Ω–∏–π (–º—è–≥–∫–∏–µ, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è)
RETENTION_MESSAGES = [
    "–ü—Ä–∏–≤–µ—Ç ü§ç\n\n–ö–∞–∫ —Ç—ã?",

    "–¢–µ–±–µ –ø–æ—Å–ª–∞–Ω–∏–µ...\n\n"
    "<i>–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –≤–Ω—É—Ç—Ä–∏ –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è?\n"
    "–ö–æ–≥–¥–∞ –≤—Å–µ –≤—Ä–æ–¥–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ—Ç.\n\n"
    "–≠—Ç–æ –Ω–µ —Ç—Ä–µ–≤–æ–≥–∞.\n"
    "–≠—Ç–æ ‚Äî —Å–∏–≥–Ω–∞–ª.</i>\n\n"
    "–Ø —Ä—è–¥–æ–º, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å.",

    "–ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å? üí´",

    "<i>–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ —Ç–µ–±—è —Å–ª—ã—à–∞—Ç.\n\n"
    "–ë–µ–∑ —Å–æ–≤–µ—Ç–æ–≤.\n"
    "–ë–µ–∑ –æ—Ü–µ–Ω–æ–∫.\n\n"
    "–ü—Ä–æ—Å—Ç–æ ‚Äî —Å–ª—ã—à–∞—Ç.</i>\n\n"
    "–Ø –∑–¥–µ—Å—å, –µ—Å–ª–∏ —á—Ç–æ.",

    "–ü—Ä–∏–≤–µ—Ç üåô\n\n"
    "–•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ —Ç–æ–º, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏?",

    "<b>–ó–Ω–∞–µ—à—å, —á—Ç–æ —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ?</b>\n\n"
    "<i>–ù–µ –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç.\n"
    "–ê –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è —Å–µ–±–µ –≤ –≤–æ–ø—Ä–æ—Å–µ.</i>\n\n"
    "–ï—Å–ª–∏ –≥–æ—Ç–æ–≤ ‚Äî —è —Ä—è–¥–æ–º.",

    "–ö–∞–∫ —Ç—ã —Å–µ–≥–æ–¥–Ω—è? üí¨",

    "<i>–¢—ã –º–æ–∂–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤.\n\n"
    "–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã, —Ä–∞–∑–±–æ—Ä—ã, –ø—Ä–∞–∫—Ç–∏–∫–∏ ‚Äî –≤—Å—ë –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏.</i>\n\n"
    "–ï—Å–ª–∏ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è ‚Äî –∂–º–∏ —Å—é–¥–∞: /premium",

    "–ü—Ä–∏–≤–µ—Ç ü§ç\n\n"
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å ‚Äî —è –∑–¥–µ—Å—å.",

    "<b>–¢—ã –ø–æ–º–Ω–∏—à—å –Ω–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä?</b>\n\n"
    "<i>–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Äî –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç–∫—Ä—ã—Ç–∞.</i>\n\n"
    "–¢–∞–º –±–µ–∑–ª–∏–º–∏—Ç, —Ä–∞–∑–±–æ—Ä—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏.\n\n"
    "/premium",

    "–ö–∞–∫ –¥–µ–ª–∞? üí´\n\n"
    "–•–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞–∑–≥–æ–≤–æ—Ä—É?",

    "<i>–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ —Ç–æ—Ç, –∫—Ç–æ –Ω–µ —Å—É–¥–∏—Ç.\n\n"
    "–ö—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ª—ã—à–∏—Ç.</i>\n\n"
    "–Ø —Ä—è–¥–æ–º. –í—Å–µ–≥–¥–∞.\n\n"
    "/premium",

    "–ü—Ä–∏–≤–µ—Ç üåô\n\n"
    "–•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?",

    "<b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.</b>\n\n"
    "<i>–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ ‚Äî –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∂–¥—ë—Ç —Ç–µ–±—è.\n\n"
    "–ë–µ–∑–ª–∏–º–∏—Ç. –†–∞–∑–±–æ—Ä—ã. –ü—Ä–∞–∫—Ç–∏–∫–∏.</i>\n\n"
    "/premium",

    "ü§ç\n\n"
    "<i>–Ø –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, –µ—Å–ª–∏ —á—Ç–æ.</i>"
]


async def send_next_retention_message(user_id: int):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ retention —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    """
    user = await db_user.get(user_id)

    if not user:
        return

    # –ï—Å–ª–∏ –∫—É–ø–∏–ª –ø–æ–¥–ø–∏—Å–∫—É - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    if user.sub_date >= datetime.now():
        return

    # –ï—Å–ª–∏ –ø–∞—É–∑–∞ (–æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    if user.retention_paused:
        return

    # –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    msg_index = user.last_retention_message
    if msg_index >= len(RETENTION_MESSAGES):
        return  # –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å
    try:
        await bot.send_message(
            user_id,
            RETENTION_MESSAGES[msg_index],
            parse_mode='HTML'
        )

        # –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
        await db_user.update(
            user_id=user_id,
            last_retention_message=msg_index + 1,
            last_retention_sent=datetime.now()
        )

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ retention —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")


async def pause_retention_for_user(user_id: int):
    """
    –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å retention –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª
    """
    await db_user.update(
        user_id=user_id,
        retention_paused=True
    )
