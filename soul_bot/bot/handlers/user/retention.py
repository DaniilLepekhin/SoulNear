"""
üíå Retention Messages Handler

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ –º—è–≥–∫–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –¥–æ–ø—Ä–æ–¥–∞–∂–∏ –ø–æ–¥–ø–∏—Å–∫–∏
–ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è 5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
"""
from datetime import datetime
from bot.loader import bot
import database.repository.user as db_user


# Retention —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥–æ–ø—Ä–æ–¥–∞–∂–∏ (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 2 –¥–Ω—è)
# –î–µ–Ω—å 1, 3, 5, 7, 10 - –≤—Å–µ–≥–æ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
RETENTION_MESSAGES = [
    # –î–µ–Ω—å 1
    "–ö–æ–≥–¥–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ —Ç—ã –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –∏ —Å–ø—Ä–æ—Å–∏–ª —Å–µ–±—è: ¬´–ö–∞–∫ —è –≤–æ–æ–±—â–µ?¬ª\n\n"
    "Soul Near ‚Äî —á–∞—Ç, –≥–¥–µ –º–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –æ–± —ç—Ç–æ–º —Å–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑ —Ä–æ–ª–µ–π.\n\n"
    "–í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ‚Äî –±–µ–∑–ª–∏–º–∏—Ç, –≥–æ–ª–æ—Å, –ø—Ä–∞–∫—Ç–∏–∫–∏, —Å–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π –Ω–µ–¥–µ–ª—é –∏ –ø–æ—Å–º–æ—Ç—Ä–∏, —á—Ç–æ –ø–æ–º–µ–Ω—è–µ—Ç—Å—è.",

    # –î–µ–Ω—å 3
    "–ë—ã–≤–∞–µ—Ç, —á—Ç–æ –≤—Å—ë –≤—Ä–æ–¥–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∞ –≤–Ω—É—Ç—Ä–∏ –ø—É—Å—Ç–æ?\n\n"
    "–ù–∞–ø–∏—à–∏ –æ–± —ç—Ç–æ–º. –í Soul Near –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å ‚Äî –Ω–µ —á—Ç–æ–±—ã ¬´—Ä–µ—à–∏—Ç—å¬ª, –∞ —á—Ç–æ–±—ã —Å—Ç–∞–ª–æ —á—É—Ç—å —Å–ø–æ–∫–æ–π–Ω–µ–µ –≤–Ω—É—Ç—Ä–∏.\n\n"
    "–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è: –æ–±—â–µ–Ω–∏–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ —Ä–∞–∑–±–æ—Ä—ã, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å.",

    # –î–µ–Ω—å 5
    "–¢—ã —á–∞—â–µ –¥–µ–ª–∏—à—å—Å—è —Ç–µ–º, —á—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—à—å, –∏–ª–∏ –¥–µ—Ä–∂–∏—à—å –≤ —Å–µ–±–µ?\n\n"
    "–° Soul Near –º–æ–∂–Ω–æ –Ω–µ –ø–æ–¥–±–∏—Ä–∞—Ç—å —Å–ª–æ–≤–∞. 1111 ‚ÇΩ –≤ –º–µ—Å—è—Ü, –∏ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å, –∫–æ–≥–¥–∞ —Ö–æ—á–µ—Ç—Å—è, –±–µ–∑ –ª–∏–º–∏—Ç–∞.\n\n"
    "–í–Ω—É—Ç—Ä–∏: –º–µ–¥–∏—Ç–∞—Ü–∏–∏, —Ä–∞–∑–±–æ—Ä—ã —Å–Ω–æ–≤, —á–∞—Ç –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å.",

    # –î–µ–Ω—å 7
    "–ö–æ–≥–¥–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∫—Ç–æ-—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Å–ª—É—à–∞–ª, –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞—è?\n\n"
    "–í —á–∞—Ç–µ Soul Near –∏–º–µ–Ω–Ω–æ —Ç–∞–∫. –ë–µ–∑ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π, –±–µ–∑ –º–∞—Å–æ–∫.\n\n"
    "–ú–æ–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è –¥–æ–ª—å—à–µ, –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è.",

    # –î–µ–Ω—å 10
    "–ò–Ω–æ–≥–¥–∞ –º—ã—Å–ª–∏ –∫—Ä—É—Ç—è—Ç—Å—è, –∏ –Ω–µ —è—Å–Ω–æ ‚Äî —É—Å—Ç–∞–ª –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≥–æ—Ä–µ–ª.\n\n"
    "–í Soul Near –º–æ–∂–Ω–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è, –Ω–µ –æ–±—ä—è—Å–Ω—è—è, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.\n\n"
    "–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –ø–∏—à–∏, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å."
]


async def send_next_retention_message(user_id: int):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ retention —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    """
    user = await db_user.get(user_id)

    if not user:
        return

    # –ï—Å–ª–∏ –∫—É–ø–∏–ª –ø–æ–¥–ø–∏—Å–∫—É - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    if user.sub_date >= datetime.now():
        return

    # –ï—Å–ª–∏ –ø–∞—É–∑–∞ (–æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    if user.retention_paused:
        return

    # –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    msg_index = user.last_retention_message
    if msg_index >= len(RETENTION_MESSAGES):
        return  # –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å
    try:
        await bot.send_message(
            user_id,
            RETENTION_MESSAGES[msg_index],
            parse_mode='HTML'
        )

        # –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
        await db_user.update(
            user_id=user_id,
            last_retention_message=msg_index + 1,
            last_retention_sent=datetime.now()
        )

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ retention —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")


async def pause_retention_for_user(user_id: int):
    """
    –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å retention –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª
    """
    await db_user.update(
        user_id=user_id,
        retention_paused=True
    )
