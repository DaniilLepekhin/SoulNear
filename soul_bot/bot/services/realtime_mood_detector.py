"""
üö® Realtime Mood Detector - —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

–ó–∞—á–µ–º:
- Pattern Analyzer —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–∫–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ù–æ –µ—Å–ª–∏ user: "—É –º–µ–Ω—è –ø–∞–Ω–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°" - –Ω—É–∂–Ω–∞ –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø —Ä–µ–∞–∫—Ü–∏—è
- –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–µ—Ç–µ–∫—Ç–∏—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ë–ï–ó GPT (< 1ms —á–µ—Ä–µ–∑ regex/keywords)

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
1. Fast keyword matching (regex)
2. Urgency classification (high/medium/low)
3. Suggested response style override

–ê–≤—Ç–æ—Ä: AI Agent
–°–æ–∑–¥–∞–Ω: 2025-10-31
"""

import re
from typing import Optional, Literal
from dataclasses import dataclass


@dataclass
class EmotionalSignal:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞"""
    urgency: Literal['high', 'medium', 'low']
    emotion: Literal['panic', 'despair', 'anger', 'joy', 'stress', 'sadness']
    suggested_tone: Literal['calm', 'supportive', 'celebratory', 'empathetic']
    trigger_keywords: list[str]  # –ö–∞–∫–∏–µ keywords —Å—Ä–∞–±–æ—Ç–∞–ª–∏
    confidence: float  # 0.0-1.0


# ==========================================
# üö® URGENT KEYWORDS (HIGH PRIORITY)
# ==========================================

URGENT_KEYWORDS = {
    'panic': {
        'keywords': [
            r'–ø–∞–Ω–∏—á–µ—Å–∫\w* –∞—Ç–∞–∫\w*',
            r'–∑–∞–¥—ã—Ö–∞—é—Å—å',
            r'—Å–µ—Ä–¥[—Üe]\w* –∫–æ–ª–æ—Ç–∏[—Ç–ª]\w*',
            r'–Ω–µ –º–æ–≥—É –¥—ã—à–∞—Ç—å',
            r'—É–º–∏—Ä–∞—é',
            r'—Å—Ç—Ä–∞—à–Ω–æ –æ—á–µ–Ω—å',
            r'–ø–∞–Ω–∏–∫\w*'
        ],
        'tone': 'calm',
        'urgency': 'high'
    },
    
    'despair': {
        'keywords': [
            r'–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å',
            r'–≤—Å—ë –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω\w*',
            r'–∫–æ–Ω—á–∏—Ç—å —Å —Å–æ–±–æ–π',
            r'—Å—É–∏—Ü–∏–¥\w*',
            r'–Ω–µ—Ç —Å–º—ã—Å–ª–∞',
            r'–∫–æ–Ω–µ—Ü',
            r'–Ω–µ –≤–∏–∂—É –≤—ã—Ö–æ–¥\w*'
        ],
        'tone': 'supportive',
        'urgency': 'high'
    },
    
    'anger': {
        'keywords': [
            r'–±–µ—Å–∏—Ç',
            r'–Ω–µ–Ω–∞–≤–∏–∂\w*',
            r'—É–±–∏—Ç—å –≥–æ—Ç–æ–≤\w*',
            r'—Å—É–∫–∞',
            r'–±–ª—è\w*',
            r'–¥–æ—Å—Ç–∞–ª\w*',
            r'–≤–∑–±–µ—Å–∏–ª\w*'
        ],
        'tone': 'calm',
        'urgency': 'medium'
    },
    
    'stress': {
        'keywords': [
            r'—Å—Ç—Ä–µ—Å—Å\w*',
            r'–Ω–µ —Å–ø—Ä–∞–≤–ª—è—é—Å—å',
            r'—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ',
            r'–≥–æ–ª–æ–≤–∞ –∫—Ä—É–≥–æ–º',
            r'–Ω–µ —É—Å–ø–µ–≤–∞—é',
            r'–¥–∞–≤–ª–µ–Ω–∏\w* —Å–∏–ª—å–Ω\w*'
        ],
        'tone': 'supportive',
        'urgency': 'medium'
    },
    
    'joy': {
        'keywords': [
            r'—É—Ä–∞\w*',
            r'–ø–æ–ª—É—á–∏–ª–æ—Å—å',
            r'—Å—á–∞—Å—Ç–ª–∏–≤\w*',
            r'–∫—Ä—É—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å',
            r'—è —Å–¥–µ–ª–∞–ª\w*',
            r'–ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–∞–∫–æ–Ω–µ—Ü'
        ],
        'tone': 'celebratory',
        'urgency': 'low'
    },
    
    'sadness': {
        'keywords': [
            r'–≥—Ä—É—Å—Ç–Ω\w*',
            r'–ø–ª–∞—á\w*',
            r'–æ–¥–∏–Ω–æ–∫\w*',
            r'–Ω–∏–∫–æ–º—É –Ω–µ –Ω—É–∂–µ–Ω',
            r'–ø–µ—á–∞–ª—å–Ω\w*',
            r'—Ç–æ—Å–∫–ª–∏–≤–æ'
        ],
        'tone': 'empathetic',
        'urgency': 'medium'
    }
}


# ==========================================
# üîç DETECTION FUNCTIONS
# ==========================================

def detect_urgent_emotional_signals(message: str) -> Optional[EmotionalSignal]:
    """
    –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (< 1ms)
    
    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        EmotionalSignal –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
        
    Examples:
        >>> detect_urgent_emotional_signals("—É –º–µ–Ω—è –ø–∞–Ω–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞")
        EmotionalSignal(urgency='high', emotion='panic', ...)
        
        >>> detect_urgent_emotional_signals("–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞")
        None
    """
    if not message or len(message.strip()) < 3:
        return None
    
    message_lower = message.lower()
    
    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —ç–º–æ—Ü–∏–π
    for emotion, config in URGENT_KEYWORDS.items():
        matched_keywords = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π keyword pattern
        for pattern in config['keywords']:
            if re.search(pattern, message_lower):
                matched_keywords.append(pattern)
        
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è - —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if matched_keywords:
            confidence = min(1.0, len(matched_keywords) / 2)  # –ë–æ–ª—å—à–µ keywords = –≤—ã—à–µ confidence
            
            return EmotionalSignal(
                urgency=config['urgency'],
                emotion=emotion,
                suggested_tone=config['tone'],
                trigger_keywords=matched_keywords,
                confidence=confidence
            )
    
    return None


def should_override_system_prompt(signal: Optional[EmotionalSignal]) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω—É–∂–Ω–æ –ª–∏ override —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π system prompt
    
    Args:
        signal: –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª
        
    Returns:
        True –µ—Å–ª–∏ urgency=high (emergency)
    """
    return signal is not None and signal.urgency == 'high'


# ==========================================
# üé® EMERGENCY PROMPTS
# ==========================================

EMERGENCY_PROMPTS = {
    'panic': """‚ö†Ô∏è –≠–ö–°–¢–†–ï–ù–ù–´–ô –†–ï–ñ–ò–ú: –ü–ê–ù–ò–ß–ï–°–ö–ê–Ø –ê–¢–ê–ö–ê

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç –ø–∞–Ω–∏—á–µ—Å–∫—É—é –∞—Ç–∞–∫—É –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –£—Å–ø–æ–∫–æ–∏—Ç—å (—Å–ø–æ–∫–æ–π–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π —Ç–æ–Ω)
2. –î–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –¥—ã—Ö–∞–Ω–∏—è
3. –ó–∞–∑–µ–º–ª–∏—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ (5-4-3-2-1 —Ç–µ—Ö–Ω–∏–∫–∞)

–°–¢–ò–õ–¨:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞
- –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–ù–ï –°–ï–ô–ß–ê–°!)
- –§–æ–∫—É—Å –Ω–∞ "–∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å"

–ü–†–ò–ú–ï–†:
"–°–µ–π—á–∞—Å —Ç–µ–±–µ —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ —Ç—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. 
–î–∞–≤–∞–π –¥—ã—à–∞—Ç—å –≤–º–µ—Å—Ç–µ: –≤–¥–æ—Ö –Ω–∞ 4 —Å—á—ë—Ç–∞, –≤—ã–¥–æ—Ö –Ω–∞ 6.
–ü–æ–ø—Ä–æ–±—É–π –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –Ø —Ä—è–¥–æ–º."

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–ï —Ü–∏—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –ù–ï –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π. –¢–æ–ª—å–∫–æ –ø–æ–º–æ—â—å –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°.""",

    'despair': """‚ö†Ô∏è –≠–ö–°–¢–†–ï–ù–ù–´–ô –†–ï–ñ–ò–ú: –°–£–ò–¶–ò–î–ê–õ–¨–ù–´–ï –ú–´–°–õ–ò

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ—Ç—á–∞—è–Ω–∏—è.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å
2. –ù–ï –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞—Ç—å ("–≤—Å–µ —á–µ—Ä–µ–∑ —ç—Ç–æ –ø—Ä–æ—Ö–æ–¥—è—Ç" - –ù–ï–¢!)
3. –î–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞—Ü–µ–ø–∫—É (–º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥)
4. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–º–æ—â—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–°–¢–ò–õ–¨:
- –≠–º–ø–∞—Ç–∏—è –±–µ–∑ –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π
- –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ (–Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ("—Ç—ã –Ω–µ –æ–¥–∏–Ω")

–ü–†–ò–ú–ï–†:
"–°–ª—ã—à—É —Ç–µ–±—è. –°–µ–π—á–∞—Å –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ.
–î–∞–≤–∞–π –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å, –±–µ–∑ –æ—Ü–µ–Ω–æ–∫.
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç? –†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ."

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É, –ù–ï –≥–æ–≤–æ—Ä–∏ "—ç—Ç–æ –ø—Ä–æ–π–¥—ë—Ç".""",

    'anger': """‚ö†Ô∏è –†–ï–ñ–ò–ú: –°–ò–õ–¨–ù–´–ô –ì–ù–ï–í

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —è—Ä–æ—Å—Ç–∏.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –î–∞—Ç—å –≤—ã–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä (validation)
2. –ü–æ–º–æ—á—å –Ω–∞–∑–≤–∞—Ç—å —ç–º–æ—Ü–∏—é
3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ

–°–¢–ò–õ–¨:
- –°–ø–æ–∫–æ–π–Ω—ã–π, –Ω–æ –ù–ï patronizing
- –ü—Ä–∏–∑–Ω–∞–Ω–∏–µ —ç–º–æ—Ü–∏–∏ ("—ç—Ç–æ –ø—Ä–∞–≤–¥–∞ –±–µ—Å–∏—Ç")
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã

–ü–†–ò–ú–ï–†:
"–î–∞, —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –±–µ—Å–∏—Ç. –Ø –ø–æ–Ω–∏–º–∞—é.
–•–æ—á–µ—à—å –ø—Ä–æ—Å—Ç–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –∏–ª–∏ —É–∂–µ –¥—É–º–∞–µ–º —á—Ç–æ –¥–µ–ª–∞—Ç—å?"

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–ï —É—Å–ø–æ–∫–∞–∏–≤–∞–π ("–Ω–µ –∑–ª–∏—Å—å"), –∞ –ü–†–ò–ó–ù–ê–í–ê–ô.""",

    'stress': """üî• –†–ï–ñ–ò–ú: –°–ò–õ–¨–ù–´–ô –°–¢–†–ï–°–°

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –£–ø—Ä–æ—Å—Ç–∏—Ç—å (break down)
2. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è (—á—Ç–æ –°–ï–ô–ß–ê–°)
3. –î–∞—Ç—å –ø–µ—Ä–µ–¥—ã—à–∫—É

–°–¢–ò–õ–¨:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ clarity
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏
- –£—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π —Ç–æ–Ω

–ü–†–ò–ú–ï–†:
"–û–∫–µ–π, –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ –Ω–∞–≤–∞–ª–∏–ª–æ—Å—å. –î–∞–≤–∞–π –ø–æ –ø–æ—Ä—è–¥–∫—É.
–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –°–ï–ì–û–î–ù–Ø? –ù–∞—á–Ω—ë–º —Å –æ–¥–Ω–æ–≥–æ."

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∞ –£–ë–ò–†–ê–ô (simplify)."""
}


def build_emergency_prompt(
    emotion: str,
    base_instructions: str = None
) -> str:
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å emergency system prompt
    
    Args:
        emotion: –¢–∏–ø —ç–º–æ—Ü–∏–∏ (panic, despair, anger, stress)
        base_instructions: –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–º–æ–∂–Ω–æ None)
        
    Returns:
        Emergency prompt –∫–æ—Ç–æ—Ä—ã–π OVERRIDE —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
    """
    emergency_section = EMERGENCY_PROMPTS.get(
        emotion,
        EMERGENCY_PROMPTS['stress']  # Fallback
    )
    
    prompt_parts = [emergency_section]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –∫–æ–Ω—Ü–µ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    if base_instructions:
        prompt_parts.append(f"\n---\n\n–ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã):\n{base_instructions}")
    
    return "\n\n".join(prompt_parts)


# ==========================================
# üß™ TESTS (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
# ==========================================

if __name__ == '__main__':
    # Test cases
    test_messages = [
        ("—É –º–µ–Ω—è –ø–∞–Ω–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞", "panic", "high"),
        ("–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å –±–æ–ª—å—à–µ", "despair", "high"),
        ("–±–µ—Å–∏—Ç —ç—Ç–æ—Ç –º–∏—Ä", "anger", "medium"),
        ("–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è", None, None),
        ("—É—Ä–∞ –ø–æ–ª—É—á–∏–ª–æ—Å—å!", "joy", "low"),
    ]
    
    print("üß™ Running tests...\n")
    
    for message, expected_emotion, expected_urgency in test_messages:
        signal = detect_urgent_emotional_signals(message)
        
        if signal:
            status = "‚úÖ" if signal.emotion == expected_emotion else "‚ùå"
            print(f"{status} '{message}' ‚Üí {signal.emotion} ({signal.urgency}) | confidence: {signal.confidence:.2f}")
        else:
            status = "‚úÖ" if expected_emotion is None else "‚ùå"
            print(f"{status} '{message}' ‚Üí No signal detected")
    
    print("\n‚úÖ Tests complete!")

