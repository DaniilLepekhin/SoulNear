"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI ChatCompletion API

–ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π Assistant API –Ω–∞ –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π ChatCompletion API,
—á—Ç–æ –¥–∞—ë—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- get_chat_completion() - –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç ChatCompletion API
- build_system_prompt() - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å system prompt
- save_conversation() - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
"""
import asyncio
import logging
from typing import List, Dict, Optional
from datetime import datetime

from openai import AsyncOpenAI
from openai.types.chat import ChatCompletion

from config import OPENAI_API_KEY, is_feature_enabled
from database.repository import user_profile, conversation_history
import database.repository.user as db_user
import database.repository.statistic_day as db_statistic_day

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
client = AsyncOpenAI(api_key=OPENAI_API_KEY)

logger = logging.getLogger(__name__)

DEFAULT_PATTERN_ACTIONS = {
    'imposter syndrome': '–∑–∞–ø–∏—à–∏ –æ–¥–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –ø–æ–¥–µ–ª–∏—Å—å –∏–º —Å –∫–æ–ª–ª–µ–≥–æ–π –∏–ª–∏ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö.',
    'perfectionism': '–≤—ã–¥–µ–ª–∏ 10 –º–∏–Ω—É—Ç –Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫ –±–µ–∑ –ø—Ä–∞–≤–æ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å.',
    'social anxiety in professional settings': '—Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ –∫–æ–ª–ª–µ–≥–µ —Å–µ–≥–æ–¥–Ω—è, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –∫–∞–∂–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º.',
    'procrastination through over-analysis': '–∑–∞–ø—É—Å—Ç–∏ —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç –∏ —Å–¥–µ–ª–∞–π –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –∑–∞–¥–∞—á–∏ –±–µ–∑ –æ—Ü–µ–Ω–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.',
    'negative self-talk': '–ø–µ—Ä–µ–ø–∏—à–∏ –º—ã—Å–ª—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º –∫–ª—é—á–µ –∏ –ø—Ä–æ–≥–æ–≤–æ—Ä–∏ –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –≤—Å–ª—É—Ö.',
}


def _deduplicate_quotes(quotes: List[str]) -> List[str]:
    """–£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —Ü–∏—Ç–∞—Ç (—Ä–µ–≥–∏—Å—Ç—Ä –∏ –ø—Ä–æ–±–µ–ª—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)."""
    seen = set()
    unique_quotes: List[str] = []
    for quote in quotes or []:
        if not quote:
            continue
        normalized = " ".join(quote.strip().split())
        key = normalized.lower()
        if key in seen:
            continue
        seen.add(key)
        unique_quotes.append(normalized)
    return unique_quotes


def _format_occurrence_text(value: Optional[int]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º."""
    count = int(value or 0)
    if count < 1:
        count = 1
    last_digit = count % 10
    last_two = count % 100
    if last_digit == 1 and last_two != 11:
        suffix = "—Ä–∞–∑"
    elif last_digit in (2, 3, 4) and last_two not in (12, 13, 14):
        suffix = "—Ä–∞–∑–∞"
    else:
        suffix = "—Ä–∞–∑"
    return f"{count} {suffix}"


def _select_action_for_pattern(title: str, pattern_type: Optional[str]) -> str:
    title_key = (title or '').lower()
    for known_key, action in DEFAULT_PATTERN_ACTIONS.items():
        if known_key in title_key:
            return action
    type_key = (pattern_type or '').lower()
    for known_key, action in DEFAULT_PATTERN_ACTIONS.items():
        if known_key in type_key:
            return action
    return '–≤—ã–¥–µ–ª–∏ 5 –º–∏–Ω—É—Ç –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∏ –∑–∞–ø–∏—à–∏, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å.'


def _extract_first_sentence(text: str) -> str:
    if not text:
        return ""
    stripped = text.strip()
    if not stripped:
        return ""
    for delimiter in ['.', '!', '?']:
        stripped = stripped.replace(f'{delimiter}\n', f'{delimiter} ')
    sentences = [s.strip() for s in stripped.split('.') if s.strip()]
    if sentences:
        return sentences[0]
    return stripped.split('\n')[0]


def _build_supportive_sentence(profile) -> str:
    tone = getattr(profile, 'tone_style', '')
    personality = getattr(profile, 'personality', '')
    if tone == 'sarcastic':
        return '–°–æ–æ–±—â–∏ –ø–æ—Ç–æ–º, –∫–∞–∫ –º–∏—Ä –≤—ã–∂–∏–ª –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞.'
    if personality == 'friend' or tone == 'friendly':
        return '–ù–∞–ø–∏—à–∏ –ø–æ—Ç–æ–º, –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ—à–ª–æ ‚Äî —è —Ä—è–¥–æ–º.'
    return '–°–æ–æ–±—â–∏ –ø–æ–∑–∂–µ, –∫–∞–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ—Ç —à–∞–≥.'


def _get_display_name(user) -> Optional[str]:
    if not user:
        return None
    if getattr(user, 'real_name', None):
        return user.real_name
    return getattr(user, 'first_name', None)


def _ensure_period(text: str) -> str:
    if not text:
        return ''
    stripped = text.strip()
    if not stripped:
        return ''
    if stripped[-1] in '.!?':
        return stripped
    return f'{stripped}.'


# ==========================================
# üé® –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô SYSTEM PROMPT
# ==========================================

async def build_system_prompt(
    user_id: int,
    assistant_type: str,
    base_instructions: str = None
) -> str:
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π system prompt –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        assistant_type: –¢–∏–ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (helper, sleeper, etc.)
        base_instructions: –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–µ—Å–ª–∏ None, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
        
    Returns:
        –ü–æ–ª–Ω—ã–π system prompt
    """
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    profile = await user_profile.get_or_create(user_id)
    user = await db_user.get(user_id)
    
    # –°—Ç—Ä–æ–∏–º –ø—Ä–æ–º–ø—Ç –ø–æ —á–∞—Å—Ç—è–º
    prompt_parts = []
    
    # ==========================================
    # üé® –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–ò–õ–Ø (–ü–ï–†–í–´–ú –î–ï–õ–û–ú!)
    # ==========================================
    # –ö–†–ò–¢–ò–ß–ù–û: –°—Ç–∞–≤–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è –í –ù–ê–ß–ê–õ–û –ø—Ä–æ–º–ø—Ç–∞,
    # —á—Ç–æ–±—ã GPT-4 —É–¥–µ–ª–∏–ª –∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ
    style_instructions = _build_style_instructions(profile)
    if style_instructions:
        prompt_parts.append(style_instructions)
    
    # ==========================================
    # üìã –ë–ê–ó–û–í–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò
    # ==========================================
    if base_instructions is None:
        base_instructions = _get_base_instructions(assistant_type)
    
    prompt_parts.append("\n## üìã –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:")
    prompt_parts.append(base_instructions)
    
    # ==========================================
    # –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï
    # ==========================================
    if user:
        user_info = []
        if user.real_name:
            user_info.append(f"–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user.real_name}")
        if user.age:
            user_info.append(f"–í–æ–∑—Ä–∞—Å—Ç: {user.age}")
        if user.gender is not None:
            gender = "–º—É–∂—Å–∫–æ–π" if user.gender else "–∂–µ–Ω—Å–∫–∏–π"
            user_info.append(f"–ü–æ–ª: {gender}")
        
        if user_info:
            prompt_parts.append("\n## üë§ –û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n" + "\n".join(user_info))
        else:
            prompt_parts.append(
                "\n## üë§ –û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n"
                "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–º—è –∏ –Ω–µ –æ–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏."
            )
    else:
        prompt_parts.append(
            "\n## üë§ –û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n"
            "–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–º–µ–Ω–∏. –û–±—Ä–∞—â–∞–π—Å—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ü—Ä–∏–≤–µ—Ç' –±–µ–∑ –∏–º–µ–Ω–∏)."
        )
    
    # ==========================================
    # –ü–ê–¢–¢–ï–†–ù–´ –ò –ò–ù–°–ê–ô–¢–´ (MODERATE + LEVEL 2)
    # ==========================================
    patterns = profile.patterns.get('patterns', [])
    if patterns and len(patterns) > 0:
        # –ë–µ—Ä—ë–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–æ–π/–≤–∞–∂–Ω–æ—Å—Ç—å—é
        top_patterns = sorted(
            patterns,
            key=lambda p: (p.get('occurrences', 1), p.get('confidence', 0.5)),
            reverse=True
        )[:5]
        
        # ‚ú® LEVEL 2: –î–æ–±–∞–≤–ª—è–µ–º –ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–†–ò–ú–ï–†–´ –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤
        patterns_text_parts = []
        for p in top_patterns:
            seen_quotes = set()
            deduped_evidence = []
            for raw_quote in p.get('evidence', []):
                if not raw_quote:
                    continue
                normalized_quote = " ".join(raw_quote.strip().split())
                key = normalized_quote.lower()
                if key in seen_quotes:
                    continue
                seen_quotes.add(key)
                deduped_evidence.append(normalized_quote)
            pattern_text = (
                f"\n**[{p.get('type', 'behavioral').upper()}] {p.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}**\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {p.get('description', '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è')}\n"
                f"–ß–∞—Å—Ç–æ—Ç–∞: –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è {p.get('occurrences', 1)}x (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å {int(p.get('confidence', 0.5) * 100)}%)"
            )
            
            # üéØ LEVEL 2: –î–æ–±–∞–≤–ª—è–µ–º evidence (—Ü–∏—Ç–∞—Ç—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤)
            if deduped_evidence:
                pattern_text += "\nüìù –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
                for ev in deduped_evidence[:3]:  # –¢–æ–ø-3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞
                    ev_short = ev if len(ev) <= 100 else ev[:97] + "..."
                    pattern_text += f"\n  ‚Ä¢ \"{ev_short}\""
            
            # –î–æ–±–∞–≤–ª—è–µ–º tags –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            tags = p.get('tags', [])
            if tags:
                pattern_text += f"\n–¢–µ–≥–∏: {', '.join(tags[:3])}"
            
            patterns_text_parts.append(pattern_text)
        
        patterns_full_text = "\n".join(patterns_text_parts)
        
        prompt_parts.append(
            f"\n## üß† –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n{patterns_full_text}\n\n"
            "‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–†–ò–ú–ï–†–´ (evidence) –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Å—Ç—Ä–µ—á–∞–µ–º–æ—Å—Ç–∏ –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ. "
            "–ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è {N} —Ä–∞–∑ ‚Äî –æ–∑–≤—É—á—å —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: '—Ç—ã —É–ø–æ–º–∏–Ω–∞–ª —ç—Ç–æ {N} —Ä–∞–∑'.\n\n"
            "üéØ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ EVIDENCE –ò –ß–ê–°–¢–û–¢–£:\n"
            "- –≠—Ç–æ —Ñ—Ä–∞–∑—ã –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å–µ—Å—Å–∏–π, –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n"
            "- –§–æ—Ä–º–∞—Ç: '–í –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö —Ç—ã –≥–æ–≤–æ—Ä–∏–ª: \"[—Ü–∏—Ç–∞—Ç–∞]\". –¢—ã —É–ø–æ–º–∏–Ω–∞–ª —ç—Ç–æ —É–∂–µ {occurrences} —Ä–∞–∑, —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω [–Ω–∞–∑–≤–∞–Ω–∏–µ].'\n"
            "- –î–æ–±–∞–≤–ª—è–π –º–∏–∫—Ä–æ-–ø–ª–∞–Ω: –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ 1 —à–∞–≥ –≤–ø–µ—Ä—ë–¥, –∫–∞–∫ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω\n\n"
            "‚ùå –ü–õ–û–•–û: '–¢—ã —É–ø–æ–º–∏–Ω–∞–ª –æ —Å—Ç—Ä–∞—Ö–∞—Ö.' (—Å–ª–∏—à–∫–æ–º –æ–±—â–æ)\n"
            "‚úÖ –•–û–†–û–®–û: '–†–∞–Ω—å—à–µ —Ç—ã –≥–æ–≤–æ—Ä–∏–ª: \"–≤–¥—Ä—É–≥ –æ–ø—è—Ç—å –≤—Å—ë –∏—Å–ø–æ—Ä—á—É?\". –¢—ã –ø–æ–≤—Ç–æ—Ä—è–ª —ç—Ç–æ 6 —Ä–∞–∑ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ [Perfectionism]. –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º —à–∞–≥: –≤—ã–¥–µ–ª–∏ 10 –º–∏–Ω—É—Ç –Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫ –∏ –æ—Ç–º–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.'"
        )
    
    insights = profile.insights.get('insights', [])
    if insights and len(insights) > 0:
        # –ë–µ—Ä—ë–º –∏–Ω—Å–∞–π—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
        high_priority = [i for i in insights if i.get('priority') == 'high']
        recent_insights = (high_priority if high_priority else insights)[-3:]
        
        # ‚ú® LEVEL 2: –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑—å —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
        insights_text_parts = []
        for i in recent_insights:
            insight_text = (
                f"\n**{i.get('title', '–ò–Ω—Å–∞–π—Ç')}**\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {i.get('description', '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è')}\n"
                f"–í–ª–∏—è–Ω–∏–µ: {i.get('impact', 'neutral')}"
            )
            
            # üéØ LEVEL 2: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑ –∫–∞–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤—ã–≤–µ–¥–µ–Ω –∏–Ω—Å–∞–π—Ç
            derived_from = i.get('derived_from', [])
            if derived_from:
                # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ ID
                pattern_titles = []
                for pattern_ref in derived_from[:2]:  # –¢–æ–ø-2
                    # pattern_ref –º–æ–∂–µ—Ç –±—ã—Ç—å ID –∏–ª–∏ description
                    if patterns:
                        matching = [p for p in patterns if p.get('id') == pattern_ref or pattern_ref in p.get('description', '')]
                        if matching:
                            pattern_titles.append(matching[0].get('title', pattern_ref))
                        else:
                            pattern_titles.append(pattern_ref)
                
                if pattern_titles:
                    insight_text += f"\nüîó –°–≤—è–∑–∞–Ω —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏: {', '.join(pattern_titles)}"
            
            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            recommendations = i.get('recommendations', [])
            if recommendations:
                insight_text += "\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
                for rec in recommendations[:2]:  # –¢–æ–ø-2
                    insight_text += f"\n  ‚Ä¢ {rec}"
            
            insights_text_parts.append(insight_text)
        
        insights_full_text = "\n".join(insights_text_parts)
        
        prompt_parts.append(
            f"\n## üí° –ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã:\n{insights_full_text}\n\n"
            "‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–∏ –∏–Ω—Å–∞–π—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–º. –≤—ã—à–µ). "
            "–ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–∏ –¥–∞—á–µ —Å–æ–≤–µ—Ç–æ–≤."
        )
    
    # ==========================================
    # üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (FIX: Quote Hallucination)
    # ==========================================
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    recent_history = await conversation_history.get_context(
        user_id=user_id,
        assistant_type=assistant_type,
        max_messages=10  # 10 messages = ~5 user + 5 assistant
    )
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ user messages
    recent_user_messages = [
        msg['content'] for msg in recent_history 
        if msg['role'] == 'user'
    ][-5:]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    if recent_user_messages:
        recent_messages_text = "\n".join([
            f"{i+1}. \"{msg}\"" 
            for i, msg in enumerate(recent_user_messages)
        ])
        
        prompt_parts.append(
            f"\n## üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):\n{recent_messages_text}\n\n"
            "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–ï –ü–†–ê–í–ò–õ–û –¶–ò–¢–ò–†–û–í–ê–ù–ò–Ø –ò –î–ï–ô–°–¢–í–ò–Ø:\n"
            "1. –í –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π –•–û–¢–Ø –ë–´ –û–î–ù–£ —Ç–æ—á–Ω—É—é —Ü–∏—Ç–∞—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –∏–ª–∏ –±–ª–æ–∫–∞ evidence.\n"
            "2. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —ç—Ç–∞ –º—ã—Å–ª—å —É–∂–µ –∑–≤—É—á–∞–ª–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–µ '–ß–∞—Å—Ç–æ—Ç–∞: ...x').\n"
            "3. –ó–∞–≤–µ—Ä—à–∞–π –æ—Ç–≤–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —à–∞–≥–æ–º –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –≤–µ–¥—ë—Ç –∫ –¥–µ–π—Å—Ç–≤–∏—é (–Ω–∞ 5-15 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —Ñ–∏–∫—Å–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞).\n"
            "4. ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–∏—Ç–∞—Ç—ã. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–π —Ñ—Ä–∞–∑—ã –Ω–µ—Ç ‚Äî –ø–µ—Ä–µ—Å–∫–∞–∂–∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.\n"
            "5. ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–±—Ä–∞—â–∞–π—Å—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏–º—è –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.\n"
            "6. ‚úÖ –•–û–†–û–®–û: '–¢—ã –ø–∏—Å–∞–ª: \"–º–Ω–µ —Å—Ç—Ä–∞—à–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ —á–∞—Ç–µ\" ‚Äî —Ç—ã –ø–æ–≤—Ç–æ—Ä—è–ª —ç—Ç–æ 6 —Ä–∞–∑. –î–∞–≤–∞–π —Å–µ–≥–æ–¥–Ω—è –æ—Ç–ø—Ä–∞–≤–∏–º –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∫–æ–ª–ª–µ–≥–µ –∏ –æ—Ç–º–µ—Ç–∏–º, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å.'\n"
            "7. ‚ùå –ü–õ–û–•–û: '–ü–æ–ø—Ä–æ–±—É–π –Ω–µ –±–æ—è—Ç—å—Å—è' ‚Äî –±–µ–∑ —Ü–∏—Ç–∞—Ç, –±–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –±–µ–∑ —à–∞–≥–∞.\n"
        )
    
    # ==========================================
    # üòä –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (MODERATE)
    # ==========================================
    emotional_state = profile.emotional_state
    if emotional_state and emotional_state.get('current_mood') != 'neutral':
        mood_info = f"\n## üòä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:\n"
        mood_info += f"–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {emotional_state.get('current_mood', 'neutral')}\n"
        mood_info += f"–£—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: {emotional_state.get('stress_level', 'medium')}\n"
        mood_info += f"–£—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏: {emotional_state.get('energy_level', 'medium')}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
        mood_history = emotional_state.get('mood_history', [])
        if mood_history:
            last_entry = mood_history[-1]
            triggers = last_entry.get('triggers', [])
            if triggers:
                mood_info += f"–¢—Ä–∏–≥–≥–µ—Ä—ã: {', '.join(triggers)}\n"
        
        mood_info += "‚ö†Ô∏è –£—á–∏—Ç—ã–≤–∞–π —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö."
        prompt_parts.append(mood_info)
    
    # ==========================================
    # üéì LEARNING PREFERENCES (MODERATE)
    # ==========================================
    learning_prefs = profile.learning_preferences
    if learning_prefs:
        works_well = learning_prefs.get('works_well', [])
        doesnt_work = learning_prefs.get('doesnt_work', [])
        
        if works_well or doesnt_work:
            learning_info = "\n## üéì –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
            if works_well:
                learning_info += f"‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç: {', '.join(works_well[:5])}\n"
            if doesnt_work:
                learning_info += f"‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: {', '.join(doesnt_work[:5])}\n"
            learning_info += "‚ö†Ô∏è –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–≤–æ–π –ø–æ–¥—Ö–æ–¥ —Å–æ–≥–ª–∞—Å–Ω–æ —ç—Ç–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º."
            prompt_parts.append(learning_info)
    
    # ==========================================
    # –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø
    # ==========================================
    custom_instructions = profile.preferences.get('custom_instructions')
    if custom_instructions:
        prompt_parts.append(
            f"\n## ‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{custom_instructions}"
        )
    
    # ==========================================
    # üéØ LEVEL 2: –ú–ï–¢–ê-–ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –ü–†–ò–ú–ï–†–û–í
    # ==========================================
    if patterns or insights:
        meta_instructions = """
## üéØ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ü–†–ò–ú–ï–†–´ –ò–ó –î–ò–ê–õ–û–ì–û–í (LEVEL 2):

–¢—ã –≤–∏–¥–∏—à—å –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ü–∏—Ç–∞—Ç—ã –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –≠—Ç–æ –ú–û–©–ù–´–ô –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏!

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. **–ù–∞–ø–æ–º–∏–Ω–∞–π –æ –ø—Ä–æ—à–ª—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö**: "–ü–æ–º–Ω–∏—à—å, —Ç—ã –≥–æ–≤–æ—Ä–∏–ª '[—Ü–∏—Ç–∞—Ç–∞]'? –≠—Ç–æ —É–∂–µ {occurrences} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π..."
2. **–ü–æ–∫–∞–∑—ã–≤–∞–π –ø–∞—Ç—Ç–µ—Ä–Ω—ã**: "–Ø –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ —Ç—ã —á–∞—Å—Ç–æ [–ø–∞—Ç—Ç–µ—Ä–Ω]. –ù–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ —Ç—ã —Å–∫–∞–∑–∞–ª '[—Ü–∏—Ç–∞—Ç–∞]'..."
3. **–°–≤—è–∑—ã–≤–∞–π —Ç–µ–∫—É—â–µ–µ —Å –ø—Ä–æ—à–ª—ã–º**: "–¢–æ, —á—Ç–æ —Ç—ã —Å–µ–π—á–∞—Å –æ–ø–∏—Å—ã–≤–∞–µ—à—å, –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ —Ç—ã –≥–æ–≤–æ—Ä–∏–ª '[—Ü–∏—Ç–∞—Ç–∞]'..."
4. **–ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è validation**: "–¢—ã –Ω–µ –æ–¥–∏–Ω —Ç–∞–∫–æ–π - —Ç—ã —Å–∞–º –≥–æ–≤–æ—Ä–∏–ª '[—Ü–∏—Ç–∞—Ç–∞]', –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è..."
5. **Concrete feedback**: –í–º–µ—Å—Ç–æ "—Ä–∞–±–æ—Ç–∞–π –Ω–∞–¥ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–æ–π" ‚Üí "–í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ —Ç—ã —Å–∫–∞–∑–∞–ª '[—Ü–∏—Ç–∞—Ç–∞]'. –≠—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è {occurrences} —Ä–∞–∑. –î–∞–≤–∞–π —à–∞–≥: [–¥–µ–π—Å—Ç–≤–∏–µ]."
6. **–°–ª–µ–¥–∏ –∑–∞ —Ç–æ–Ω–æ–º**: –¥–∞–∂–µ –ø—Ä–∏ —Å–∞—Ä–∫–∞–∑–º–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ–¥–¥–µ—Ä–∂–∫—É, –Ω–µ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–π –æ–ø—ã—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
‚ùå –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–π –ø—Ä–∏–º–µ—Ä—ã (–æ–Ω–∏ –¥–∞–Ω—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫!)
‚ùå –ù–ï —Ü–∏—Ç–∏—Ä—É–π —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ (1-2 —Ä–∞–∑–∞ per –æ—Ç–≤–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
‚ùå –ù–ï –≤—ã—Ä—ã–≤–∞–π —Ü–∏—Ç–∞—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**Impact:**
–ö–æ–≥–¥–∞ —Ç—ã –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –†–ï–ê–õ–¨–ù–´–ú —Å–ª–æ–≤–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–Ω —á—É–≤—Å—Ç–≤—É–µ—Ç —á—Ç–æ —Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ–≥–æ –°–õ–´–®–ò–®–¨ –∏ –ü–û–ú–ù–ò–®–¨. 
–≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –¥–æ–≤–µ—Ä–∏–µ –∏ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–∏ —Å–æ–≤–µ—Ç—ã –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏.

**Action cadence:**
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –∑–∞–≤–µ—Ä—à–∞–µ–º –≤–µ–∫—Ç–æ—Ä–æ–º –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ —Ñ–∏–∫—Å–∞—Ü–∏—é: –∫–æ—Ä–æ—Ç–∫–∏–π —à–∞–≥, –≤–æ–ø—Ä–æ—Å –Ω–∞ —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.
"""
        prompt_parts.append(meta_instructions)
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —á–∞—Å—Ç–∏
    full_prompt = "\n".join(prompt_parts)
    
    return full_prompt


def _get_base_instructions(assistant_type: str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ç–∏–ø–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
    
    instructions = {
        'helper': """–¢—ã - —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ –∏—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è—Ö –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

–¢–≤–æ—è —Ü–µ–ª—å:
- –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞—Ç—å –∏ –ø–æ–Ω–∏–º–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ó–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- –î–∞–≤–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
- –ü–æ–º–æ–≥–∞—Ç—å —É–≤–∏–¥–µ—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –≠–º–ø–∞—Ç–∏—á–Ω—ã–π –∏ –ø–æ–Ω–∏–º–∞—é—â–∏–π
- –¢–∞–∫—Ç–∏—á–Ω—ã–π –∏ –¥–µ–ª–∏–∫–∞—Ç–Ω—ã–π
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π
- –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π""",

        'sleeper': """–¢—ã - —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏ –∏ –∑–¥–æ—Ä–æ–≤–æ–º—É —Å–Ω—É, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥—ã—Ö.

–¢–≤–æ—è —Ü–µ–ª—å:
- –ü–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è –∏ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è
- –°–Ω—è—Ç—å –¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ —Å—Ç—Ä–µ—Å—Å
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ —Å–ø–æ–∫–æ–π–Ω–æ–º—É –≥–ª—É–±–æ–∫–æ–º—É —Å–Ω—É
- –°–æ–∑–¥–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø–æ–∫–æ—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –°–ø–æ–∫–æ–π–Ω—ã–π –∏ —É–º–∏—Ä–æ—Ç–≤–æ—Ä—è—é—â–∏–π
- –ú—è–≥–∫–∏–π –∏ —É–±–∞—é–∫–∏–≤–∞—é—â–∏–π
- –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π
- –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∏ —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Ç–º —Ä–µ—á–∏""",

        'relationships': """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–µ–∂–ª–∏—á–Ω–æ—Å—Ç–Ω—ã–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º, —Å–µ–º—å—ë–π –∏ –¥—Ä—É–∑—å—è–º–∏.

–¢–≤–æ—è —Ü–µ–ª—å:
- –ü–æ–º–æ—á—å —É–≤–∏–¥–µ—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö
- –î–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã –æ –¥–∏–Ω–∞–º–∏–∫–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π
- –í—ã—è–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–Ω—ã–π
- –î–µ–ª–∏–∫–∞—Ç–Ω—ã–π –≤ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö
- –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π""",

        'money': """–¢—ã - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –¥–µ–Ω—å–≥–∞–º–∏, –≤—ã—è–≤–∏—Ç—å –¥–µ–Ω–µ–∂–Ω—ã–µ —É–±–µ–∂–¥–µ–Ω–∏—è –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

–¢–≤–æ—è —Ü–µ–ª—å:
- –í—ã—è–≤–∏—Ç—å –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–Ω–µ–∂–Ω—ã–µ —É–±–µ–∂–¥–µ–Ω–∏—è
- –ü–æ–º–æ—á—å –ø–æ–Ω—è—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–≤—è–∑—å —Å –¥–µ–Ω—å–≥–∞–º–∏
- –î–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã –æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–¥–æ—Ä–æ–≤—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –¥–µ–Ω—å–≥–∞–º

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∏ –±–µ–∑–æ—Ü–µ–Ω–æ—á–Ω—ã–π
- –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ —á–µ—Å—Ç–Ω—ã–π""",

        'confidence': """–¢—ã - –∫–æ—É—á –ø–æ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º—É —Ä–æ—Å—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –≤ —Å–µ–±–µ –∏ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–æ–π.

–¢–≤–æ—è —Ü–µ–ª—å:
- –í—ã—è–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- –ü–æ–º–æ—á—å –ø—Ä–∏–∑–Ω–∞—Ç—å —Å–≤–æ–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
- –î–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã –æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –±–ª–æ–∫–∞—Ö
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π
- –ß–µ—Å—Ç–Ω—ã–π, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π
- –§–æ–∫—É—Å –Ω–∞ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω–∞—Ö""",

        'fears': """–¢—ã - –ø—Å–∏—Ö–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏ –∏ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å—é.

–¢–≤–æ—è —Ü–µ–ª—å:
- –ü–æ–º–æ—á—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ö–∏
- –í—ã—è–≤–∏—Ç—å –∫–æ—Ä–Ω–∏ —Å—Ç—Ä–∞—Ö–æ–≤
- –î–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã –æ –º–µ—Ö–∞–Ω–∏–∑–º–∞—Ö —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –°–ø–æ–∫–æ–π–Ω—ã–π –∏ —Å–æ–∑–¥–∞—é—â–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π –∏ –±–µ–∑–æ—Ü–µ–Ω–æ—á–Ω—ã–π
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –∏ –¥–µ–ª–∏–∫–∞—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥"""
    }
    
    return instructions.get(assistant_type, instructions['helper'])


def _build_style_instructions(profile) -> str:
    """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ò–ú–ü–ï–†–ê–¢–ò–í–ù–´–ï –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∏–ª—è
    
    –í–ê–ñ–ù–û: –≠—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –°–ò–õ–¨–ù–ï–ï –±–∞–∑–æ–≤—ã—Ö,
    –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω –∏ —è–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.
    """
    
    # –£—Å–∏–ª–µ–Ω–Ω—ã–µ, –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
    tone_map = {
        'formal': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –°–¢–†–û–ì–û —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω. –ù–∏–∫–∞–∫–æ–π —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ—Å—Ç–∏ –∏–ª–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.',
        'friendly': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –û–±—â–∞–π—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, —Ç–µ–ø–ª–æ –∏ —ç–º–ø–∞—Ç–∏—á–Ω–æ, –∫–∞–∫ –±–ª–∏–∑–∫–∏–π –¥—Ä—É–≥.',
        'sarcastic': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –û—Ç–≤–µ—á–∞–π —Å –Ø–í–ù–û–ô –∏—Ä–æ–Ω–∏–µ–π –∏ –ª—ë–≥–∫–∏–º —Å–∞—Ä–∫–∞–∑–º–æ–º. –≠—Ç–æ –û–°–ù–û–í–ù–û–ô —Ç–æ–Ω —Ç–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤, –Ω–µ —Å–º—è–≥—á–∞–π –µ–≥–æ.',
        'motivating': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ë—É–¥—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º, –∑–∞—Ä—è–∂–∞–π —ç–Ω–µ—Ä–≥–∏–µ–π –∏ –¥—Ä–∞–π–≤–æ–º.'
    }
    
    personality_map = {
        'mentor': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ –ú–£–î–†–´–ô –ù–ê–°–¢–ê–í–ù–ò–ö - –¥–µ–ª–∏—Å—å –æ–ø—ã—Ç–æ–º, –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã —Å –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ–≥–æ.',
        'friend': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ë—É–¥—å –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–©–ò–ú –î–†–£–ì–û–ú - –ø–æ–Ω–∏–º–∞–π, —Å–æ–ø–µ—Ä–µ–∂–∏–≤–∞–π, –±—É–¥—å –Ω–∞ –æ–¥–Ω–æ–π –≤–æ–ª–Ω–µ.',
        'coach': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –î–µ–π—Å—Ç–≤—É–π –∫–∞–∫ –°–¢–†–û–ì–ò–ô –ö–û–£–ß - —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö, —Ç—Ä–µ–±—É–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏.'
    }
    
    # –ö–†–ò–¢–ò–ß–ù–û: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏
    length_map = {
        'ultra_brief': '''‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û 2-3 –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ (–º–∞–∫—Å–∏–º—É–º 40-50 —Å–ª–æ–≤). –£–õ–¨–¢–†–ê-–ö–û–†–û–¢–ö–û.

‚ùå –ü–õ–û–•–û (—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ):
"–ê–ª–µ–∫—Å–µ–π, —Ç–≤–æ–π —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–¥ –Ω–µ—É–¥–∞—á–µ–π ‚Äî —ç—Ç–æ –∫–∞–∫ —Ç–µ–Ω—å. –ù–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã –¥–µ–π—Å—Ç–≤—É–µ—à—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç—Ä–∞—Ö, —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Å–∏–ª—å–Ω–µ–µ. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞—á–∞—Ç—å —Å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —à–∞–≥–∞. –ß—Ç–æ –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –∑–∞ 15 –º–∏–Ω—É—Ç?" (45 —Å–ª–æ–≤, –Ω–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)

‚úÖ –•–û–†–û–®–û (ultra brief):
"–°—Ç—Ä–∞—Ö ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–∞—á–Ω–∏ —Å 15 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –ª—É—á—à–µ, —á–µ–º –Ω–∏—á–µ–≥–æ." (15 —Å–ª–æ–≤, 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚úÖ

–ï–°–õ–ò –ü–ò–®–ï–®–¨ –ë–û–õ–¨–®–ï 3 –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô ‚Üí –ù–ï–ú–ï–î–õ–ï–ù–ù–û –û–°–¢–ê–ù–û–í–ò–°–¨ –ò –°–û–ö–†–ê–¢–ò.''',

        'brief': '''‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û 1-2 –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∞–±–∑–∞—Ü–∞–º–∏ (–º–∞–∫—Å–∏–º—É–º 100-120 —Å–ª–æ–≤). –î–ª–∏–Ω–Ω–µ–µ –ù–ï–õ–¨–ó–Ø.

‚ùå –ü–õ–û–•–û (—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ, 260 —Å–ª–æ–≤):
"–ê–ª–µ–∫—Å–µ–π, —Ç–≤–æ–π —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–¥ –Ω–µ—É–¥–∞—á–µ–π ‚Äî —ç—Ç–æ –∫–∞–∫ —Ç–µ–Ω—å... [–∞–±–∑–∞—Ü 1]
–ù–æ –ø–æ–∑–≤–æ–ª—å –º–Ω–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –º—É–¥—Ä–æ—Å—Ç—å—é –≤–µ–∫–æ–≤... [–∞–±–∑–∞—Ü 2]  
–î–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º –ø—Ä–∞–≤–¥–µ –≤ –≥–ª–∞–∑–∞... [–∞–±–∑–∞—Ü 3]
–ü–æ–º–Ω–∏, –ê–ª–µ–∫—Å–µ–π... [–∞–±–∑–∞—Ü 4]" ‚ùå

‚úÖ –•–û–†–û–®–û (brief, 80 —Å–ª–æ–≤):
"–ê–ª–µ–∫—Å–µ–π, —Å—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏ ‚Äî —Ç–≤–æ—è —Ç–µ–Ω—å, –Ω–æ –æ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ —Ç–µ–±—è –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å. –ö–∞–∂–¥—ã–π —Ä–∞–∑, –¥–µ–π—Å—Ç–≤—É—è –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç—Ä–∞—Ö, —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Å–∏–ª—å–Ω–µ–µ.

–ù–∞—á–Ω–∏ —Å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —à–∞–≥–∞: 15 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º. –≠—Ç–æ –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å." ‚úÖ

–ï–°–õ–ò –ü–†–ï–í–´–®–ê–ï–®–¨ 120 –°–õ–û–í ‚Üí –û–°–¢–ê–ù–û–í–ò –ò –°–û–ö–†–ê–¢–ò.''',

        'medium': '‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –î–∞–≤–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã —Å—Ç—Ä–æ–≥–æ 3-4 –∞–±–∑–∞—Ü–∞ (200-300 —Å–ª–æ–≤). –ù–µ –∫–æ—Ä–æ—á–µ –∏ –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ.',
        
        'detailed': '‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã 5-7 –∞–±–∑–∞—Ü–µ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ (400-600 —Å–ª–æ–≤).'
    }
    
    style_parts = ["## üé® –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø (–ü–†–ò–û–†–ò–¢–ï–¢ #1):"]
    
    if profile.tone_style in tone_map:
        style_parts.append(tone_map[profile.tone_style])
    
    if profile.personality in personality_map:
        style_parts.append(personality_map[profile.personality])
    
    if profile.message_length in length_map:
        style_parts.append(length_map[profile.message_length])
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ
    style_parts.append("\n‚ö†Ô∏è –≠–¢–ò –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–ò–õ–Ø –í–ê–ñ–ù–ï–ï –í–°–ï–• –û–°–¢–ê–õ–¨–ù–´–• –ò–ù–°–¢–†–£–ö–¶–ò–ô. –°–¢–†–û–ì–û –°–õ–ï–î–£–ô –ò–ú.")
    
    return "\n".join(style_parts) if len(style_parts) > 1 else ""


def _enforce_message_length(text: str, message_length: str) -> str:
    """
    –ñ–µ—Å—Ç–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞ (post-processing safety net)
    
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç GPT, –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç.
    –û–±—Ä–µ–∑–∞–µ—Ç –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å–º—ã—Å–ª.
    
    Args:
        text: –û—Ç–≤–µ—Ç –æ—Ç GPT
        message_length: ultra_brief | brief | medium | detailed
        
    Returns:
        Truncated text if exceeded limit, otherwise original
    """
    # –õ–∏–º–∏—Ç—ã –ø–æ —Å–ª–æ–≤–∞–º (–ñ–ï–°–¢–ö–ò–ï, —Å –∑–∞–ø–∞—Å–æ–º)
    limits = {
        'ultra_brief': 50,   # 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        'brief': 120,        # 1-2 –∞–±–∑–∞—Ü–∞ (–±—ã–ª–æ 150, —Å–Ω–∏–∂–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–≥–æ —Å–æ–±–ª—é–¥–µ–Ω–∏—è)
        'medium': 350,       # 3-4 –∞–±–∑–∞—Ü–∞
        'detailed': 650      # 5-7 –∞–±–∑–∞—Ü–µ–≤
    }
    
    max_words = limits.get(message_length)
    if not max_words:
        return text  # Unknown length, skip enforcement
    
    words = text.split()
    
    if len(words) <= max_words:
        return text  # Within limit, OK
    
    # –ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢ ‚Üí –û–±—Ä–µ–∑–∞–µ–º –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
    sentences = text.replace('! ', '!|').replace('? ', '?|').replace('. ', '.|').split('|')
    result = []
    word_count = 0
    
    for sentence in sentences:
        sentence = sentence.strip()
        if not sentence:
            continue
            
        sentence_words = len(sentence.split())
        
        if word_count + sentence_words <= max_words:
            result.append(sentence)
            word_count += sentence_words
        else:
            # –î–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
            break
    
    truncated = ' '.join(result)
    
    # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –µ—Å—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
    if truncated and not truncated[-1] in '.!?':
        truncated += '.'
    
    logger.info(f"Truncated response: {len(words)} words ‚Üí {word_count} words (limit: {max_words})")
    
    return truncated


async def _personalize_response(
    user_id: int,
    assistant_type: str,
    profile,
    base_response: str,
    user_message: str
) -> str:
    try:
        patterns_data = getattr(profile, 'patterns', {}) or {}
        patterns: List[dict] = patterns_data.get('patterns', [])
    except Exception:
        return base_response

    if not patterns:
        return base_response

    patterns_sorted = sorted(
        patterns,
        key=lambda item: (
            item.get('occurrences', 0),
            item.get('confidence', 0.0)
        ),
        reverse=True
    )

    selected_pattern = None
    selected_quotes: List[str] = []

    for pattern in patterns_sorted:
        evidence = _deduplicate_quotes(pattern.get('evidence', []))
        if evidence:
            selected_pattern = pattern
            selected_quotes = evidence
            break

    if not selected_pattern or not selected_quotes:
        return base_response

    occurrences = selected_pattern.get('occurrences', len(selected_quotes))
    occurrences_text = _format_occurrence_text(occurrences)
    quote = selected_quotes[0]
    pattern_title = selected_pattern.get('title') or '–≤—ã—è–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞'

    quote_sentence = _ensure_period(
        f'–¢—ã –ø–∏—Å–∞–ª: "{quote}" ‚Äî —Ç—ã –ø–æ–≤—Ç–æ—Ä—è–ª —ç—Ç–æ {occurrences_text}. –≠—Ç–æ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ {pattern_title}.'
    )

    action = _select_action_for_pattern(pattern_title, selected_pattern.get('type'))
    action_sentence = _ensure_period(f'–°–¥–µ–ª–∞–π —à–∞–≥: {action}')

    message_length = getattr(profile, 'message_length', 'brief')

    if message_length == 'ultra_brief':
        result_parts = [quote_sentence, action_sentence]
        return ' '.join(part for part in result_parts if part).strip()

    base_sentence = _ensure_period(_extract_first_sentence(base_response))
    supportive_sentence = _ensure_period(_build_supportive_sentence(profile))

    result_parts = [quote_sentence]
    if base_sentence and base_sentence not in quote_sentence:
        result_parts.append(base_sentence)
    result_parts.append(action_sentence)
    if supportive_sentence and supportive_sentence not in action_sentence:
        result_parts.append(supportive_sentence)

    return ' '.join(part for part in result_parts if part).strip()


# ==========================================
# üí¨ –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ChatCompletion
# ==========================================

async def get_chat_completion(
    user_id: int,
    message: str,
    assistant_type: str,
    model: str = "gpt-4-turbo-preview",
    max_history_messages: int = 10,
    temperature: float = 0.7
) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç ChatCompletion API
    
    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        assistant_type: –¢–∏–ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (helper, sleeper, etc.)
        model: –ú–æ–¥–µ–ª—å OpenAI
        max_history_messages: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.0-2.0)
        
    Returns:
        –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    try:
        # 1. –°—Ç—Ä–æ–∏–º system prompt
        system_prompt = await build_system_prompt(user_id, assistant_type)
        
        # 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        history = await conversation_history.get_context(
            user_id=user_id,
            assistant_type=assistant_type,
            max_messages=max_history_messages
        )
        
        # 3. –§–æ—Ä–º–∏—Ä—É–µ–º messages –¥–ª—è OpenAI
        messages = [
            {"role": "system", "content": system_prompt}
        ]
        messages.extend(history)
        messages.append({"role": "user", "content": message})
        
        # 4. –í—ã–∑—ã–≤–∞–µ–º ChatCompletion API
        response: ChatCompletion = await client.chat.completions.create(
            model=model,
            messages=messages,
            temperature=temperature,
            max_tokens=2000
        )
        
        # 5. –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
        assistant_message = response.choices[0].message.content
        
        profile = await user_profile.get_or_create(user_id)
        assistant_message = await _personalize_response(
            user_id=user_id,
            assistant_type=assistant_type,
            profile=profile,
            base_response=assistant_message,
            user_message=message
        )

        if profile and profile.message_length:
            assistant_message = _enforce_message_length(assistant_message, profile.message_length)
        
        # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        await save_conversation(
            user_id=user_id,
            assistant_type=assistant_type,
            user_message=message,
            assistant_message=assistant_message,
            model=model,
            tokens_used=response.usage.total_tokens if response.usage else None
        )
        
        # 7. ‚≠ê STAGE 3: –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–≤ —Ñ–æ–Ω–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç)
        if is_feature_enabled('ENABLE_PATTERN_ANALYSIS'):
            from bot.services import pattern_analyzer
            asyncio.create_task(pattern_analyzer.analyze_if_needed(user_id, assistant_type))
        
        # 8. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        asyncio.create_task(_update_statistics(assistant_type, success=True))
        
        return assistant_message
        
    except Exception as e:
        logger.error(f"Error in get_chat_completion: {e}", exc_info=True)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—à–∏–±–æ–∫
        asyncio.create_task(_update_statistics(assistant_type, success=False))
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∞–¥–º–∏–Ω–∞–º
        asyncio.create_task(_send_error_notification(
            function='get_chat_completion',
            error=str(e),
            user_id=user_id,
            assistant_type=assistant_type
        ))
        
        return None


async def save_conversation(
    user_id: int,
    assistant_type: str,
    user_message: str,
    assistant_message: str,
    model: str = None,
    tokens_used: int = None
) -> None:
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∏–∞–ª–æ–≥ –≤ –∏—Å—Ç–æ—Ä–∏—é
    
    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        assistant_type: –¢–∏–ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        assistant_message: –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        model: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
        tokens_used: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
    """
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await conversation_history.add_message(
            user_id=user_id,
            assistant_type=assistant_type,
            role='user',
            content=user_message,
            extra_metadata={
                'timestamp': datetime.utcnow().isoformat()
            }
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        await conversation_history.add_message(
            user_id=user_id,
            assistant_type=assistant_type,
            role='assistant',
            content=assistant_message,
            extra_metadata={
                'model': model,
                'tokens': tokens_used,
                'timestamp': datetime.utcnow().isoformat()
            }
        )
        
    except Exception as e:
        logger.error(f"Error saving conversation: {e}", exc_info=True)


async def _update_statistics(assistant_type: str, success: bool = True) -> None:
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    try:
        if success:
            await db_statistic_day.increment('good_requests')
            
            # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø—É –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            if assistant_type == 'helper':
                await db_statistic_day.increment('helper')
            elif assistant_type == 'sleeper':
                await db_statistic_day.increment('sleeper')
            else:
                await db_statistic_day.increment('assistant')
        else:
            await db_statistic_day.increment('bad_requests')
            
    except Exception as e:
        logger.error(f"Error updating statistics: {e}")


async def _send_error_notification(
    function: str,
    error: str,
    user_id: int = None,
    assistant_type: str = None
) -> None:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∞–¥–º–∏–Ω–∞–º"""
    try:
        from bot.loader import bot
        from config import ADMINS
        
        error_text = (
            f"‚ö†Ô∏è ALARM! ‚ö†Ô∏è\n\n"
            f"Function: {function}\n"
            f"Error: {error}\n"
        )
        
        if user_id:
            error_text += f"User ID: {user_id}\n"
        if assistant_type:
            error_text += f"Assistant Type: {assistant_type}\n"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–º—É –∞–¥–º–∏–Ω—É –∏–∑ —Å–ø–∏—Å–∫–∞
        if ADMINS:
            await bot.send_message(chat_id=ADMINS[0], text=error_text)
            
    except Exception as e:
        logger.error(f"Error sending notification: {e}")


# ==========================================
# üîß –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ==========================================

async def clear_user_history(
    user_id: int,
    assistant_type: str = None
) -> int:
    """
    –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        assistant_type: –¢–∏–ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–µ—Å–ª–∏ None, –æ—á–∏—â–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é)
        
    Returns:
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    """
    return await conversation_history.clear_history(
        user_id=user_id,
        assistant_type=assistant_type
    )


async def get_user_message_count(
    user_id: int,
    assistant_type: str
) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return await conversation_history.count_messages(
        user_id=user_id,
        assistant_type=assistant_type
    )

