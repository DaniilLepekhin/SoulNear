# üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Soul Bot

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã**

#### Unit —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
```bash
./run_tests.sh unit
```
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ú–æ–∫–∞—é—Ç –ë–î –∏ –≤–Ω–µ—à–Ω–∏–µ API
- –î–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å < 5 —Å–µ–∫—É–Ω–¥
- **–ó–∞–ø—É—Å–∫–∞—Ç—å:** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏

#### Integration —Ç–µ—Å—Ç—ã (—Å–æ –≤–Ω–µ—à–Ω–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
```bash
./run_tests.sh integration
```
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
- –ú–æ–≥—É—Ç –º–æ–∫–∞—Ç—å OpenAI API
- **–ó–∞–ø—É—Å–∫–∞—Ç—å:** –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è feature

#### Smoke —Ç–µ—Å—Ç—ã (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏)
```bash
./run_tests.sh smoke
```
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–∂–Ω–µ–π—à–∏—Ö —Ñ–ª–æ—É
- **–ó–∞–ø—É—Å–∫–∞—Ç—å:** –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∫–æ–º–º–∏—Ç–æ–º –∏ –¥–µ–ø–ª–æ–µ–º

### 2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –±–æ—Ç—ã**

#### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤ `soul_test_bot`
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1 - —Ç–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç
cd soul_test_bot
python bot.py

# –¢–µ—Ä–º–∏–Ω–∞–ª 2 - –ø—Ä–æ–¥–∞–∫—à–Ω –±–æ—Ç (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
cd soul_bot
python bot.py
```

**Workflow:**
1. –ü–∏—à–µ–º –∫–æ–¥ –≤ `soul_test_bot/`
2. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä—É–∫–∞–º–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —é–∑–µ—Ä–∞–º–∏ (–Ω–µ–±–æ–ª—å—à–∞—è –≥—Ä—É–ø–ø–∞)
3. –ü—Ä–æ–≥–æ–Ω—è–µ–º –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã
4. –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí –º–µ—Ä–¥–∂–∏–º –≤ `soul_bot/`

### 3. **Feature Flags**

```python
# config.py
USE_CHAT_COMPLETION = os.getenv('USE_CHAT_COMPLETION', 'false') == 'true'

# –í–∫–ª—é—á–∏—Ç—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞
TEST_USERS = [946195257, 580613548]  # —Ç–≤–æ–π ID

# –í –∫–æ–¥–µ
if USE_CHAT_COMPLETION or user_id in TEST_USERS:
    # –Ω–æ–≤—ã–π –∫–æ–¥
else:
    # —Å—Ç–∞—Ä—ã–π –∫–æ–¥
```

**–ü—Ä–æ—Ñ–∏—Ç:**
- –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–¥–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –õ–µ–≥–∫–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —é–∑–µ—Ä–æ–≤

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

```bash
# 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
./run_tests.sh quick

# 2. –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ ‚Äî –∫–æ–º–º–∏—Ç–∏–º
git add .
git commit -m "feat: –¥–æ–±–∞–≤–∏–ª —Ñ—É–Ω–∫—Ü–∏—é X"

# 3. –ü–µ—Ä–µ–¥ push ‚Äî –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω
./run_tests.sh

# 4. Push
git push
```

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

```bash
# 1. Smoke —Ç–µ—Å—Ç—ã
./run_tests.sh smoke

# 2. –í—Å–µ —Ç–µ—Å—Ç—ã
./run_tests.sh

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å coverage (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 70%)
./run_tests.sh coverage

# 4. –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ soul_test_bot
# - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
# - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ
# - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
# - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–≤–∏–∑
# - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å /settings

# 5. –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí –¥–µ–ø–ª–æ–π
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
import logging
logger = logging.getLogger(__name__)

logger.info(f"User {user_id} started conversation")
logger.error(f"Failed to get response: {error}")
```

### –ê–ª–µ—Ä—Ç—ã –≤ Telegram (—É–∂–µ –µ—Å—Ç—å)
```python
# bot/functions/other.py:send_error()
await bot.send_message(
    chat_id=73744901,  # —Ç–≤–æ–π ID
    text=f'‚ö†Ô∏èALARM!‚ö†Ô∏è\n{function}\n{error}'
)
```

### –ú–µ—Ç—Ä–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –°—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `statistic_day`

---

## –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ —Å–Ω–∞

### –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
```bash
./run_tests.sh quick  # 10-20 —Å–µ–∫
```

### –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º:
```bash
./run_tests.sh  # 30-60 —Å–µ–∫
```

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:
```bash
./run_tests.sh smoke  # –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏
# + –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ test_bot (5 –º–∏–Ω—É—Ç)
```

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –∞–ª–µ—Ä—Ç–∞–º–∏ –≤ Telegram (1 —á–∞—Å)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `tail -f log.txt`
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ ‚Üí –æ—Ç–∫–∞—Ç–∏—Ç—å feature flag

---

## –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ

### ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—É—Ç–∏:
1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —é–∑–µ—Ä–∞**
2. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞**
3. **–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –≥–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç**
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏**
5. **–ö–≤–∏–∑: —Å—Ç–∞—Ä—Ç ‚Üí –≤–æ–ø—Ä–æ—Å—ã ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**
6. **–û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:
1. **–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Ä—è–µ—Ç—Å—è** ‚Üí —Ç–µ—Å—Ç –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫—É
2. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è** ‚Üí —Ç–µ—Å—Ç multi-turn conversation
3. **–ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è** ‚Üí —Ç–µ—Å—Ç update_user_patterns
4. **–ü—Ä–æ–º–ø—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π** ‚Üí —Ç–µ—Å—Ç token limits
5. **–û—à–∏–±–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ JSON** ‚Üí —Ç–µ—Å—Ç JSONB –ø–æ–ª–µ–π

---

## CI/CD (GitHub Actions)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏:
- Push –≤ `main`, `dev`, `feature/*`
- Pull Request

–ü—Ä–æ–≥–æ–Ω—è–µ—Ç:
1. Smoke —Ç–µ—Å—Ç—ã (–µ—Å–ª–∏ —É–ø–∞–¥—É—Ç ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç PR)
2. Unit —Ç–µ—Å—Ç—ã
3. Integration —Ç–µ—Å—Ç—ã
4. Coverage report

**–§–∞–π–ª:** `.github/workflows/tests.yml`

---

## TL;DR

**–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:**
1. –ü–∏—à–∏ –∫–æ–¥ –≤ `soul_test_bot/`
2. `./run_tests.sh quick` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –¢–µ—Å—Ç–∏—Ä—É–π —Ä—É–∫–∞–º–∏ –≤ test –±–æ—Ç–µ
4. –ï—Å–ª–∏ –û–ö ‚Üí –º–µ—Ä–¥–∂–∏ –≤ `soul_bot/`

**–î–µ–ø–ª–æ–π:**
1. `./run_tests.sh smoke`
2. –í–∫–ª—é—á–∏ feature flag –¥–ª—è —Å–µ–±—è
3. –ü–æ—Ç–µ—Å—Ç–∏ –Ω–∞ –ø—Ä–æ–¥–µ
4. –í–∫–ª—é—á–∏ –¥–ª—è –≤—Å–µ—Ö
5. –°–ª–µ–¥–∏ –∑–∞ –∞–ª–µ—Ä—Ç–∞–º–∏ 1 —á–∞—Å

**–û—Ç–∫–∞—Ç:**
```bash
# –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å
export USE_CHAT_COMPLETION=false
# –∏–ª–∏
git revert HEAD
```

–°–ø–æ–∫–æ–π–Ω–æ–≥–æ —Å–Ω–∞! üò¥

