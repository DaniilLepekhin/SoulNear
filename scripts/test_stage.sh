#!/bin/bash
# 🧪 Скрипт для тестирования этапа разработки
# 
# Использование:
#   ./scripts/test_stage.sh [stage_number]
#
# Пример:
#   ./scripts/test_stage.sh 1  # Тестирование Этапа 1

set -e  # Останавливаемся при ошибке

STAGE=${1:-"current"}
echo "════════════════════════════════════════════════════════════"
echo "🧪 ТЕСТИРОВАНИЕ ЭТАПА ${STAGE}"
echo "════════════════════════════════════════════════════════════"

cd "$(dirname "$0")/.."

# 1. Запускаем smoke тесты
echo ""
echo "📋 ШАГ 1: Smoke тесты (автоматические)"
echo "────────────────────────────────────────────────────────────"
cd soul_bot
python tests/smoke_tests.py

if [ $? -ne 0 ]; then
    echo ""
    echo "❌ SMOKE ТЕСТЫ ПРОВАЛИЛИСЬ!"
    echo "Исправь ошибки перед продолжением."
    exit 1
fi

echo ""
echo "✅ Smoke тесты пройдены!"

# 2. Показываем regression checklist
echo ""
echo "────────────────────────────────────────────────────────────"
echo "📋 ШАГ 2: Ручное тестирование"
echo "────────────────────────────────────────────────────────────"
echo ""
echo "Теперь нужно ВРУЧНУЮ пройти regression checklist:"
echo "👉 Открой: soul_bot/REGRESSION_CHECKLIST.md"
echo ""
echo "Запусти TEST бота в отдельном терминале:"
echo "   cd soul_bot && ENV=test python bot.py"
echo ""
echo "Пройди по чеклисту и отметь все пункты ✅"
echo ""

# 3. Показываем feature flags
echo "────────────────────────────────────────────────────────────"
echo "🚩 ШАГ 3: Проверка Feature Flags"
echo "────────────────────────────────────────────────────────────"
cd soul_bot
python config.py

# 4. Итоговые инструкции
echo ""
echo "════════════════════════════════════════════════════════════"
echo "🎯 СЛЕДУЮЩИЕ ШАГИ:"
echo "════════════════════════════════════════════════════════════"
echo ""
echo "1. ✅ Автоматические тесты пройдены"
echo "2. ⏳ Пройди ручной regression checklist"
echo "3. ⏳ Сравни качество ответов TEST vs PROD"
echo "4. ⏳ Проверь логи на наличие ошибок"
echo ""
echo "Если всё ОК → можно делать rollout на PROD!"
echo "Инструкция: TESTING_STRATEGY.md → Rollout процесс"
echo ""
echo "════════════════════════════════════════════════════════════"

