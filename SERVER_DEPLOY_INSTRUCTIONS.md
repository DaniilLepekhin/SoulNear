# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä

## üì¶ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∞:
- ‚úÖ –£–±—Ä–∞–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ `${VAR}` –∏–∑ docker-compose.yml
- ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å –≥—Ä—É–∑—è—Ç—Å—è –∏–∑ `.env.prod`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ `'ContainerConfig'`
- ‚úÖ –°–æ–∑–¥–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Ä–µ–¥–µ–ø–ª–æ—è (–ë–ï–ó –ø–æ—Ç–µ—Ä–∏ –ë–î)

## üéØ –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–µ–ø–ª–æ–µ–º

### 1. –£–±–µ–¥–∏—Å—å —á—Ç–æ `.env.prod` –Ω–∞ –º–µ—Å—Ç–µ
```bash
ls -la .env.prod
```

–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞** (—Ä—è–¥–æ–º —Å docker-compose.yml), –ù–ï –≤–Ω—É—Ç—Ä–∏ `soul_bot/`.

### 2. –ó–∞–ø–æ–ª–Ω–∏ placeholder'—ã –≤ `.env.prod`

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª –∏ –∑–∞–º–µ–Ω–∏ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ:
```bash
nano .env.prod
```

**–ù—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å:**
- `HELPER_ID=your_helper_assistant_id_here` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
- `RELATIONSHIPS_ID=your_relationships_assistant_id_here` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π ID
- `SECRET_KEY=your_yookassa_secret_key_here` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á Yookassa

**–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ù–ï –ø—É—Å—Ç–æ:**
- `BOT_TOKEN`
- `OPENAI_API_KEY`
- `POSTGRES_PASSWORD` (–¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –æ–¥–∏–Ω –ø—Ä–æ–±–µ–ª " ")

### 3. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```bash
./validate-env.sh
```

–ï—Å–ª–∏ –≤—Å—ë –û–ö, —É–≤–∏–¥–∏—à—å:
```
‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!
üöÄ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å: make up
```

## üîÑ –î–µ–ø–ª–æ–π (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –±—ã–ª–∏)
docker-compose down

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (—Ñ–∏–∫—Å ContainerConfig)
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π
make rebuild

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
make logs-bot
```

## üîÑ –î–µ–ø–ª–æ–π (–ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑—ã)

### –í–∞—Ä–∏–∞–Ω—Ç –ê ‚Äî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
./scripts/safe_redeploy.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–¥–µ–ª–∞–µ—Ç `git pull`
2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
3. –ü–æ—á–∏—Å—Ç–∏—Ç —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
4. –ü–µ—Ä–µ—Å–æ–±–µ—Ä—ë—Ç –∏ –∑–∞–ø—É—Å—Ç–∏—Ç
5. –ü–æ–∫–∞–∂–µ—Ç –ª–æ–≥–∏

### –í–∞—Ä–∏–∞–Ω—Ç –ë ‚Äî –†—É—á–Ω–æ–π
```bash
docker-compose down && \
git pull && \
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true && \
make rebuild && \
make logs-bot
```

## ‚ùå –ù–ï –¥–µ–ª–∞–π —Ç–∞–∫

```bash
# ‚ùå –≠—Ç–æ —É–¥–∞–ª–∏—Ç –ë–î!
make redeploy

# ‚ùå –ù–µ –Ω—É–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ shell
export OPENAI_API_KEY=sk-...

# ‚ùå –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π --env-file –≤—Ä—É—á–Ω—É—é (—É–∂–µ –≤ docker-compose.yml)
docker-compose --env-file .env.prod up -d
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
docker-compose ps
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ 3 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: postgres (healthy), bot (up), api (up)

### 2. –õ–æ–≥–∏ –±–µ–∑ –æ—à–∏–±–æ–∫
```bash
make logs-bot
```

–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- ‚ùå `KeyError: 'OPENAI_API_KEY'`
- ‚ùå `ConnectionRefusedError`
- ‚ùå `WARNING: The ... variable is not set`

### 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
```bash
docker exec soulnear_bot env | grep -E "BOT_TOKEN|OPENAI_API_KEY|POSTGRES"
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏.

### 4. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –≤ Telegram
–ó–∞–π–¥–∏ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å `/start`

## üõ†Ô∏è –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: WARNING about missing variables
**–ü—Ä–∏—á–∏–Ω–∞:** Docker Compose –ø—ã—Ç–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å `${VAR}` –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ö–æ—Å—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –Ω–æ–≤–æ–º docker-compose.yml. –°–¥–µ–ª–∞–π `git pull` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏.

### –ü—Ä–æ–±–ª–µ–º–∞: KeyError: 'ContainerConfig'
**–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π metadata –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker-compose down
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true
docker-compose up -d --build
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –≤–∏–¥–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.prod
**–ü—Ä–∏—á–∏–Ω–∞:** –§–∞–π–ª `.env.prod` –Ω–µ –Ω–∞ –º–µ—Å—Ç–µ –∏–ª–∏ –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ñ–∞–π–ª –Ω–∞ –º–µ—Å—Ç–µ
ls -la .env.prod

# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ env_file —É–∫–∞–∑–∞–Ω –≤ docker-compose.yml
grep -A5 "bot:" docker-compose.yml | grep "env_file"

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# env_file:
#   - .env.prod
```

## üìä –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
make ps           # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
make logs-bot     # –õ–æ–≥–∏ –±–æ—Ç–∞
make logs-api     # –õ–æ–≥–∏ API
make logs-db      # –õ–æ–≥–∏ PostgreSQL
make stats        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
docker-compose ps # –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
```

## üíæ –ë—ç–∫–∞–ø –ë–î

**–ü–µ—Ä–µ–¥ –±–æ–ª—å—à–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:**
```bash
make backup
```

–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `backups/backup_YYYYMMDD_HHMMSS.sql`

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:**
```bash
make restore
```

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—è—Ç—Å—è –∏–∑ `.env.prod`, –Ω–∏–∫–∞–∫–∏—Ö warning'–æ–≤, –ë–î –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–µ–ø–ª–æ–µ.

**–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã:** `.env.prod` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.

---

**–í–æ–ø—Ä–æ—Å—ã?** –°–º–æ—Ç—Ä–∏ `DEPLOY_FIX.md` –∏–ª–∏ `ENV_VARS_FIX_SUMMARY.md`

