# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Feature Flags

–í—Å–µ –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∑–∞ feature flags –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:

```bash
# .env.test
USE_CHAT_COMPLETION=true
ENABLE_STYLE_SETTINGS=true
ENABLE_PATTERN_ANALYSIS=true
ENABLE_ADAPTIVE_QUIZ=true

# .env.prod (–≤–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
USE_CHAT_COMPLETION=true
ENABLE_STYLE_SETTINGS=true
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ test –±–æ—Ç–µ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ prod
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### –î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –±–æ—Ç–∞

**–ó–∞–ø—É—Å–∫:**
```bash
# Terminal 1 - PROD
ENV=prod python bot.py

# Terminal 2 - TEST
ENV=test python bot.py
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å—Ç—Ä–∞–¥–∞—é—Ç –æ—Ç –±–∞–≥–æ–≤
- –°–ø–æ–∫–æ–π–Ω–æ–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### Regression Test Checklist

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞:

**–ë–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- [ ] `/start` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é
- [ ] `/helper` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
- [ ] `/soulsleep` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
- [ ] –ö–≤–∏–∑—ã (4 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) ‚Äî –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `/menu` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**–ù–æ–≤—ã–µ —Ñ–∏—á–∏:**
- [ ] Style settings —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] `/my_profile` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
- [ ] Pattern analysis —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- [ ] Adaptive quiz –≤–µ—Ç–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ Q5

#### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–≥–æ–Ω —Ä–∞–∑ –≤ —Ä–µ–ª–∏–∑

- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ—Ñ–∏–ª—å**
  - `/start` –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
  - –í—ã–±–æ—Ä –ø–æ–ª–∞ –∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ë–î (`SELECT gender, age FROM users ORDER BY created_at DESC LIMIT 1;`).
  - –ö–æ–º–∞–Ω–¥–∞ `/profile` –≤—ã–≤–æ–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –±–µ–∑ –æ—à–∏–±–æ–∫.
- **–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã**
  - `/helper` –∏ `/soulsleep` –æ—Ç–≤–µ—á–∞—é—Ç –¥–≤–∞–∂–¥—ã –ø–æ–¥—Ä—è–¥ –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–æ–≤, —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 5 —Å.
  - –û—Ç–≤–µ—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–ö–≤–∏–∑—ã**
  - –ö–≤–∏–∑—ã ¬´–û—Ç–Ω–æ—à–µ–Ω–∏—è¬ª, ¬´–î–µ–Ω—å–≥–∏¬ª, ¬´–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å¬ª, ¬´–°—Ç—Ä–∞—Ö–∏¬ª –ø—Ä–æ—Ö–æ–¥—è—Ç –¥–æ —Ñ–∏–Ω–∞–ª–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
- **–û–ø–ª–∞—Ç–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∞**
  - –ö–Ω–æ–ø–∫–∞ ¬´–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç YooKassa –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–º–µ–Ω—É.
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è**
  - –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –Ω–µ –æ—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM –ø–æ–¥–≤–µ—à–µ–Ω–Ω—ã–º.
- **–õ–æ–≥–∏ –∏ –ë–î**
  - `make logs-bot | grep -Ei 'ERROR|CRITICAL'` –ø—É—Å—Ç–æ–π.
  - `SELECT date, COUNT(*) FROM statistic_day GROUP BY date HAVING COUNT(*) > 1;` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

---

### Smoke Tests

**–ó–∞–ø—É—Å–∫:**
```bash
cd soul_bot
pytest tests/smoke_tests.py -v
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç:**
- –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞
- OpenAI API –¥–æ—Å—Ç—É–ø–µ–Ω
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ handlers —Ä–∞–±–æ—Ç–∞—é—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π workflow

- **Unit —Ç–µ—Å—Ç—ã**
  ```bash
  ./run_tests.sh unit
  ```
  –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å < 5 —Å–µ–∫.
- **Integration —Ç–µ—Å—Ç—ã**
  ```bash
  ./run_tests.sh integration
  ```
  –ü—Ä–æ–≤–µ—Ä—è—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏ –º–æ–∫–∞–º–∏ OpenAI.
- **Smoke / quick –ø–∞–∫–µ—Ç—ã**
  ```bash
  ./run_tests.sh quick   # unit + smoke, ~20 —Å–µ–∫
  ./run_tests.sh         # –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω –ø–µ—Ä–µ–¥ push
  ./run_tests.sh coverage
  ```
- **Pre-commit hook**
  ```bash
  cat > .git/hooks/pre-commit <<'EOF'
  #!/bin/bash
  echo "üß™ –ó–∞–ø—É—Å–∫ smoke —Ç–µ—Å—Ç–æ–≤..."
  ./run_tests.sh smoke
  if [ $? -ne 0 ]; then
    echo "‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏! –ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω—ë–Ω."
    exit 1
  fi
  echo "‚úÖ –¢–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º."
  EOF
  chmod +x .git/hooks/pre-commit
  ```

---

## –î–µ–ø–ª–æ–π

### Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**
```bash
make setup    # –°–æ–∑–¥–∞—Ç—å .env.prod
make up       # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make logs     # –õ–æ–≥–∏
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
```bash
make up          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ
make down        # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ
make rebuild     # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
make logs-bot    # –õ–æ–≥–∏ –±–æ—Ç–∞
make logs-api    # –õ–æ–≥–∏ API
make ps          # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
```

**–ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```bash
./scripts/safe_redeploy.sh         # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–µ–ø–ª–æ–π —Å –±—ç–∫–∞–ø–æ–º
./scripts/safe_redeploy.sh --clean # –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ë–î (‚ö†Ô∏è —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ)
make restart-bot                   # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
make logs-bot                      # –ü–æ—Ç–æ–∫ –ª–æ–≥–æ–≤ –±–æ—Ç–∞
make logs-db                       # –ü–æ—Ç–æ–∫ –ª–æ–≥–æ–≤ PostgreSQL
make backup                        # –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –≤—Ä—É—á–Ω—É—é
make restore                       # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø
make health                        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π healthcheck
```

---

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–¥–µ–ø–ª–æ–π (–ë–ï–ó –ø–æ—Ç–µ—Ä–∏ –ë–î)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
```bash
./scripts/safe_redeploy.sh
```

**–í—Ä—É—á–Ω—É—é:**
```bash
docker-compose down && \
git pull && \
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true && \
make rebuild && \
make logs-bot
```

**‚ö†Ô∏è –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:**
```bash
make redeploy  # –≠—Ç–æ —É–¥–∞–ª–∏—Ç –ë–î!
```

---

### –ü–æ—à–∞–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è

1. **–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é** (–µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω):
   ```bash
   make backup
   ```
2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥**:
   ```bash
   git status
   git pull origin dev
   ```
3. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ**:
   ```bash
   ls -la soul_bot/database/migration_runner.py
   ls -la soul_bot/database/resilience.py
   ```
4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π**:
   - –ü–µ—Ä–≤–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–ª–∏ –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π: `./scripts/safe_redeploy.sh --clean`
   - –†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ü–∏–∫–ª: `./scripts/safe_redeploy.sh`
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ª–æ–≥–∏**:
   ```bash
   make logs-bot | head -50
   ```
   –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —á–µ—Ç—ã—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è `‚úÖ ...`.
6. **–°–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î**:
   ```bash
   make shell-db
   \dt
   SELECT * FROM schema_migrations;
   \q
   ```
   –¢–∞–±–ª–∏—Ü—ã `aiogram_states` –∏ `schema_migrations` –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å, –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî —Å–æ —Å–≤–µ–∂–∏–º–∏ –º–µ—Ç–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏.
7. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞** ‚Äî –≤—Ä—É—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π.
8. **–ù–∞–±–ª—é–¥–∞—Ç—å –ª–æ–≥–∏** –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç:
   ```bash
   make logs-bot
   ```
   –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫.
9. **–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ø–ª–æ–π** (issue tracker / changelog).

---

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

**`.env.prod` —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```bash
# Telegram
BOT_TOKEN=your_bot_token

# OpenAI
OPENAI_API_KEY=sk-...

# PostgreSQL
POSTGRES_DB=soul_bot
POSTGRES_USER=soul_user
POSTGRES_PASSWORD=...

# Feature Flags
USE_CHAT_COMPLETION=true
ENABLE_STYLE_SETTINGS=true
ENABLE_PATTERN_ANALYSIS=true
ENABLE_ADAPTIVE_QUIZ=true
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
./validate-env.sh
```

---

### –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π:**
```bash
# 1. –£–±–µ–¥–∏—Å—å —á—Ç–æ .env.prod –Ω–∞ –º–µ—Å—Ç–µ
ls -la .env.prod

# 2. –ó–∞–ø–æ–ª–Ω–∏ placeholder'—ã
nano .env.prod

# 3. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥
./validate-env.sh

# 4. –û—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# 5. –£–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true

# 6. –ó–∞–ø—É—Å—Ç–∏ —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
make rebuild

# 7. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
make logs-bot
```

**–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–ø–ª–æ–∏:**
```bash
./scripts/safe_redeploy.sh
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

**1. –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:**
```bash
docker-compose ps
```
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ 3 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: postgres (healthy), bot (up), api (up)

**2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å:**
```bash
docker exec soulnear_bot env | grep -E "BOT_TOKEN|OPENAI_API_KEY"
```
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

**3. –õ–æ–≥–∏ –±–µ–∑ –æ—à–∏–±–æ–∫:**
```bash
make logs-bot
```
–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- ‚ùå `KeyError: 'OPENAI_API_KEY'`
- ‚ùå `ConnectionRefusedError`
- ‚ùå `WARNING: The ... variable is not set`

**4. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:**
–ó–∞–π–¥–∏ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å `/start`

---

### –†–∞–±–æ—Ç–∞ —Å –ë–î

**–ë—ç–∫–∞–ø:**
```bash
make backup
```
–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `backups/backup_YYYYMMDD_HHMMSS.sql`

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```bash
make restore
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:**
```bash
make shell-db
# psql –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:**
- ‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (avg/p95/p99)
- üíæ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î (queries per second)
- üî• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI

**–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ:**
- üìà Retention (–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- ‚è±Ô∏è Session duration
- ‚úÖ Quiz completion rate
- ‚öôÔ∏è Feature usage

---

### –õ–æ–≥–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä:**
```bash
make logs-bot     # –õ–æ–≥–∏ –±–æ—Ç–∞
make logs-api     # –õ–æ–≥–∏ API
make logs-db      # –õ–æ–≥–∏ PostgreSQL
make logs         # –í—Å–µ –ª–æ–≥–∏
```

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
```bash
make logs-bot | grep ERROR
make logs-bot | grep "QUICK ANALYSIS"
```

---

### –ü–æ—Å—Ç–¥–µ–ø–ª–æ–π–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞)

- **–ö–∞–∂–¥—ã–π —á–∞—Å**
  ```bash
  make ps
  ```
  –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ postgres `Up (healthy)` –∏ bot `Up`.
- **–õ–æ–≥–∏ –±–æ—Ç–∞**
  ```bash
  make logs-bot | tail -50
  ```
  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç `ERROR`/`CRITICAL`.
- **–ü–æ–∏—Å–∫ —Å–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º**
  ```bash
  make logs-bot | grep -Ei "recovery|does not exist"
  make logs-db  | grep -Ei "role \"root\" does not exist"
  ```
  –ö–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

---

## Manual QA: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è (Stage 2)

1. **–î–æ—Å—Ç—É–ø –∫ –º–µ–Ω—é**
   - `/settings` –∏–ª–∏ `–ü—Ä–æ—Ñ–∏–ª—å ‚Üí üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è` –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Å —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
2. **–í—ã–±–æ—Ä —Ç–æ–Ω–∞**
   - –í –º–µ–Ω—é –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —á–µ—Ç—ã—Ä–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –∏—Ä–æ–Ω–∏—á–Ω—ã–π, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π) + –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª.
   - –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è toast `‚úÖ –¢–æ–Ω –∏–∑–º–µ–Ω—ë–Ω ...`, –º–µ–Ω—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Å–≤–æ–¥–∫–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
3. **–í—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –¥–ª–∏–Ω—ã**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ª–∏—á–Ω–æ—Å—Ç–µ–π (–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –¥—Ä—É–≥, –∫–æ—É—á) –∏ –¥–ª–∏–Ω—ã (–∫—Ä–∞—Ç–∫–æ, —Å—Ä–µ–¥–Ω–µ, –ø–æ–¥—Ä–æ–±–Ω–æ).
   - –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ `/settings` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
4. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –æ—Ç–≤–µ—Ç–∞–º**
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
     - –§–æ—Ä–º–∞–ª—å–Ω—ã–π + –ù–∞—Å—Ç–∞–≤–Ω–∏–∫ + –ö—Ä–∞—Ç–∫–æ ‚Äî –æ—Ç–≤–µ—Ç—ã –¥–æ –¥–≤—É—Ö –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–µ–≤, –¥–µ–ª–æ–≤–æ–π —Ç–æ–Ω.
     - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π + –î—Ä—É–≥ + –ü–æ–¥—Ä–æ–±–Ω–æ ‚Äî —Ç—ë–ø–ª—ã–π –æ—Ç–≤–µ—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, ‚â• 4 –∞–±–∑–∞—Ü–µ–≤.
     - –ò—Ä–æ–Ω–∏—á–Ω—ã–π + –ö–æ—É—á + –°—Ä–µ–¥–Ω–µ ‚Äî –ª—ë–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è.
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –≤—Å–µ—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤ (`helper`, `soulsleep`, –∞–Ω–∞–ª–∏–∑).
5. **Edge cases**
   - Feature flag `ENABLE_STYLE_SETTINGS=false` ‚Üí –±–æ—Ç –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ¬´‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã¬ª.
   - –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π / –¥—Ä—É–≥ / —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞.
   - –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ 10+ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö.

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: WARNING about missing variables

**–ü—Ä–∏—á–∏–Ω–∞:** Docker Compose –ø—ã—Ç–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å `${VAR}` –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ö–æ—Å—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ `docker-compose.yml`. –°–¥–µ–ª–∞–π `git pull` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏

---

### –ü—Ä–æ–±–ª–µ–º–∞: KeyError: 'ContainerConfig'

**–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π metadata

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker-compose down
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true
docker-compose up -d --build
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –≤–∏–¥–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.prod

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ñ–∞–π–ª –Ω–∞ –º–µ—Å—Ç–µ
ls -la .env.prod

# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ env_file —É–∫–∞–∑–∞–Ω –≤ docker-compose.yml
grep -A5 "bot:" docker-compose.yml | grep "env_file"
```

---

## Rollout Process

**–ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞ PROD:**

1. ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ: `pytest tests/ -v`
2. ‚úÖ –†—É—á–Ω–æ–π regression checklist –ø—Ä–æ–π–¥–µ–Ω
3. ‚úÖ –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ (–Ω–µ—Ç ERROR/CRITICAL)
4. ‚úÖ Performance –≤ –Ω–æ—Ä–º–µ (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 3 —Å–µ–∫)
5. ‚úÖ Feature flag –≥–æ—Ç–æ–≤ –∫ –≤–∫–ª—é—á–µ–Ω–∏—é
6. ‚úÖ –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –∏–∑–≤–µ—Å—Ç–µ–Ω

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–∫–ª—é—á–∞–µ–º feature flag –≤ `.env.prod`
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–º 1 —á–∞—Å
3. –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí feature —Å—Ç–∞–±–∏–ª—å–Ω–∞
4. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –≤—ã–∫–ª—é—á–∞–µ–º flag, —Ñ–∏–∫—Å–∏–º, –ø–æ–≤—Ç–æ—Ä—è–µ–º

---

**–ü–æ–¥—Ä–æ–±–Ω–µ–µ:** —Å–º. `SERVER_DEPLOY_INSTRUCTIONS.md` (—Å—Ç–∞—Ä—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω)

