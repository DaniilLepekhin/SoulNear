# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Feature Flags

–í—Å–µ –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∑–∞ feature flags –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:

```bash
# .env.test
USE_CHAT_COMPLETION=true
ENABLE_STYLE_SETTINGS=true
ENABLE_PATTERN_ANALYSIS=true
ENABLE_ADAPTIVE_QUIZ=true

# .env.prod (–≤–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
USE_CHAT_COMPLETION=true
ENABLE_STYLE_SETTINGS=true
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ test –±–æ—Ç–µ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ prod
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### –î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –±–æ—Ç–∞

**–ó–∞–ø—É—Å–∫:**
```bash
# Terminal 1 - PROD
ENV=prod python bot.py

# Terminal 2 - TEST
ENV=test python bot.py
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å—Ç—Ä–∞–¥–∞—é—Ç –æ—Ç –±–∞–≥–æ–≤
- –°–ø–æ–∫–æ–π–Ω–æ–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### Regression Test Checklist

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞:

**–ë–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- [ ] `/start` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é
- [ ] `/helper` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
- [ ] `/soulsleep` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
- [ ] –ö–≤–∏–∑—ã (4 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) ‚Äî –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `/menu` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**–ù–æ–≤—ã–µ —Ñ–∏—á–∏:**
- [ ] Style settings —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] `/my_profile` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
- [ ] Pattern analysis —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- [ ] Adaptive quiz –≤–µ—Ç–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ Q5

---

### Smoke Tests

**–ó–∞–ø—É—Å–∫:**
```bash
cd soul_bot
pytest tests/smoke_tests.py -v
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç:**
- –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞
- OpenAI API –¥–æ—Å—Ç—É–ø–µ–Ω
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ handlers —Ä–∞–±–æ—Ç–∞—é—Ç

---

## –î–µ–ø–ª–æ–π

### Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**
```bash
make setup    # –°–æ–∑–¥–∞—Ç—å .env.prod
make up       # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make logs     # –õ–æ–≥–∏
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
```bash
make up          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ
make down        # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ
make rebuild     # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
make logs-bot    # –õ–æ–≥–∏ –±–æ—Ç–∞
make logs-api    # –õ–æ–≥–∏ API
make ps          # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
```

---

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–¥–µ–ø–ª–æ–π (–ë–ï–ó –ø–æ—Ç–µ—Ä–∏ –ë–î)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
```bash
./scripts/safe_redeploy.sh
```

**–í—Ä—É—á–Ω—É—é:**
```bash
docker-compose down && \
git pull && \
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true && \
make rebuild && \
make logs-bot
```

**‚ö†Ô∏è –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:**
```bash
make redeploy  # –≠—Ç–æ —É–¥–∞–ª–∏—Ç –ë–î!
```

---

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

**`.env.prod` —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```bash
# Telegram
BOT_TOKEN=your_bot_token

# OpenAI
OPENAI_API_KEY=sk-...

# PostgreSQL
POSTGRES_DB=soul_bot
POSTGRES_USER=soul_user
POSTGRES_PASSWORD=...

# Feature Flags
USE_CHAT_COMPLETION=true
ENABLE_STYLE_SETTINGS=true
ENABLE_PATTERN_ANALYSIS=true
ENABLE_ADAPTIVE_QUIZ=true
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
./validate-env.sh
```

---

### –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π:**
```bash
# 1. –£–±–µ–¥–∏—Å—å —á—Ç–æ .env.prod –Ω–∞ –º–µ—Å—Ç–µ
ls -la .env.prod

# 2. –ó–∞–ø–æ–ª–Ω–∏ placeholder'—ã
nano .env.prod

# 3. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥
./validate-env.sh

# 4. –û—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# 5. –£–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true

# 6. –ó–∞–ø—É—Å—Ç–∏ —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
make rebuild

# 7. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
make logs-bot
```

**–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–ø–ª–æ–∏:**
```bash
./scripts/safe_redeploy.sh
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

**1. –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:**
```bash
docker-compose ps
```
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ 3 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: postgres (healthy), bot (up), api (up)

**2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å:**
```bash
docker exec soulnear_bot env | grep -E "BOT_TOKEN|OPENAI_API_KEY"
```
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

**3. –õ–æ–≥–∏ –±–µ–∑ –æ—à–∏–±–æ–∫:**
```bash
make logs-bot
```
–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- ‚ùå `KeyError: 'OPENAI_API_KEY'`
- ‚ùå `ConnectionRefusedError`
- ‚ùå `WARNING: The ... variable is not set`

**4. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:**
–ó–∞–π–¥–∏ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å `/start`

---

### –†–∞–±–æ—Ç–∞ —Å –ë–î

**–ë—ç–∫–∞–ø:**
```bash
make backup
```
–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `backups/backup_YYYYMMDD_HHMMSS.sql`

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```bash
make restore
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:**
```bash
make shell-db
# psql –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:**
- ‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (avg/p95/p99)
- üíæ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î (queries per second)
- üî• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI

**–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ:**
- üìà Retention (–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- ‚è±Ô∏è Session duration
- ‚úÖ Quiz completion rate
- ‚öôÔ∏è Feature usage

---

### –õ–æ–≥–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä:**
```bash
make logs-bot     # –õ–æ–≥–∏ –±–æ—Ç–∞
make logs-api     # –õ–æ–≥–∏ API
make logs-db      # –õ–æ–≥–∏ PostgreSQL
make logs         # –í—Å–µ –ª–æ–≥–∏
```

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
```bash
make logs-bot | grep ERROR
make logs-bot | grep "QUICK ANALYSIS"
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: WARNING about missing variables

**–ü—Ä–∏—á–∏–Ω–∞:** Docker Compose –ø—ã—Ç–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å `${VAR}` –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ö–æ—Å—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ `docker-compose.yml`. –°–¥–µ–ª–∞–π `git pull` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏

---

### –ü—Ä–æ–±–ª–µ–º–∞: KeyError: 'ContainerConfig'

**–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π metadata

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker-compose down
docker rm -f soulnear_postgres soulnear_bot soulnear_api 2>/dev/null || true
docker-compose up -d --build
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –≤–∏–¥–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.prod

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ñ–∞–π–ª –Ω–∞ –º–µ—Å—Ç–µ
ls -la .env.prod

# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ env_file —É–∫–∞–∑–∞–Ω –≤ docker-compose.yml
grep -A5 "bot:" docker-compose.yml | grep "env_file"
```

---

## Rollout Process

**–ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞ PROD:**

1. ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ: `pytest tests/ -v`
2. ‚úÖ –†—É—á–Ω–æ–π regression checklist –ø—Ä–æ–π–¥–µ–Ω
3. ‚úÖ –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ (–Ω–µ—Ç ERROR/CRITICAL)
4. ‚úÖ Performance –≤ –Ω–æ—Ä–º–µ (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 3 —Å–µ–∫)
5. ‚úÖ Feature flag –≥–æ—Ç–æ–≤ –∫ –≤–∫–ª—é—á–µ–Ω–∏—é
6. ‚úÖ –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –∏–∑–≤–µ—Å—Ç–µ–Ω

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–∫–ª—é—á–∞–µ–º feature flag –≤ `.env.prod`
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–º 1 —á–∞—Å
3. –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí feature —Å—Ç–∞–±–∏–ª—å–Ω–∞
4. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –≤—ã–∫–ª—é—á–∞–µ–º flag, —Ñ–∏–∫—Å–∏–º, –ø–æ–≤—Ç–æ—Ä—è–µ–º

---

**–ü–æ–¥—Ä–æ–±–Ω–µ–µ:** —Å–º. `SERVER_DEPLOY_INSTRUCTIONS.md` (—Å—Ç–∞—Ä—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω)

