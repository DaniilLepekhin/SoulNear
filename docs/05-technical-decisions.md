# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –∏ –Ω—é–∞–Ω—Å—ã

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. Unified Codebase (Prod + Test)

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –∫–æ–¥–æ–≤—ã–µ –±–∞–∑—ã —Å 99% –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–†–µ—à–µ–Ω–∏–µ:** Environment-based –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# config.py
ENV = os.getenv('ENV', 'prod')
load_dotenv(f'.env.{ENV}', override=True)

BOT_TOKEN = os.getenv('BOT_TOKEN')
POSTGRES_DB = os.getenv('POSTGRES_DB')  # soul_bot –∏–ª–∏ soul_test_bot
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –û–¥–∏–Ω –∫–æ–¥ –¥–ª—è –æ–±–æ–∏—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Ç–æ–∫–µ–Ω—ã –Ω–µ –≤ –∫–æ–¥–µ)
- ‚úÖ –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

---

### 2. Moderate Pattern Architecture

**–í—ã–±–æ—Ä:** Moderate (–∏–∑ Simple/Moderate/Complex)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
- Embeddings –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (—Ç–æ—á–Ω–æ—Å—Ç—å)
- JSONB –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ (–±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π)
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP, –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "patterns": [{
    "id": "uuid",
    "type": "behavioral|emotional|cognitive",
    "title": "Imposter Syndrome",
    "description": "...",
    "evidence": ["quote1", "quote2"],
    "embedding": [0.1, 0.2, ...],
    "occurrences": 5,
    "confidence": 0.85,
    "tags": ["imposter-syndrome"],
    "first_detected": "2025-10-28",
    "last_detected": "2025-10-29"
  }]
}
```

---

### 3. Embeddings –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

**–í—ã–±–æ—Ä:** OpenAI text-embedding-3-small (1536 dim)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- –ù–∏–∑–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å ($0.00002/1K tokens)
- –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (< 500ms)

**Threshold:**
- 0.55 –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (merge)
- 0.50 –¥–ª—è related patterns (—Å–≤—è–∑—å)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã:**
- Keyword matching ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
- Sentence transformers ‚Äî –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- Vector DB (Pinecone) ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è MVP

---

### 4. ChatCompletion vs Assistant API

**–í—ã–±–æ—Ä:** ChatCompletion API (primary), Assistant API (fallback)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ–º–ø—Ç–∞–º–∏
- –ì–∏–±–∫–æ—Å—Ç—å –≤ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –õ—É—á—à–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å pattern analysis
- Fallback –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
if USE_CHAT_COMPLETION:
    return await openai_service.get_chat_completion(...)
else:
    return await get_assistant_response(...)  # Legacy
```

---

## –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

### Quote Hallucination

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –ø—Ä–∏–¥—É–º—ã–≤–∞–ª —Ü–∏—Ç–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—à–µ–Ω–∏–µ:**
- –°–µ–∫—Ü–∏—è "RECENT USER MESSAGES" –≤ system prompt
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π —è–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è GPT
- –°—Ç—Ä–æ–≥–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –∏–∑ —Å–ø–∏—Å–∫–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 100% accuracy –≤ —Ç–µ—Å—Ç–∞—Ö

---

### Pattern Occurrences –Ω–µ —Ä–∞—Å—Ç—É—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** Occurrences –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –Ω–∞ —É—Ä–æ–≤–Ω–µ 1-2

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. GPT –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞ repeated themes ‚Üí —É—Å–∏–ª–∏—Ç—å –ø—Ä–æ–º–ø—Ç
2. Embeddings –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç similarity ‚Üí —Å–Ω–∏–∑–∏—Ç—å threshold (0.55 ‚Üí 0.50)
3. –ß–∞—Å—Ç–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å (3 ‚Üí 2 —Å–æ–æ–±—â–µ–Ω–∏—è)

**–†–µ—à–µ–Ω–∏–µ:**
- –£—Å–∏–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- Keyword-based fallback –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

### Context Length –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** System prompt –º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –¥–æ 128K+ tokens

**–†–µ—à–µ–Ω–∏–µ:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: —Ç–æ–ø-5 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 3 evidence –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω
- Truncate descriptions –¥–æ 200 chars
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ summarization –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (future)

---

### –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏–º–µ–Ω—è–ª–∞—Å—å –¥–∞–∂–µ –∫ factual questions

**–†–µ—à–µ–Ω–∏–µ:**
- Context relevance check (< 5ms heuristic)
- Factual indicators ‚Üí skip personalization
- Emotional keywords ‚Üí apply personalization

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
def is_personalization_relevant(message, pattern):
    # Fast heuristic
    if '?' in message and factual_indicators:
        return False
    if any(tag in message for tag in pattern['tags']):
        return True
    if any(kw in message for kw in emotional_keywords):
        return True
    return False
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** System prompt –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑

**–†–µ—à–µ–Ω–∏–µ:**
```python
@lru_cache(maxsize=100)
def get_cached_base_instructions(assistant_type):
    return _get_base_instructions(assistant_type)
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~50ms –Ω–∞ –∑–∞–ø—Ä–æ—Å

---

### 2. Batch Embeddings

**–¢–µ–∫—É—â–µ–µ:** –û–¥–∏–Ω embedding –∑–∞ —Ä–∞–∑

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (future):**
```python
embeddings = await get_embeddings_batch([pattern1, pattern2, ...])
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~200ms –Ω–∞ batch –∏–∑ 5 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

---

### 3. Database Query Optimization

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ü–∏–∫–ª–µ

**–†–µ—à–µ–Ω–∏–µ:**
- Collect all changes, single update at the end
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bulk operations –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Embeddings –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ –≤ –ë–î

**–¢–µ–∫—É—â–µ–µ:** ~6 KB per pattern (1536 floats √ó 4 bytes)

**–ï—Å–ª–∏ 20 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:** 120 KB per user (acceptable)

**Future solutions:**
- Dimension reduction (512 dim –≤–º–µ—Å—Ç–æ 1536)
- External storage (Pinecone, Weaviate)
- Compression (bytes –≤–º–µ—Å—Ç–æ JSON array)

---

### 2. Post-processing truncation –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å —Å–º—ã—Å–ª

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±—Ä–µ–∑–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º –º–æ–∂–µ—Ç –æ–±–æ—Ä–≤–∞—Ç—å –º—ã—Å–ª—å

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å semantic check (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–º)
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å "..." –≤ –∫–æ–Ω–µ—Ü –µ—Å–ª–∏ –æ–±—Ä–µ–∑–∞–ª–∏

---

### 3. GPT –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** "–°–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞" –≤–º–µ—Å—Ç–æ "Imposter Syndrome"

**–†–µ—à–µ–Ω–∏–µ:**
- –Ø–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ –ø—Ä–æ–º–ø—Ç–µ: "ALL pattern titles MUST be in ENGLISH"
- Fallback: translate_to_english() –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

## Best Practices

### 1. Feature Flags –≤–µ–∑–¥–µ

```python
if is_feature_enabled('ENABLE_PATTERN_ANALYSIS'):
    await pattern_analyzer.analyze_if_needed(user_id)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–ª–∞–≤–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

---

### 2. JSONB –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏

**–ü–∞—Ç—Ç–µ—Ä–Ω—ã, –∏–Ω—Å–∞–π—Ç—ã, emotional_state ‚Äî –≤—Å—ë JSONB**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–µ–∑ ALTER TABLE
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è
- –ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤

---

### 3. –û–±–∏–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Å—Ç–∞:**
- Pattern analysis (GPT returned X patterns)
- Embedding similarity (similarity: 0.75)
- Merge operations (occurrences: 3 ‚Üí 4)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ–µ–≥–∫–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- Debugging-friendly

---

### 4. Graceful Degradation

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å ‚Äî fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –≤–µ—Ä—Å–∏—é

**–ü—Ä–∏–º–µ—Ä—ã:**
- GPT API failure ‚Üí —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- Embedding failure ‚Üí keyword-based –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- Database error ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

---

## Lessons Learned

### –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ —Ö–æ—Ä–æ—à–æ:

1. ‚úÖ **Quote Fix —á–µ—Ä–µ–∑ "RECENT MESSAGES"** ‚Äî 100% accuracy —Å—Ä–∞–∑—É
2. ‚úÖ **Embeddings –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω—É–∂–µ–Ω tuning
3. ‚úÖ **JSONB –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏** ‚Äî –ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ **Incremental approach** ‚Äî Stage by Stage, smoke tests
5. ‚úÖ **Detailed logging** ‚Äî –ø–æ–º–æ–≥–ª–æ –Ω–∞–π—Ç–∏ –±–∞–≥–∏ –±—ã—Å—Ç—Ä–æ

### –ß—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ:

1. ‚ö†Ô∏è **Occurrences growth** ‚Äî –¥–æ —Å–∏—Ö –ø–æ—Ä —Ç—Ä–µ–±—É–µ—Ç fine-tuning
2. ‚ö†Ô∏è **GPT prompt engineering** ‚Äî –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ –∏—Ç–µ—Ä–∞—Ü–∏–π
3. ‚ö†Ô∏è **Embeddings tuning** ‚Äî threshold 0.55 –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ optimal
4. ‚ö†Ô∏è **System prompt length** ‚Äî –Ω—É–∂–Ω–æ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å detail vs tokens

### –ß—Ç–æ –±—ã —Å–¥–µ–ª–∞–ª–∏ –ø–æ-–¥—Ä—É–≥–æ–º—É:

1. üîÑ **–†–∞–Ω—å—à–µ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ø–æ—Ç–µ—Ä—è–ª–∏ –≤—Ä–µ–º—è –Ω–∞ debugging
2. üîÑ **Unit tests —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞** ‚Äî —Å–µ–π—á–∞—Å —Å–ª–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å
3. üîÑ **Template system –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤** ‚Äî —Å–µ–π—á–∞—Å hardcoded –≤ –∫–æ–¥–µ
4. üîÑ **Vector DB —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞** ‚Äî –µ—Å–ª–∏ embeddings –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∏ —Ä–µ—à–µ–Ω–∏—è –±—ã–ª–∏ –ø—Ä–∏–Ω—è—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ MVP. –ü–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞.

