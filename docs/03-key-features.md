# –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

## 1. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### Pattern Analyzer

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `pattern_analyzer.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞
- `embedding_service.py` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å embeddings
- `openai_service.py` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–º–ø—Ç—ã

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–¢—Ä–∏–≥–≥–µ—Ä –∞–Ω–∞–ª–∏–∑–∞:**
   ```python
   # –ö–∞–∂–¥—ã–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí quick analysis
   if message_count % 3 == 0:
       await quick_analysis(user_id, assistant_type)
   
   # –ö–∞–∂–¥—ã–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí deep analysis
   if message_count % 20 == 0:
       await deep_analysis(user_id, assistant_type)
   ```

2. **Quick Analysis:**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 15 —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ü—Ä–æ–º–ø—Ç –¥–ª—è GPT-4o-mini —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
   - –í–æ–∑–≤—Ä–∞—Ç JSON —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –∏ evidence
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ embeddings
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

3. **Deep Analysis:**
   - –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ learning preferences

**–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
```python
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞:
embedding = await get_embedding(pattern_text)
for existing in existing_patterns:
    similarity = cosine_similarity(embedding, existing['embedding'])
    if similarity > 0.55:  # Threshold
        # Merge: occurrences++, evidence.extend()
        existing['occurrences'] += 1
        existing['evidence'].extend(new_evidence)
        return
# –ò–Ω–∞—á–µ: –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
```

---

## 2. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–≤–∏–∑—ã

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `quiz_service/generator.py` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
- `quiz_service/adaptive_quiz_service.py` ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ
- `quiz_service/analyzer.py` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- `handlers/user/quiz.py` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–≤–∏–∑–æ–≤

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤

**–ë–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (8):**
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: relationships, money, confidence, fears
- –¢–∏–ø—ã: text, scale, multiple_choice
- Mixing: –∏–∑–±–µ–≥–∞–Ω–∏–µ 3+ text –ø–æ–¥—Ä—è–¥
- –°—Ü–µ–Ω–∞—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è

**–ü—Ä–æ–º–ø—Ç –¥–ª—è GPT:**
```
Category: {category}
Generate 8 questions with MIXED types:
- text: open-ended, emotional
- scale: 1-5 ratings
- multiple_choice: 3-4 options

AVOID 3+ text questions in a row.
Include scenario-based questions.
```

### –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞ 5

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ GPT-4o-mini
2. –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å confidence > 0.7
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 5 candidate follow-up questions
4. –í—ã–±–æ—Ä top-3 –ø–æ quality_score
5. –ò–Ω—ä–µ–∫—Ü–∏—è –≤ –∫–≤–∏–∑ (8 ‚Üí 11 –≤–æ–ø—Ä–æ—Å–æ–≤)

**–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤:**
```python
quality_score = (
    relevance * 0.4 +
    depth * 0.3 +
    uniqueness * 0.2 +
    clarity * 0.1
)
```

### –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–û–∫–µ–π, –≤–æ—Ç —á—Ç–æ —è –ø–æ–Ω—è–ª –ø—Ä–æ —Ç–µ–±—è."
- –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è: GPT-based –¥–µ—Ç–µ–∫—Ü–∏—è
- –°–∫—Ä—ã—Ç–∞—è –¥–∏–Ω–∞–º–∏–∫–∞: —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç
- –†–µ—Å—É—Ä—Å—ã: –≥–¥–µ —Å–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Outro: –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é

**Conversational tone:**
```
‚ùå "–£ –≤–∞—Å –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –Ω–∏–∑–∫–∞—è —Å–∞–º–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
‚úÖ "–¢—ã –Ω–µ –≤–µ—Ä–∏—à—å —á—Ç–æ —Å–ø—Ä–∞–≤–∏—à—å—Å—è, –¥–∞?"
```

---

## 3. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

### System Prompt Construction

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

1. **Style Instructions:**
   ```
   ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π {tone} —Ç–æ–Ω.
   ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–≤–µ—á–∞–π {length} (–º–∞–∫—Å–∏–º—É–º N —Å–ª–æ–≤).
   ```

2. **User Info:**
   ```
   –ò–º—è: {name}
   –í–æ–∑—Ä–∞—Å—Ç: {age}
   –ü–æ–ª: {gender}
   ```

3. **Patterns Section:**
   ```
   ## üß† –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:
   
   **[{type}] {title}**
   –û–ø–∏—Å–∞–Ω–∏–µ: {description}
   –ß–∞—Å—Ç–æ—Ç–∞: {occurrences}x
   üìù –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤:
     ‚Ä¢ "{evidence[0]}"
     ‚Ä¢ "{evidence[1]}"
   ```

4. **Recent Messages:**
   ```
   ## üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
   1. "{message1}"
   2. "{message2}"
   ...
   
   ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–ï –ü–†–ê–í–ò–õ–û –¶–ò–¢–ò–†–û–í–ê–ù–ò–Ø:
   –ï—Å–ª–∏ —Ü–∏—Ç–∏—Ä—É–µ—à—å - –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ñ—Ä–∞–∑—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ!
   ```

5. **Insights & Emotional State:**
   ```
   ## üí° –ò–Ω—Å–∞–π—Ç—ã:
   {insight.title}: {insight.description}
   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: {insight.recommendations}
   
   ## üòä –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
   –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {mood}
   –£—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: {stress_level}
   ```

### Context Relevance Check

**Heuristic (< 5ms):**
```python
def is_personalization_relevant(message, pattern):
    # Factual questions ‚Üí skip
    if '?' in message and factual_indicators:
        return False
    
    # Pattern keywords ‚Üí relevant
    if any(tag in message for tag in pattern['tags']):
        return True
    
    # Emotional content ‚Üí relevant
    if any(kw in message for kw in emotional_keywords):
        return True
    
    return False
```

---

## 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è

### UI Flow

**–ú–µ–Ω—é:**
```
/profile ‚Üí ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è ‚Üí [–≤—ã–±–æ—Ä]
```

**–û–ø—Ü–∏–∏:**

**–¢–æ–Ω:**
- üé© –§–æ—Ä–º–∞–ª—å–Ω—ã–π
- üòä –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π
- üòè –°–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π
- üî• –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π

**–õ–∏—á–Ω–æ—Å—Ç—å:**
- üßô –ú—É–¥—Ä—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫
- üë• –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –¥—Ä—É–≥
- üí™ –°—Ç—Ä–æ–≥–∏–π –∫–æ—É—á
- üßò –¢–µ—Ä–∞–ø–µ–≤—Ç

**–î–ª–∏–Ω–∞:**
- ‚ö°‚ö° Ultra brief (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- ‚ö° Brief (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- üìù Medium (3-5 –∞–±–∑–∞—Ü–µ–≤)
- üìö Detailed (–ø–æ–¥—Ä–æ–±–Ω–æ)

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

**–í –ø—Ä–æ–º–ø—Ç–µ:**
```python
tone_instructions = {
    'formal': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –°–¢–†–û–ì–û —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–æ–Ω...',
    'friendly': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ —Ç—ë–ø–ª—ã–º...',
    'sarcastic': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –ª—ë–≥–∫—É—é –∏—Ä–æ–Ω–∏—é...',
    'motivating': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ë—É–¥—å —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º...'
}
```

**Post-processing:**
```python
def _enforce_message_length(text, length):
    word_limit = {
        'ultra_brief': 50,
        'brief': 100,
        'medium': 300,
        'detailed': 600
    }
    # –û–±—Ä–µ–∑–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º –¥–æ –ª–∏–º–∏—Ç–∞
    # ...
```

---

## 5. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Embeddings

**–ú–æ–¥–µ–ª—å:** OpenAI text-embedding-3-small (1536 dim)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- Cosine similarity –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- Threshold: 0.55 –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, 0.50 –¥–ª—è related

**–•—Ä–∞–Ω–µ–Ω–∏–µ:**
- –í JSONB –ø–æ–ª–µ `patterns[].embedding`
- ~6 KB per pattern
- –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è

### Conversation History

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE conversation_history (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,
    assistant_type VARCHAR(32),
    role VARCHAR(16),  -- 'user' | 'assistant' | 'system'
    content TEXT,
    timestamp TIMESTAMP,
    metadata JSONB  -- tokens, model, etc
);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è GPT (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –¢–æ—á–Ω–æ–µ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Error Handling

**Graceful Degradation:**
- GPT API failure ‚Üí fallback –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- Embedding failure ‚Üí keyword-based –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- Database error ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

**Feature Flags:**
- –í—Å–µ –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –∑–∞ flags
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–ü–æ–¥—Ä–æ–±–Ω–µ–µ:** —Å–º. –∫–æ–¥ –≤ `soul_bot/bot/services/` –∏ `soul_bot/database/`

