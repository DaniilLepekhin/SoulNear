# üöÄ –ï–¥–∏–Ω—ã–π –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏–π SOUL.near Bot

**–î–∞—Ç–∞:** 31 –æ–∫—Ç—è–±—Ä—è 2025  
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –ê–Ω–∞–ª–∏–∑ 3 AI –∞–≥–µ–Ω—Ç–æ–≤ + —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç  
**Scope:** Telegram –±–æ—Ç (–≤–µ–±-–≤–µ—Ä—Å–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∞)

---

## üìä –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### –ß—Ç–æ –≤—Å–µ –∞–≥–µ–Ω—Ç—ã –Ω–∞—à–ª–∏ (–∫–æ–Ω—Å–µ–Ω—Å—É—Å):

‚úÖ **UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∏–ª—è —Ç—Ä–µ–±—É–µ—Ç —É–ø—Ä–æ—â–µ–Ω–∏—è** (5 —Ç–∞–ø–æ–≤ ‚Üí 1 —Ç–∞–ø)  
‚úÖ **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –¥–ª–∏–Ω–µ/–∫–æ–Ω—Ç–µ–∫—Å—Ç—É**  
‚úÖ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è** (–Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç)  
‚úÖ **–ö–≤–∏–∑ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π** (—Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑)  
‚úÖ **Legacy –∫–æ–¥ –Ω–µ —É–¥–∞–ª—ë–Ω** (Assistant API, config_old.py)

### –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –ø–æ –∞–≥–µ–Ω—Ç–∞–º:

**–ê–≥–µ–Ω—Ç 1 (—Ñ–∏–ª–æ—Å–æ—Ñ):**
- –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (surface ‚Üí existential)
- –¢–µ–º–ø–æ–≤–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –æ–±—â–µ–Ω–∏—è
- Time-based tones (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä/–Ω–æ—á—å)

**–ê–≥–µ–Ω—Ç 2 (–ø—Ä–∞–∫—Ç–∏–∫):**
- –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –º–µ–Ω—é ‚úÖ
- –ú–æ–¥—É–ª—å formatting.py ‚úÖ

**–ê–≥–µ–Ω—Ç 3 (–∞—É–¥–∏—Ç–æ—Ä):**
- Magic numbers –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç (–ö–†–ò–¢–ò–ß–ù–û!)
- conversation_metrics –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- learning_preferences —Ç–µ—Ä—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ (set ‚Üí OrderedDict)
- therapist –µ—Å—Ç—å –≤ constants, –Ω–æ –Ω–µ –≤ UI
- Temperature —Ä–µ–∂–∏–º (auto-–∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∏–ª—è –ø–æ mood)
- Quick switch –ø—Ä–µ—Å–µ—Ç—ã

**–ú–æ–π –≤–∫–ª–∞–¥:**
- Realtime mood detector –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
- Context relevance check –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
- Emergency prompts –¥–ª—è –∫—Ä–∏–∑–∏—Å–æ–≤

---

## üéØ UNIFIED PLAN (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã)

---

## PHASE 1: –†–ï–§–ê–ö–¢–û–†–ò–ù–ì –ò –û–ß–ò–°–¢–ö–ê (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üî• CRITICAL)

**Timeline:** 2-3 —á–∞—Å–∞  
**Impact:** Code health 6/10 ‚Üí 9/10

### 1.1 –£–¥–∞–ª–∏—Ç—å Legacy –∫–æ–¥ ‚è±Ô∏è 30 –º–∏–Ω—É—Ç

**–§–∞–π–ª—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:**

```bash
# –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å
rm soul_bot/config_old.py
rm -rf webapp_test_bot/

# Markdown –æ—Ç—á—ë—Ç—ã (–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å)
rm soul_bot/STAGE_1_PROGRESS.md
rm soul_bot/STAGE_2_COMPLETE.md
rm soul_bot/STAGE_2_FIX.md
rm soul_bot/NEXT_STEPS.md
# (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ: README.md, TESTING.md)
```

**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥:**

`soul_bot/bot/functions/ChatGPT.py` - —É–¥–∞–ª–∏—Ç—å legacy Assistant API:

```python
# –£–î–ê–õ–ò–¢–¨ lines 59-147 (–≤–µ—Å—å –±–ª–æ–∫ —Å feature flag)
async def get_assistant_response(user_id: int, prompt: str, assistant: str) -> str | None:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ ChatCompletion API (unified)"""
    try:
        return await openai_service.get_chat_completion(
            user_id=user_id,
            message=prompt,
            assistant_type=assistant
        )
    except Exception as e:
        logging.error(f"ChatCompletion API failed: {e}")
        await send_error(function='get_assistant_response', error=e)
        return None

# –£–î–ê–õ–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é new_context() (lines 150-181)
```

**–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:**

```sql
-- soul_bot/database/migrations/003_remove_thread_ids.sql
ALTER TABLE users DROP COLUMN IF EXISTS helper_thread_id;
ALTER TABLE users DROP COLUMN IF EXISTS sleeper_thread_id;
ALTER TABLE users DROP COLUMN IF EXISTS assistant_thread_id;
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~180 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 3 –∫–æ–ª–æ–Ω–∫–∏ –ë–î

---

### 1.2 Magic Numbers ‚Üí –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ‚è±Ô∏è 1 —á–∞—Å

**–ü—Ä–æ–±–ª–µ–º–∞ (–Ω–∞–π–¥–µ–Ω–∞ –ê–≥–µ–Ω—Ç–æ–º 3):**

```python
# soul_bot/bot/services/pattern_analyzer.py:511-512
if message_count > 0 and message_count % 3 == 0:  # ‚Üê magic number!
    await quick_analysis(user_id, assistant_type)
if message_count > 0 and message_count % 20 == 0:  # ‚Üê magic number!
    await deep_analysis(user_id, assistant_type)
```

**–†–µ—à–µ–Ω–∏–µ:**

`soul_bot/bot/services/constants.py` - –¥–æ–±–∞–≤–∏—Ç—å:

```python
# Pattern Analysis Frequencies
QUICK_ANALYSIS_FREQUENCY = 3  # messages
DEEP_ANALYSIS_FREQUENCY = 20  # messages
QUICK_ANALYSIS_MIN_MESSAGES = 4
DEEP_ANALYSIS_MIN_MESSAGES = 10

# Pattern Analysis Context Sizes
QUICK_ANALYSIS_CONTEXT_SIZE = 15  # messages
DEEP_ANALYSIS_CONTEXT_SIZE = 30  # messages

# –£–∂–µ –µ—Å—Ç—å, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:
# QUICK_ANALYSIS_FREQUENCY = 5  ‚Üê –ö–û–ù–§–õ–ò–ö–¢! –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ 3 –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
```

**–û–±–Ω–æ–≤–∏—Ç—å:**

`soul_bot/bot/services/pattern_analyzer.py`:

```python
from bot.services.constants import (
    QUICK_ANALYSIS_FREQUENCY,
    DEEP_ANALYSIS_FREQUENCY,
    QUICK_ANALYSIS_MIN_MESSAGES,
    DEEP_ANALYSIS_MIN_MESSAGES,
    QUICK_ANALYSIS_CONTEXT_SIZE,
    DEEP_ANALYSIS_CONTEXT_SIZE
)

async def quick_analysis(user_id: int, assistant_type: str = 'helper'):
    messages = await conversation_history.get_context(
        user_id=user_id,
        assistant_type=assistant_type,
        max_messages=QUICK_ANALYSIS_CONTEXT_SIZE  # –≤–º–µ—Å—Ç–æ 15
    )
    
    if len(messages) < QUICK_ANALYSIS_MIN_MESSAGES:  # –≤–º–µ—Å—Ç–æ 4
        logger.debug("Not enough messages for analysis")
        return
    # ...

async def analyze_if_needed(user_id: int, assistant_type: str = 'helper'):
    message_count = await conversation_history.count_messages(user_id, assistant_type)
    
    if message_count > 0 and message_count % QUICK_ANALYSIS_FREQUENCY == 0:
        await quick_analysis(user_id, assistant_type)
    
    if message_count > 0 and message_count % DEEP_ANALYSIS_FREQUENCY == 0:
        await deep_analysis(user_id, assistant_type)
```

**Impact:** –£–ø—Ä–æ—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –±–∞–≥–∏

---

### 1.3 Cleanup –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π ‚è±Ô∏è 30 –º–∏–Ω—É—Ç

**–ü—Ä–æ–±–ª–µ–º–∞ (–Ω–∞–π–¥–µ–Ω–∞ –ê–≥–µ–Ω—Ç–æ–º 3):**

`conversation_metrics` –æ–±—ä—è–≤–ª–µ–Ω–æ –≤ –º–æ–¥–µ–ª–∏, –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏, –Ω–æ **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∏–≥–¥–µ**.

**–†–µ—à–µ–Ω–∏–µ - Option A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):** –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ

```sql
-- soul_bot/database/migrations/004_cleanup_unused_fields.sql
ALTER TABLE user_profiles DROP COLUMN IF EXISTS conversation_metrics;
```

`soul_bot/database/models/user_profile.py` - —É–¥–∞–ª–∏—Ç—å:

```python
# –£–î–ê–õ–ò–¢–¨:
# conversation_metrics: Mapped[dict] = mapped_column(JSONB, default=lambda: {...})
```

**–†–µ—à–µ–Ω–∏–µ - Option B:** –ù–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

```python
# soul_bot/bot/services/openai_service.py

async def save_conversation(...):
    # –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    await _update_conversation_metrics(user_id, assistant_type)

async def _update_conversation_metrics(user_id: int, assistant_type: str):
    """–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –æ–±—â–µ–Ω–∏—è"""
    profile = await user_profile.get_or_create(user_id)
    metrics = profile.conversation_metrics
    
    # –û–±–Ω–æ–≤–ª—è–µ–º total_messages
    metrics['total_messages'] = metrics.get('total_messages', 0) + 1
    
    # –û–±–Ω–æ–≤–ª—è–µ–º avg_session_length, most_discussed_topics, question_types
    # ...
    
    await user_profile.update_metrics(user_id, metrics)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** Option A (—É–¥–∞–ª–∏—Ç—å), –µ—Å–ª–∏ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏.

---

### 1.4 Fix learning_preferences –ø–æ—Ä—è–¥–æ–∫ ‚è±Ô∏è 20 –º–∏–Ω—É—Ç

**–ü—Ä–æ–±–ª–µ–º–∞ (–Ω–∞–π–¥–µ–Ω–∞ –ê–≥–µ–Ω—Ç–æ–º 3):**

```python
# soul_bot/bot/services/pattern_analyzer.py:465-472
works_well = set(learning_prefs.get('works_well', []))  # ‚Üê —Ç–µ—Ä—è–µ–º –ø–æ—Ä—è–¥–æ–∫!
doesnt_work = set(learning_prefs.get('doesnt_work', []))

works_well.update(learning_data.get('works_well', []))
doesnt_work.update(learning_data.get('doesnt_work', []))

learning_prefs['works_well'] = list(works_well)[-10:]  # ‚Üê —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
learning_prefs['doesnt_work'] = list(doesnt_work)[-10:]
```

**–†–µ—à–µ–Ω–∏–µ:**

```python
from collections import OrderedDict

async def _update_learning_preferences(user_id: int, learning_data: dict):
    """–û–±–Ω–æ–≤–∏—Ç—å learning preferences (—á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç/–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)"""
    profile = await user_profile.get_or_create(user_id)
    learning_prefs = profile.learning_preferences
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º OrderedDict –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ (–Ω–æ–≤—ã–µ –≤ –∫–æ–Ω–µ—Ü)
    works_well = OrderedDict.fromkeys(learning_prefs.get('works_well', []))
    doesnt_work = OrderedDict.fromkeys(learning_prefs.get('doesnt_work', []))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
    for item in learning_data.get('works_well', []):
        works_well[item] = None
    for item in learning_data.get('doesnt_work', []):
        doesnt_work[item] = None
    
    # Limit: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 (—Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ)
    learning_prefs['works_well'] = list(works_well.keys())[-10:]
    learning_prefs['doesnt_work'] = list(doesnt_work.keys())[-10:]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    # ...
```

**Impact:** UI –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–µ–∂–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏

---

## PHASE 2: UI/UX –£–õ–£–ß–®–ï–ù–ò–Ø (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üî• HIGH)

**Timeline:** 3-4 —á–∞—Å–∞  
**Impact:** User satisfaction 6/10 ‚Üí 9/10

### 2.1 Unified Style Settings Menu ‚è±Ô∏è 1 —á–∞—Å

**–ü—Ä–æ–±–ª–µ–º–∞:** 5 —Ç–∞–ø–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–†–µ—à–µ–Ω–∏–µ (–≥–æ—Ç–æ–≤—ã–π –∫–æ–¥ –æ—Ç –ê–≥–µ–Ω—Ç–∞ 2):**

`soul_bot/bot/keyboards/profile.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `build_style_settings_menu_v2()`:

```python
def build_style_settings_menu_v2(current_tone: str, current_personality: str, current_length: str):
    """
    –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ - –í–°–Å –≤ –æ–¥–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
    
    –§–æ—Ä–º–∞—Ç callback_data: style_{category}_{value}
    –ù–∞–ø—Ä–∏–º–µ—Ä: style_tone_friendly, style_personality_mentor
    """
    tone_buttons = [
        InlineKeyboardButton(
            text=f"{'‚úì ' if current_tone == 'formal' else ''}üé© –§–æ—Ä–º–∞–ª—å–Ω—ã–π",
            callback_data='style_tone_formal'
        ),
        InlineKeyboardButton(
            text=f"{'‚úì ' if current_tone == 'friendly' else ''}üòä –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π",
            callback_data='style_tone_friendly'
        ),
    ]
    # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è personality –∏ length
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text='‚îÅ‚îÅ‚îÅ –¢–û–ù ‚îÅ‚îÅ‚îÅ', callback_data='noop')],
        tone_buttons,
        [InlineKeyboardButton(text='‚îÅ‚îÅ –õ–ò–ß–ù–û–°–¢–¨ ‚îÅ‚îÅ', callback_data='noop')],
        personality_buttons,
        [InlineKeyboardButton(text='‚îÅ‚îÅ‚îÅ –î–õ–ò–ù–ê ‚îÅ‚îÅ‚îÅ', callback_data='noop')],
        length_buttons,
        [InlineKeyboardButton(text='‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é', callback_data='profile')]
    ])
```

**–û–±–Ω–æ–≤–∏—Ç—å handlers:**

```python
@dp.callback_query(F.data.startswith('style_'))
async def update_style_inline(call: CallbackQuery):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π handler –¥–ª—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∏–ª—è"""
    _, category, value = call.data.split('_')  # style_tone_friendly
    
    user_id = call.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
    if category == 'tone':
        await db_user_profile.update_style(user_id, tone_style=value)
    elif category == 'personality':
        await db_user_profile.update_style(user_id, personality=value)
    elif category == 'length':
        await db_user_profile.update_style(user_id, message_length=value)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–æ—á–∫–∏ –Ω–∞ –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö)
    profile = await db_user_profile.get_or_create(user_id)
    new_menu = build_style_settings_menu_v2(
        profile.tone_style,
        profile.personality,
        profile.message_length
    )
    
    await call.message.edit_reply_markup(reply_markup=new_menu)
    await call.answer("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ", show_alert=False)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 1 —Ç–∞–ø –≤–º–µ—Å—Ç–æ 5 üéâ

---

### 2.2 Quick Switch –ü—Ä–µ—Å–µ—Ç—ã ‚è±Ô∏è 1.5 —á–∞—Å–∞

**–ò–¥–µ—è (–æ—Ç –ê–≥–µ–Ω—Ç–∞ 3):** –î–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã ("–∫–æ—É—á–µ—Ä + –∫—Ä–∞—Ç–∫–æ", "–¥—Ä—É–≥ + –ø–æ–¥—Ä–æ–±–Ω–æ")

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

`soul_bot/bot/keyboards/profile.py`:

```python
STYLE_PRESETS = {
    'coach_brief': {
        'name': 'üí™ –ö–æ—É—á (–∫—Ä–∞—Ç–∫–æ)',
        'tone': 'motivating',
        'personality': 'coach',
        'length': 'brief'
    },
    'friend_detailed': {
        'name': 'üë• –î—Ä—É–≥ (–ø–æ–¥—Ä–æ–±–Ω–æ)',
        'tone': 'friendly',
        'personality': 'friend',
        'length': 'detailed'
    },
    'therapist_medium': {
        'name': 'üßò –¢–µ—Ä–∞–ø–µ–≤—Ç (—Å—Ä–µ–¥–Ω–µ)',
        'tone': 'formal',
        'personality': 'therapist',  # ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º therapist!
        'length': 'medium'
    },
    'mentor_balanced': {
        'name': 'üßô –ú—É–¥—Ä–µ—Ü (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ)',
        'tone': 'friendly',
        'personality': 'mentor',
        'length': 'medium'
    }
}

def build_style_presets_menu():
    """–ú–µ–Ω—é –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤"""
    buttons = [
        [InlineKeyboardButton(
            text=preset['name'],
            callback_data=f'preset_{preset_id}'
        )]
        for preset_id, preset in STYLE_PRESETS.items()
    ]
    
    buttons.append([
        InlineKeyboardButton(text='‚öôÔ∏è –î–µ—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', callback_data='style_settings'),
        InlineKeyboardButton(text='‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data='profile')
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)
```

**Handler:**

```python
@dp.callback_query(F.data.startswith('preset_'))
async def apply_preset(call: CallbackQuery):
    """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ—Å–µ—Ç —Å—Ç–∏–ª—è"""
    preset_id = call.data.replace('preset_', '')
    preset = STYLE_PRESETS.get(preset_id)
    
    if not preset:
        await call.answer("–ü—Ä–µ—Å–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    user_id = call.from_user.id
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–∞–∑—É
    await db_user_profile.update_style(
        user_id,
        tone_style=preset['tone'],
        personality=preset['personality'],
        message_length=preset['length']
    )
    
    await call.answer(f"‚úÖ –ü—Ä–∏–º–µ–Ω—ë–Ω –ø—Ä–µ—Å–µ—Ç: {preset['name']}", show_alert=False)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª—å
    await profile_callback(call, None)
```

**–î–æ–±–∞–≤–∏—Ç—å therapist –≤ UI:**

`soul_bot/bot/keyboards/profile.py`:

```python
personality_menu = InlineKeyboardMarkup(inline_keyboard=[
    [InlineKeyboardButton(text='üßô‚Äç‚ôÇÔ∏è –ú—É–¥—Ä—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫', callback_data='personality_mentor')],
    [InlineKeyboardButton(text='üë• –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –¥—Ä—É–≥', callback_data='personality_friend')],
    [InlineKeyboardButton(text='üí™ –°—Ç—Ä–æ–≥–∏–π –∫–æ—É—á', callback_data='personality_coach')],
    [InlineKeyboardButton(text='üßò –¢–µ—Ä–∞–ø–µ–≤—Ç', callback_data='personality_therapist')],  # ‚Üê –ù–û–í–û–ï
    [InlineKeyboardButton(text='‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data='style_settings')]
])
```

**–û–±–Ω–æ–≤–∏—Ç—å openai_service.py:**

```python
# soul_bot/bot/services/openai_service.py:218-221

personality_map = {
    'mentor': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ –ú–£–î–†–´–ô –ù–ê–°–¢–ê–í–ù–ò–ö...',
    'friend': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ë—É–¥—å –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–©–ò–ú –î–†–£–ì–û–ú...',
    'coach': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –î–µ–π—Å—Ç–≤—É–π –∫–∞–∫ –°–¢–†–û–ì–ò–ô –ö–û–£–ß...',
    'therapist': '‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ë—É–¥—å –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ú –¢–ï–†–ê–ü–ï–í–¢–û–ú - –¥–µ–ª–∏–∫–∞—Ç–Ω—ã–π, –±–µ–∑–æ—Ü–µ–Ω–æ—á–Ω—ã–π, —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —á—É–≤—Å—Ç–≤.'  # ‚Üê –ù–û–í–û–ï
}
```

**Impact:** –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è –∑–∞ 1 –∫–ª–∏–∫

---

### 2.3 –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤ –∫–≤–∏–∑–µ ‚è±Ô∏è 30 –º–∏–Ω—É—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å

**–†–µ—à–µ–Ω–∏–µ:**

`soul_bot/bot/services/quiz_service/generator.py`:

```python
def format_question_for_telegram(question: dict, current: int, total: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –¥–ª—è Telegram"""
    
    # –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    progress = current / total
    filled = int(progress * 10)
    bar = "‚ñà" * filled + "‚ñë" * (10 - filled)
    percentage = int(progress * 100)
    
    text = f"""<b>–í–æ–ø—Ä–æ—Å {current} –∏–∑ {total}</b>
{bar} {percentage}%

{question['text']}"""
    
    return text
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–í–æ–ø—Ä–æ—Å 3 –∏–∑ 10
‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 30%

–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ?
```

---

## PHASE 3: –ê–õ–ì–û–†–ò–¢–ú–ò–ß–ï–°–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üî• HIGH)

**Timeline:** 6-8 —á–∞—Å–æ–≤  
**Impact:** Bot intelligence 7.5/10 ‚Üí 9.0/10

### 3.1 Realtime Mood Detector ‚è±Ô∏è 15 –º–∏–Ω—É—Ç (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤ (`realtime_mood_detector.py`)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –°–º. `INTEGRATION_EXAMPLE_REALTIME_MOOD.md`

```python
# soul_bot/bot/services/openai_service.py:366-368

try:
    # üö® STEP 0: –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
    urgent_signal = detect_urgent_emotional_signals(message)
    
    # 1. –°—Ç—Ä–æ–∏–º system prompt
    if should_override_system_prompt(urgent_signal):
        system_prompt = build_emergency_prompt(
            emotion=urgent_signal.emotion,
            base_instructions=_get_base_instructions(assistant_type)
        )
        logger.warning(f"üö® EMERGENCY MODE: {urgent_signal.emotion}")
    else:
        system_prompt = await build_system_prompt(user_id, assistant_type)
```

**Impact:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∫—Ä–∏–∑–∏—Å—ã (9/10)

---

### 3.2 Context Relevance Check ‚è±Ô∏è 1.5 —á–∞—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–∞–∂–µ –∫ factual questions

**–†–µ—à–µ–Ω–∏–µ:**

`soul_bot/bot/services/personalization/engine.py` - –¥–æ–±–∞–≤–∏—Ç—å –ü–ï–†–ï–î line 131:

```python
async def _is_personalization_relevant(user_message: str, primary_pattern: dict) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∫ —Ç–µ–∫—É—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    
    Fast heuristic (< 5ms)
    """
    message_lower = user_message.lower()
    
    # 1. Factual questions ‚Üí skip personalization
    factual_indicators = [
        '–∫–∞–∫–∞—è', '–∫–∞–∫–æ–π', '–∫–∞–∫–æ–µ', '—Å–∫–æ–ª—å–∫–æ', '–∫–æ–≥–¥–∞', '–≥–¥–µ', 
        '–∫—Ç–æ', '—á—Ç–æ —Ç–∞–∫–æ–µ', '–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è', '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º'
    ]
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ question mark + factual indicator
    if '?' in user_message and any(ind in message_lower for ind in factual_indicators):
        # –ù–û: –µ—Å–ª–∏ –µ—Å—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
        emotional_keywords = ['—á—É–≤—Å—Ç–≤—É—é', '–±–æ—é—Å—å', '—Ç—Ä–µ–≤–æ–∂–Ω–æ', '—Å—Ç—Ä–∞—à–Ω–æ', '–≥—Ä—É—Å—Ç–Ω–æ']
        if not any(kw in message_lower for kw in emotional_keywords):
            return False
    
    # 2. Pattern keywords present? ‚Üí relevant
    pattern_tags = primary_pattern.get('tags', [])
    if any(tag.lower() in message_lower for tag in pattern_tags):
        return True
    
    # 3. Emotional content? ‚Üí relevant
    emotional_keywords = ['—á—É–≤—Å—Ç–≤—É—é', '–≥—Ä—É—Å—Ç–Ω–æ', '—Ç—Ä–µ–≤–æ–∂–Ω–æ', '–±–æ—é—Å—å', '–∑–ª—é—Å—å', 
                          '–Ω–µ –º–æ–≥—É', '—Å—Ç—Ä–∞—à–Ω–æ', '—Ç—è–∂–µ–ª–æ', '–±–æ–ª—å–Ω–æ', '–æ–¥–∏–Ω–æ–∫–æ']
    if any(kw in message_lower for kw in emotional_keywords):
        return True
    
    # 4. Very short message (< 5 words) ‚Üí probably not emotional
    if len(user_message.split()) < 5:
        return False
    
    # 5. Default: apply personalization (conservative)
    return True
```

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `build_personalized_response()`:**

```python
async def build_personalized_response(...) -> str:
    # ... existing code ...
    
    primary_pattern = _select_primary_pattern(patterns)
    if not primary_pattern:
        return base_response
    
    # üî• –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
    is_relevant = await _is_personalization_relevant(user_message, primary_pattern)
    
    if not is_relevant:
        logger.debug("[%s] personalization skipped: not relevant", user_id)
        return base_response
    
    # –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    # ...
```

**Impact:** –£—Å—Ç—Ä–∞–Ω—è–µ—Ç –Ω–µ—É–º–µ—Å—Ç–Ω—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é (8/10)

---

### 3.3 Temperature –†–µ–∂–∏–º (auto-–∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∏–ª—è) ‚è±Ô∏è 2 —á–∞—Å–∞

**–ò–¥–µ—è (–æ—Ç –ê–≥–µ–Ω—Ç–∞ 3):** –ê–≤—Ç–æ-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∏–ª—è –ø–æ mood/stress

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

`soul_bot/bot/services/temperature_adapter.py` (–ù–û–í–´–ô –§–ê–ô–õ):

```python
"""
Temperature Adapter - –∞–≤—Ç–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∏–ª—è –ø–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

–õ–æ–≥–∏–∫–∞:
- –ï—Å–ª–∏ stress_level = high ‚Üí brief + supportive
- –ï—Å–ª–∏ mood = energetic ‚Üí motivating + medium
- –ï—Å–ª–∏ mood = slightly_down ‚Üí friendly + empathetic
"""

def adapt_style_to_temperature(profile) -> dict:
    """
    –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    
    Returns:
        {
            'tone_override': Optional[str],
            'length_override': Optional[str],
            'intensity_modifier': float  # 0.5-1.5 (multiplier for temperature)
        }
    """
    emotional_state = profile.emotional_state
    
    stress_level = emotional_state.get('stress_level', 'medium')
    current_mood = emotional_state.get('current_mood', 'neutral')
    energy_level = emotional_state.get('energy_level', 'medium')
    
    overrides = {
        'tone_override': None,
        'length_override': None,
        'intensity_modifier': 1.0
    }
    
    # HIGH STRESS ‚Üí –∫—Ä–∞—Ç–∫–æ—Å—Ç—å + –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    if stress_level == 'high':
        overrides['length_override'] = 'brief'
        overrides['tone_override'] = 'friendly'  # —É–±–∏—Ä–∞–µ–º —Å–∞—Ä–∫–∞–∑–º
        overrides['intensity_modifier'] = 0.7  # —Å–ø–æ–∫–æ–π–Ω–µ–µ
        
    # LOW ENERGY ‚Üí –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
    elif energy_level == 'low':
        overrides['length_override'] = 'brief'
        overrides['intensity_modifier'] = 0.8
        
    # ENERGETIC ‚Üí –º–æ—Ç–∏–≤–∞—Ü–∏—è + –¥—Ä–∞–π–≤
    elif current_mood == 'energetic':
        overrides['tone_override'] = 'motivating'
        overrides['intensity_modifier'] = 1.3  # –±–æ–ª—å—à–µ –¥—Ä–∞–π–≤–∞
        
    # SLIGHTLY_DOWN ‚Üí —ç–º–ø–∞—Ç–∏—è + –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    elif current_mood == 'slightly_down':
        overrides['tone_override'] = 'friendly'
        overrides['length_override'] = 'medium'  # –±–æ–ª—å—à–µ —Å–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        overrides['intensity_modifier'] = 0.9
    
    return overrides
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ openai_service.py:**

```python
# soul_bot/bot/services/openai_service.py

from bot.services.temperature_adapter import adapt_style_to_temperature

async def build_system_prompt(user_id: int, assistant_type: str, ...) -> str:
    profile = await user_profile.get_or_create(user_id)
    
    # üî• –ù–û–í–û–ï: Temperature adaptation
    temp_overrides = adapt_style_to_temperature(profile)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º overrides
    effective_tone = temp_overrides['tone_override'] or profile.tone_style
    effective_length = temp_overrides['length_override'] or profile.message_length
    
    # –°—Ç—Ä–æ–∏–º style instructions —Å —É—á—ë—Ç–æ–º overrides
    style_instructions = _cached_style_instructions(
        effective_tone,
        profile.personality,
        effective_length
    )
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ get_chat_completion():**

```python
# –ü–æ—Å–ª–µ line 385 (ChatCompletion.create):

# –ü—Ä–∏–º–µ–Ω—è–µ–º intensity modifier –∫ temperature
temp_overrides = adapt_style_to_temperature(profile)
effective_temperature = temperature * temp_overrides['intensity_modifier']

response: ChatCompletion = await client.chat.completions.create(
    model=model,
    messages=messages,
    temperature=effective_temperature,  # –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ temperature
    max_tokens=2000
)
```

**Impact:** –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (8/10)

---

### 3.4 –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (merge —Å –ê–≥–µ–Ω—Ç–æ–º 2) ‚è±Ô∏è 2 —á–∞—Å–∞

**–°—Ç–∞—Ç—É—Å:** –ê–≥–µ–Ω—Ç 2 —Å–æ–∑–¥–∞–ª `formatting.py`, –Ω–æ –Ω—É–∂–µ–Ω merge —Å –º–æ–∏–º–∏ –∏–¥–µ—è–º–∏

**–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è:**

`soul_bot/bot/services/formatting.py`:

```python
"""
–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞

–ü—Ä–∞–≤–∏–ª–∞:
- Ultra brief (< 50 words): plain text
- Brief (50-100): minimal formatting (action verbs bold)
- Medium (100-300): structured (headers, lists)
- Detailed (300+): full formatting (sections, highlights)
"""

import re
from typing import Optional

def format_bot_message(
    text: str, 
    message_length_preference: str,
    learning_preferences: Optional[dict] = None
) -> str:
    """
    –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
    
    Args:
        text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        message_length_preference: ultra_brief|brief|medium|detailed
        learning_preferences: –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç/–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    word_count = len(text.split())
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º learning preferences
    if learning_preferences:
        doesnt_work = learning_preferences.get('doesnt_work', [])
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ª—é–±–∏—Ç —Å–ø–∏—Å–∫–∏ ‚Üí –Ω–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Ö
        if '—Å–ø–∏—Å–∫–∏' in doesnt_work or 'bullet points' in doesnt_work:
            return text  # –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        
        # –ï—Å–ª–∏ –Ω–µ –ª—é–±–∏—Ç bold ‚Üí –Ω–µ –≤—ã–¥–µ–ª—è–µ–º
        if '–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç' in doesnt_work or 'bold' in doesnt_work:
            return text
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ
    if word_count < 50:
        return text  # Ultra brief: no formatting
    
    elif word_count < 100:
        return _apply_minimal_formatting(text)
    
    elif word_count < 300:
        return _apply_medium_formatting(text)
    
    else:
        return _apply_detailed_formatting(text)


def _apply_minimal_formatting(text: str) -> str:
    """Brief: –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ action verbs"""
    action_verbs = [
        '–Ω–∞—á–Ω–∏', '—Å–¥–µ–ª–∞–π', '–ø–æ–ø—Ä–æ–±—É–π', '–≤—ã–¥–µ–ª–∏', '–∑–∞–ø–∏—à–∏', 
        '–ø–æ–¥—É–º–∞–π', '–ø—Ä–æ—á–∏—Ç–∞–π', '–Ω–∞–ø–∏—à–∏', '—Å–ø—Ä–æ—Å–∏'
    ]
    
    for verb in action_verbs:
        # –í—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞
        text = re.sub(
            rf'(^|\n)({verb})\b',
            r'\1<b>\2</b>',
            text,
            flags=re.IGNORECASE | re.MULTILINE
        )
    
    return text


def _apply_medium_formatting(text: str) -> str:
    """Medium: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ + —Å–ø–∏—Å–∫–∏"""
    lines = text.split('\n')
    result = []
    
    # 1. –í—ã–¥–µ–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –≤ –Ω–∞—á–∞–ª–µ)
    if lines and ',' in lines[0]:
        parts = lines[0].split(',', 1)
        if len(parts[0].split()) == 1:  # –û–¥–Ω–æ —Å–ª–æ–≤–æ ‚Üí –∏–º—è
            lines[0] = f"<b>{parts[0]}</b>,{parts[1]}"
    
    # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º numbered lists –≤ bullet points
    for line in lines:
        stripped = line.strip()
        
        # Numbered list
        if re.match(r'^\d+\.\s', stripped):
            line = '‚Ä¢ ' + re.sub(r'^\d+\.\s', '', stripped)
        
        # Dash list
        elif stripped.startswith('- '):
            line = '‚Ä¢ ' + stripped[2:]
        
        result.append(line)
    
    # 3. –í—ã–¥–µ–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã
    formatted = '\n'.join(result)
    
    # "–í–∞–∂–Ω–æ:", "–°–æ–≤–µ—Ç:", etc.
    key_phrases = ['–≤–∞–∂–Ω–æ', '—Å–æ–≤–µ—Ç', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è', '–ø–æ–º–Ω–∏', '–æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ']
    for phrase in key_phrases:
        formatted = re.sub(
            rf'\b({phrase})\b:',
            r'<b>\1</b>:',
            formatted,
            flags=re.IGNORECASE
        )
    
    return formatted


def _apply_detailed_formatting(text: str) -> str:
    """Detailed: —Å–µ–∫—Ü–∏–∏ + –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞"""
    
    # 1. Detect sections by keywords
    sections = {
        '–ø–∞—Ç—Ç–µ—Ä–Ω': 'üß†',
        '–∏–Ω—Å–∞–π—Ç': 'üí°',
        '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü': 'üìå',
        '–ø—Ä–∏–º–µ—Ä—ã': 'üìù',
        '—à–∞–≥–∏': 'üî¢',
        '–∏—Ç–æ–≥–æ': '‚úÖ',
        '–≤–∞–∂–Ω–æ': '‚ö†Ô∏è',
        '–ø–æ–º–Ω–∏': 'üéØ'
    }
    
    formatted = text
    
    # –î–æ–±–∞–≤–ª—è–µ–º emojis –∫ —Å–µ–∫—Ü–∏—è–º
    for keyword, emoji in sections.items():
        # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å keyword (case-insensitive)
        formatted = re.sub(
            rf'^({keyword}.*?):\s*',
            rf'<b>{emoji} \1:</b>\n',
            formatted,
            flags=re.IGNORECASE | re.MULTILINE
        )
    
    # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏
    lines = formatted.split('\n')
    result = []
    
    for line in lines:
        stripped = line.strip()
        
        # Numbered list ‚Üí bullet
        if re.match(r'^\d+\.\s', stripped):
            line = '  ‚Ä¢ ' + re.sub(r'^\d+\.\s', '', stripped)
        
        # Dash list ‚Üí bullet
        elif stripped.startswith('- '):
            line = '  ‚Ä¢ ' + stripped[2:]
        
        result.append(line)
    
    # 3. –í—ã–¥–µ–ª—è–µ–º —Ü–∏—Ç–∞—Ç—ã
    formatted = '\n'.join(result)
    
    # "–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '—Ü–∏—Ç–∞—Ç–∞'" ‚Üí italic –¥–ª—è —Ü–∏—Ç–∞—Ç—ã
    formatted = re.sub(
        r"'([^']+)'",
        r"<i>'\1'</i>",
        formatted
    )
    formatted = re.sub(
        r'"([^"]+)"',
        r'<i>"\1"</i>',
        formatted
    )
    
    return formatted
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

```python
# soul_bot/bot/services/openai_service.py:404-406

if profile and profile.message_length:
    assistant_message = _enforce_message_length(assistant_message, profile.message_length)
    
    # üî• –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    from bot.services.formatting import format_bot_message
    assistant_message = format_bot_message(
        text=assistant_message,
        message_length_preference=profile.message_length,
        learning_preferences=profile.learning_preferences
    )
```

**Impact:** –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ +40% (7/10)

---

### 3.5 –£–ª—É—á—à–µ–Ω–∏–µ Adaptive Quiz ‚è±Ô∏è 2.5 —á–∞—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞ 1 (–Ω–∞–π–¥–µ–Ω–∞ –ê–≥–µ–Ω—Ç–æ–º 3):** –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑, –Ω–µ track'–∞–µ—Ç —á—Ç–æ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏

**–†–µ—à–µ–Ω–∏–µ:**

`soul_bot/bot/services/quiz/adaptive_quiz_service.py`:

```python
class AdaptiveQuizService:
    BRANCH_AFTER_QUESTION = 5
    MAX_BRANCHES = 2  # ‚Üê –ù–û–í–û–ï: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–≤–∞–∂–¥—ã
    
    async def should_branch(self, session: QuizSession) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å follow-up –≤–æ–ø—Ä–æ—Å—ã"""
        
        # –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —É–∂–µ branched
        branch_count = getattr(session, 'branch_count', 0)
        
        # –ú–æ–∂–µ–º branch –º–∞–∫—Å–∏–º—É–º 2 —Ä–∞–∑–∞ (–ø–æ—Å–ª–µ Q5 –∏ Q8)
        if branch_count >= self.MAX_BRANCHES:
            return False
        
        # Branch —Ç–æ—á–∫–∏: Q5, Q8
        branch_points = [5, 8]
        if session.current_question_index not in branch_points:
            return False
        
        # –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–∞ —Å –ø—Ä–æ—à–ª–æ–≥–æ branch
        answers_since_last_branch = len(session.answers) - getattr(session, 'last_branch_at', 0)
        if answers_since_last_branch < 3:
            return False
        
        return True
    
    async def get_adaptive_questions(self, session: QuizSession) -> list[dict]:
        """Main method: analyze patterns and generate follow-ups"""
        
        patterns = await self.analyze_patterns(session)
        
        # ... existing logic ...
        
        # üî• –ù–û–í–û–ï: Track —á—Ç–æ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏
        asked_patterns = getattr(session, 'asked_patterns', set())
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏
        new_patterns = [
            p for p in strong_patterns
            if p.get('title') not in asked_patterns
        ]
        
        if not new_patterns:
            logger.info("All patterns already covered")
            return []
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
        top_pattern = new_patterns[0]
        followups = await self.generate_followup_questions(top_pattern, session)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º tracking
        asked_patterns.add(top_pattern.get('title'))
        session.asked_patterns = asked_patterns
        session.branch_count = getattr(session, 'branch_count', 0) + 1
        session.last_branch_at = len(session.answers)
        
        return followups
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–≤–∏–∑—ã

**–†–µ—à–µ–Ω–∏–µ:**

`soul_bot/bot/services/quiz_service/generator.py`:

```python
async def generate_questions(
    category: str,
    count: int = 8,
    user_profile: Optional[dict] = None,
    previous_answers: Optional[list[dict]] = None
) -> list[dict]:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ —Å —É—á—ë—Ç–æ–º –ø—Ä–æ—Ñ–∏–ª—è –∏ –∏—Å—Ç–æ—Ä–∏–∏
    """
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    existing_patterns = []
    if user_profile:
        existing_patterns = user_profile.get('patterns', [])
    
    # üî• –ù–û–í–û–ï: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫–∏–µ —Ç–µ–º—ã —É–∂–µ well-understood
    well_understood_topics = []
    for pattern in existing_patterns:
        if pattern.get('occurrences', 0) > 5 and pattern.get('confidence', 0) > 0.8:
            # –ü–∞—Ç—Ç–µ—Ä–Ω —Ö–æ—Ä–æ—à–æ –ø–æ–Ω—è—Ç–µ–Ω ‚Üí –∏–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            well_understood_topics.extend(pattern.get('tags', []))
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º prompt –¥–ª—è GPT
    context = f"""
Category: {category}
User has {len(existing_patterns)} existing patterns.

Well-understood topics (avoid these): {', '.join(well_understood_topics[:5])}

Weak patterns (validate these):
{_format_weak_patterns(existing_patterns)}

Generate {count} questions that:
1. AVOID well-understood topics
2. EXPLORE gaps in understanding
3. VALIDATE weak patterns (confidence < 0.7)
4. DISCOVER new aspects
"""
    
    # ... existing GPT call ...
```

**Impact:** –ö–≤–∏–∑ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º (8/10)

---

## PHASE 4: –†–ê–°–®–ò–†–ï–ù–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: MEDIUM)

**Timeline:** 8-10 —á–∞—Å–æ–≤  
**Impact:** Nice to have (6-7/10 each)

### 4.1 –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ ‚è±Ô∏è 3 —á–∞—Å–∞

**–ò–¥–µ—è (–æ—Ç –ê–≥–µ–Ω—Ç–∞ 1):** surface ‚Üí behavioral ‚Üí emotional ‚Üí existential

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

`soul_bot/bot/services/pattern_analyzer.py`:

```python
PATTERN_HIERARCHY = {
    'surface': {
        'depth': 1,
        'examples': ['I feel tired', 'Work is busy', 'Weather is bad']
    },
    'behavioral': {
        'depth': 2,
        'examples': ['Procrastination', 'Avoidance', 'Perfectionism']
    },
    'emotional': {
        'depth': 3,
        'examples': ['Fear of failure', 'Imposter syndrome', 'Anxiety']
    },
    'cognitive': {
        'depth': 3,
        'examples': ['Black-white thinking', 'Catastrophizing']
    },
    'existential': {
        'depth': 4,
        'examples': ['Life meaning', 'Purpose', 'Values conflict']
    }
}

async def _analyze_conversation_quick(messages, existing_patterns) -> dict:
    """Quick analysis with hierarchy detection"""
    
    prompt = f"""
Analyze conversation and detect patterns at MULTIPLE DEPTH LEVELS:

HIERARCHY:
1. Surface (depth=1): Observable facts, symptoms
2. Behavioral (depth=2): Repeated actions, habits
3. Emotional (depth=3): Underlying feelings, fears
4. Existential (depth=4): Deep values, life meaning

Current patterns: {existing_patterns}

Return JSON with hierarchy:
{{
  "new_patterns": [
    {{
      "title": "...",
      "type": "behavioral",
      "depth": 2,
      "parent_pattern": "surface_pattern_id",  # if derived from another
      "description": "..."
    }}
  ]
}}
"""
    # ... existing GPT call ...
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ:**

```
üß† –ü–∞—Ç—Ç–µ—Ä–Ω—ã (–∏–µ—Ä–∞—Ä—Ö–∏—è):

üìç Surface:
  ‚Ä¢ –£—Å—Ç–∞–ª–æ—Å—Ç—å (5x)
  
  ‚îî‚îÄ üîÑ Behavioral:
     ‚Ä¢ –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è (8x)
     
     ‚îî‚îÄ üí≠ Emotional:
        ‚Ä¢ –°—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏ (3x)
        
        ‚îî‚îÄ üåü Existential:
           ‚Ä¢ –ü–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞ –≤ —Ä–∞–±–æ—Ç–µ (1x)
```

**Impact:** –ì–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (7/10)

---

### 4.2 –¢–µ–º–ø–æ–≤–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è ‚è±Ô∏è 2.5 —á–∞—Å–∞

**–ò–¥–µ—è (–æ—Ç –ê–≥–µ–Ω—Ç–∞ 1):** –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ response_time, message_length –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

`soul_bot/database/models/user_profile.py` - –¥–æ–±–∞–≤–∏—Ç—å:

```python
# –¢–µ–º–ø –æ–±—â–µ–Ω–∏—è (–¥–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–¥–µ–ª—å)
communication_tempo: Mapped[dict] = mapped_column(
    JSONB,
    default=lambda: {
        "avg_response_time": None,  # seconds
        "avg_message_length": None,  # words
        "conversation_density": "medium",  # sparse|medium|dense
        "preferred_depth": "medium"  # surface|medium|deep
    }
)
```

**–¢—Ä–µ–∫–∏–Ω–≥:**

`soul_bot/bot/services/openai_service.py`:

```python
async def save_conversation(...):
    # ... existing code ...
    
    # üî• Track communication tempo
    await _update_communication_tempo(user_id, user_message, assistant_message)

async def _update_communication_tempo(user_id: int, user_message: str, assistant_message: str):
    """–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–º–ø –æ–±—â–µ–Ω–∏—è"""
    profile = await user_profile.get_or_create(user_id)
    tempo = profile.communication_tempo
    
    # –°—á–∏—Ç–∞–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_words = len(user_message.split())
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É (moving average)
    current_avg = tempo.get('avg_message_length') or user_words
    new_avg = (current_avg * 0.9) + (user_words * 0.1)  # exponential moving average
    tempo['avg_message_length'] = int(new_avg)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º conversation_density
    if new_avg < 10:
        tempo['conversation_density'] = 'sparse'
    elif new_avg < 30:
        tempo['conversation_density'] = 'medium'
    else:
        tempo['conversation_density'] = 'dense'
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    await user_profile.update_tempo(user_id, tempo)
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**

```python
async def build_system_prompt(...):
    # ...
    tempo = profile.communication_tempo
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ ‚Üí –±–æ—Ç –ø–∏—à–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ
    if tempo.get('conversation_density') == 'sparse':
        # Override length to brief
        effective_length = 'brief'
    elif tempo.get('conversation_density') == 'dense':
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª—é–±–∏—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ‚Üí –º–æ–∂–µ–º detailed
        effective_length = 'detailed'
```

**Impact:** –ë–æ—Ç –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ç–µ–º–ø (6/10)

---

### 4.3 Time-based tones ‚è±Ô∏è 1.5 —á–∞—Å–∞

**–ò–¥–µ—è (–æ—Ç –ê–≥–µ–Ω—Ç–∞ 1):** –ù–æ—á—å ‚Üí —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π, —É—Ç—Ä–æ ‚Üí –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

`soul_bot/bot/services/time_adapter.py` (–ù–û–í–´–ô –§–ê–ô–õ):

```python
"""
Time-based tone adaptation
"""
from datetime import datetime
import pytz

def get_time_based_tone_modifier(user_timezone: str = 'Europe/Moscow') -> dict:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
    
    Returns:
        {
            'suggested_tone': Optional[str],
            'energy_modifier': float,  # 0.5-1.5
            'should_be_brief': bool
        }
    """
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å –ø–æ timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    tz = pytz.timezone(user_timezone)
    now = datetime.now(tz)
    hour = now.hour
    
    # Night (22:00-06:00) ‚Üí calming, brief
    if hour >= 22 or hour < 6:
        return {
            'suggested_tone': 'friendly',  # —É–±–∏—Ä–∞–µ–º —Å–∞—Ä–∫–∞–∑–º
            'energy_modifier': 0.6,  # —Å–ø–æ–∫–æ–π–Ω–µ–µ
            'should_be_brief': True
        }
    
    # Morning (06:00-10:00) ‚Üí motivating, energetic
    elif 6 <= hour < 10:
        return {
            'suggested_tone': 'motivating',
            'energy_modifier': 1.3,
            'should_be_brief': False
        }
    
    # Day (10:00-18:00) ‚Üí normal
    elif 10 <= hour < 18:
        return {
            'suggested_tone': None,  # no override
            'energy_modifier': 1.0,
            'should_be_brief': False
        }
    
    # Evening (18:00-22:00) ‚Üí reflective, medium
    else:
        return {
            'suggested_tone': 'friendly',
            'energy_modifier': 0.9,
            'should_be_brief': False
        }
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

```python
# soul_bot/bot/services/openai_service.py

from bot.services.time_adapter import get_time_based_tone_modifier

async def build_system_prompt(...):
    # ...
    
    # üî• Time-based adaptation
    time_modifier = get_time_based_tone_modifier()
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç high stress (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É temperature)
    if not temp_overrides['tone_override']:
        if time_modifier['suggested_tone']:
            effective_tone = time_modifier['suggested_tone']
        
        if time_modifier['should_be_brief']:
            effective_length = 'brief'
```

**Impact:** –ë–æ—Ç –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (6/10)

---

## üìä –ò–¢–û–ì–û–í–´–ô ROADMAP

### Quick Wins (Week 1): 6-8 —á–∞—Å–æ–≤

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | Impact | Priority |
|--------|-------|--------|----------|
| 1.1 Legacy cleanup | 30–º | 6/10 | üî• |
| 1.2 Magic numbers ‚Üí constants | 1—á | 7/10 | üî• |
| 1.3 Cleanup unused fields | 30–º | 5/10 | üî• |
| 1.4 Fix learning_preferences | 20–º | 6/10 | üî• |
| 2.1 Unified style menu | 1—á | 8/10 | üî• |
| 2.2 Quick switch presets | 1.5—á | 7/10 | üî• |
| 2.3 Quiz progress bar | 30–º | 6/10 | MEDIUM |
| 3.1 Realtime mood detector | 15–º | 9/10 | üî•üî•üî• |
| 3.2 Context relevance | 1.5—á | 8/10 | üî• |

**Total Week 1:** ~7.5 —á–∞—Å–æ–≤  
**Result:** 7.5/10 ‚Üí 8.5/10

---

### Main Improvements (Week 2): 6-7 —á–∞—Å–æ–≤

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | Impact | Priority |
|--------|-------|--------|----------|
| 3.3 Temperature —Ä–µ–∂–∏–º | 2—á | 8/10 | üî• |
| 3.4 Adaptive formatting | 2—á | 7/10 | üî• |
| 3.5 Improved adaptive quiz | 2.5—á | 8/10 | MEDIUM |

**Total Week 2:** ~6.5 —á–∞—Å–æ–≤  
**Result:** 8.5/10 ‚Üí 9.0/10

---

### Advanced Features (Week 3-4): 8-10 —á–∞—Å–æ–≤

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | Impact | Priority |
|--------|-------|--------|----------|
| 4.1 Hierarchical patterns | 3—á | 7/10 | LOW |
| 4.2 Tempo adaptation | 2.5—á | 6/10 | LOW |
| 4.3 Time-based tones | 1.5—á | 6/10 | LOW |

**Total Week 3-4:** ~7 —á–∞—Å–æ–≤  
**Result:** 9.0/10 ‚Üí 9.3/10

---

## üéØ PRIORITIES SUMMARY

### MUST DO (Critical Path):

1. **Realtime mood detector** (15–º) - 9/10 impact ‚Üê START HERE
2. **Legacy cleanup** (30–º) - tech debt
3. **Magic numbers fix** (1—á) - code quality
4. **Unified style menu** (1—á) - UX pain point
5. **Context relevance** (1.5—á) - fixes annoying bug
6. **Quick switch presets** (1.5—á) - great UX
7. **Temperature —Ä–µ–∂–∏–º** (2—á) - smart adaptation
8. **Adaptive formatting** (2—á) - readability

**Total:** ~10 —á–∞—Å–æ–≤ ‚Üí –†–µ–π—Ç–∏–Ω–≥ 7.5 ‚Üí 9.0

---

### NICE TO HAVE (Phase 2):

9. Improved adaptive quiz (2.5—á)
10. Quiz progress bar (30–º)
11. learning_preferences fix (20–º)
12. cleanup unused fields (30–º)

---

### FUTURE (Phase 3):

13. Hierarchical patterns (3—á)
14. Tempo adaptation (2.5—á)
15. Time-based tones (1.5—á)

---

## üöÄ QUICK START GUIDE

### Day 1 (2 —á–∞—Å–∞):

```bash
# 1. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å realtime mood detector (15–º)
# –°–º. INTEGRATION_EXAMPLE_REALTIME_MOOD.md

# 2. Legacy cleanup (30–º)
rm soul_bot/config_old.py
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ChatGPT.py (—É–¥–∞–ª–∏—Ç—å lines 59-181)

# 3. Magic numbers ‚Üí constants (1—á)
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å pattern_analyzer.py
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å QUICK_ANALYSIS_FREQUENCY –∏–∑ constants.py

# 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
pytest soul_bot/tests/unit/test_pattern_analyzer.py
```

### Day 2 (3 —á–∞—Å–∞):

```bash
# 5. Unified style menu (1—á)
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å bot/keyboards/profile.py
# –î–æ–±–∞–≤–∏—Ç—å build_style_settings_menu_v2()
# –û–±–Ω–æ–≤–∏—Ç—å handlers –≤ bot/handlers/user/profile.py

# 6. Context relevance check (1.5—á)
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å bot/services/personalization/engine.py
# –î–æ–±–∞–≤–∏—Ç—å _is_personalization_relevant()

# 7. Quick switch presets (1.5—á)
# –î–æ–±–∞–≤–∏—Ç—å STYLE_PRESETS –≤ profile.py
# –î–æ–±–∞–≤–∏—Ç—å therapist –≤ personality_menu
```

### Day 3 (4 —á–∞—Å–∞):

```bash
# 8. Temperature —Ä–µ–∂–∏–º (2—á)
# –°–æ–∑–¥–∞—Ç—å bot/services/temperature_adapter.py
# –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ openai_service.py

# 9. Adaptive formatting (2—á)
# Merge —Å –∫–æ–¥–æ–º –ê–≥–µ–Ω—Ç–∞ 2 (formatting.py)
# –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ openai_service.py
```

**Total:** 3 –¥–Ω—è √ó 3 —á–∞—Å–∞ = 9 —á–∞—Å–æ–≤  
**Result:** Bot 7.5/10 ‚Üí 9.0/10 üéâ

---

## üìù –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ:

- ‚úÖ `soul_bot/bot/services/realtime_mood_detector.py` (–≥–æ—Ç–æ–≤)
- `soul_bot/bot/services/temperature_adapter.py`
- `soul_bot/bot/services/time_adapter.py`
- `soul_bot/bot/services/formatting.py` (merge —Å –≤–µ—Ä—Å–∏–µ–π –ê–≥–µ–Ω—Ç–∞ 2)
- `soul_bot/database/migrations/003_remove_thread_ids.sql`
- `soul_bot/database/migrations/004_cleanup_unused_fields.sql`

### –ò–∑–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ:

- `soul_bot/bot/functions/ChatGPT.py` (—É–¥–∞–ª–∏—Ç—å legacy)
- `soul_bot/bot/services/pattern_analyzer.py` (constants, OrderedDict)
- `soul_bot/bot/services/openai_service.py` (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
- `soul_bot/bot/services/personalization/engine.py` (context relevance)
- `soul_bot/bot/keyboards/profile.py` (unified menu, presets, therapist)
- `soul_bot/bot/handlers/user/profile.py` (–Ω–æ–≤—ã–µ handlers)
- `soul_bot/bot/services/quiz/adaptive_quiz_service.py` (tracking)
- `soul_bot/bot/services/quiz_service/generator.py` (profile-aware)
- `soul_bot/bot/services/constants.py` (–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã)

### –£–¥–∞–ª–∏—Ç—å:

- `soul_bot/config_old.py`
- `webapp_test_bot/` (–≤–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥)
- Markdown –æ—Ç—á—ë—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î –°–¢–ê–†–¢–û–ú

- [ ] –°–¥–µ–ª–∞—Ç—å backup –ë–î
- [ ] –°–¥–µ–ª–∞—Ç—å git branch `feature/unified-improvements`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å realtime_mood_detector.py (—Ç–µ—Å—Ç—ã —É–∂–µ –µ—Å—Ç—å ‚úÖ)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ feature flags –≤–∫–ª—é—á–µ–Ω—ã –≤ .env.test
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

---

## üéì LESSONS LEARNED

**–û—Ç –ê–≥–µ–Ω—Ç–∞ 1 (—Ñ–∏–ª–æ—Å–æ—Ñ):**
- –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ - —Å–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è
- –¢–µ–º–ø–æ–≤–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è - —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è
- –ù–û: —Å–ª–∏—à–∫–æ–º –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã–π scope

**–û—Ç –ê–≥–µ–Ω—Ç–∞ 2 (–ø—Ä–∞–∫—Ç–∏–∫):**
- –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ - –ª—É—á—à–∏–π –≤–∫–ª–∞–¥
- Unified menu - —Å—Ä–∞–∑—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- –ù–û: —É–∑–∫–∏–π —Ñ–æ–∫—É—Å (—Ç–æ–ª—å–∫–æ UI)

**–û—Ç –ê–≥–µ–Ω—Ç–∞ 3 (–∞—É–¥–∏—Ç–æ—Ä):**
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–∞–≥–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–æ–∫ - –ó–û –õ –û–¢–û
- Magic numbers, conversation_metrics - –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏
- Temperature —Ä–µ–∂–∏–º, quick switch - –æ—Ç–ª–∏—á–Ω—ã–µ –∏–¥–µ–∏
- –ù–û: —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π —Ç–æ–Ω –∏–Ω–æ–≥–¥–∞ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç

**–ú–æ–π –≤–∫–ª–∞–¥:**
- Realtime mood detector - —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞
- Context relevance - —Ñ–∏–∫—Å–∏—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É
- Emergency prompts - –º–æ–≥—É—Ç —Å–ø–∞—Å—Ç–∏ –∂–∏–∑–Ω–∏

---

**Prepared by:** Consolidated AI Team  
**Ready to implement:** ‚úÖ YES  
**Total effort:** ~16 —á–∞—Å–æ–≤ (3 weeks)  
**Expected result:** 7.5/10 ‚Üí 9.3/10

