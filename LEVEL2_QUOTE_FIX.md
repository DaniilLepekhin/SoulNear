# üîß FIX: Quote Hallucination (–ë–æ—Ç –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç —Ü–∏—Ç–∞—Ç—ã)

**–î–∞—Ç–∞:** 28 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–¢–∏–ø:** –í–∞—Ä–∏–∞–Ω—Ç –ë (–£–º–µ—Ä–µ–Ω–Ω—ã–π)

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Level 2 –≤—ã—è–≤–ª–µ–Ω–∞ **–∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**:

### –°–∏–º–ø—Ç–æ–º—ã:
–ë–æ—Ç —Ü–∏—Ç–∏—Ä—É–µ—Ç —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã—Ö **–Ω–µ –±—ã–ª–æ –≤ —Ç–µ–∫—É—â–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ**:
- –ë–æ—Ç: *"–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '–í–¥—Ä—É–≥ –æ–ø—è—Ç—å –≤—Å—ë –∏—Å–ø–æ—Ä—á—É?'"* ‚Äî **John –ù–ò–ö–û–ì–î–ê —ç—Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª**
- –ë–æ—Ç: *"–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '–ë–æ—é—Å—å, —á—Ç–æ –≤—ã–π–¥–µ—Ç –ø–ª–æ—Ö–æ'"* ‚Äî **–Ω–µ—Ç —Ç–∞–∫–æ–π —Ñ—Ä–∞–∑—ã –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ**
- –†–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã (*"–Ø –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à"*, *"–ë–æ—é—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–ª–∞–∫–µ"*) ‚Äî **–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è**

### –ü—Ä–∏—á–∏–Ω–∞:
–í —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ–ø–∞–¥–∞—é—Ç:
1. **–°–¢–ê–†–´–ï** —Ü–∏—Ç–∞—Ç—ã –∏–∑ `evidence` (–ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –ë–î –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å–µ—Å—Å–∏–π)
2. **–ù–û–í–´–ï** —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—É—â–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –≤ `history`)

GPT –ø—É—Ç–∞–µ—Ç—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏ –∏ –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ü–∏—Ç–∞—Ç—ã (–∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ —Ç–µ–∫—É—â–µ–º –¥–∏–∞–ª–æ–≥–µ), –ª–∏–±–æ **–ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç** "–ø–æ—Ö–æ–∂–∏–µ".

---

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç –ë (–£–º–µ—Ä–µ–Ω–Ω—ã–π) ‚≠ê

### –ò–¥–µ—è:
–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–µ–∫—Ü–∏—é **"RECENT USER MESSAGES"** —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 5 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + —è–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `build_system_prompt()`:

#### 1. –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è "–ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø"

```python
# –ü–æ—Å–ª–µ —Å–µ–∫—Ü–∏–∏ —Å insights, –ø–µ—Ä–µ–¥ emotional_state:

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
recent_history = await conversation_history.get_context(
    user_id=user_id,
    assistant_type=assistant_type,
    max_messages=10  # 10 messages = ~5 user + 5 assistant
)

# –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ user messages
recent_user_messages = [
    msg['content'] for msg in recent_history 
    if msg['role'] == 'user'
][-5:]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

if recent_user_messages:
    recent_messages_text = "\n".join([
        f"{i+1}. \"{msg}\"" 
        for i, msg in enumerate(recent_user_messages)
    ])
    
    prompt_parts.append(
        f"\n## üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):\n{recent_messages_text}\n\n"
        "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–ï –ü–†–ê–í–ò–õ–û –¶–ò–¢–ò–†–û–í–ê–ù–ò–Ø:\n"
        "1. –ï—Å–ª–∏ —Ü–∏—Ç–∏—Ä—É–µ—à—å - –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ñ—Ä–∞–∑—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è) –∏–ª–∏ –∏–∑ evidence (–ø–∞—Ç—Ç–µ—Ä–Ω—ã)\n"
        "2. –¶–∏—Ç–∞—Ç—ã –∏–∑ evidence - –ø–æ–º–µ—á–∞–π –∫–∞–∫ '–í –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö —Ç—ã –≥–æ–≤–æ—Ä–∏–ª: \"...\"'\n"
        "3. –¶–∏—Ç–∞—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ '–¢—ã –≥–æ–≤–æ—Ä–∏–ª: \"...\"' –∏–ª–∏ '–ü–æ–º–Ω–∏—à—å, —Ç—ã —Å–∫–∞–∑–∞–ª: \"...\"'\n"
        "4. ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–∏—Ç–∞—Ç—ã! –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π –±–µ–∑ –∫–∞–≤—ã—á–µ–∫: '—Ç—ã —É–ø–æ–º–∏–Ω–∞–ª...', '—Ç—ã –≥–æ–≤–æ—Ä–∏–ª –æ...'\n"
        "5. ‚úÖ –•–û–†–û–®–û: '–¢—ã –≥–æ–≤–æ—Ä–∏–ª: \"–Ø –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à –¥–ª—è —ç—Ç–æ–π —Ä–∞–±–æ—Ç—ã\". –≠—Ç–æ —Å–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞.'\n"
        "6. ‚ùå –ü–õ–û–•–û: '–¢—ã –≥–æ–≤–æ—Ä–∏–ª: \"–Ø –±–æ—é—Å—å —á—Ç–æ –º–µ–Ω—è —É–≤–æ–ª—è—Ç\"' (–µ—Å–ª–∏ —ç—Ç–æ–π –¢–û–ß–ù–û–ô —Ñ—Ä–∞–∑—ã –Ω–µ—Ç –≤—ã—à–µ)\n\n"
        "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–æ—Å–ª–∞—Ç—å—Å—è –Ω–∞ –∏–¥–µ—é, –Ω–æ —Ç–æ—á–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ—Å–∫–∞–∑: '—Ç—ã —É–ø–æ–º–∏–Ω–∞–ª —Å—Ç—Ä–∞—Ö —É–≤–æ–ª—å–Ω–µ–Ω–∏—è...'\n"
    )
```

#### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ —Å–µ–∫—Ü–∏–∏ "–ü–∞—Ç—Ç–µ—Ä–Ω—ã"

–¢–µ–ø–µ—Ä—å `evidence` –∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —á–µ—Ç–∫–æ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ **"–ø—Ä–æ—à–ª—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã"**:

```python
"‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–†–ò–ú–ï–†–´ (evidence) –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö. "
"–ö–æ–≥–¥–∞ –¥–∞—ë—à—å —Å–æ–≤–µ—Ç –∏–ª–∏ –∏–Ω—Å–∞–π—Ç, –û–ë–†–ê–©–ê–ô–°–Ø –∫ —ç—Ç–∏–º —Ä–µ–∞–ª—å–Ω—ã–º —Å–∏—Ç—É–∞—Ü–∏—è–º. "
"–ü—Ä–∏–º–µ—Ä—ã –≤—ã—à–µ (evidence) - —ç—Ç–æ —Ü–∏—Ç–∞—Ç—ã –∏–∑ –ü–†–û–®–õ–´–• —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.\n\n"

"üéØ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ EVIDENCE:\n"
"- –≠—Ç–æ —Ñ—Ä–∞–∑—ã –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å–µ—Å—Å–∏–π, –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n"
"- –§–æ—Ä–º–∞—Ç: '–í –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö —Ç—ã –≥–æ–≤–æ—Ä–∏–ª: \"[—Ü–∏—Ç–∞—Ç–∞ –∏–∑ evidence]\". –≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç...'\n"
"- –¶–∏—Ç–∞—Ç—ã –∏–∑ evidence –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–∫–∞–∑–∞—Ç—å –ò–°–¢–û–†–ò–Æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞\n\n"

"‚ùå –ü–õ–û–•–û: '–¢—ã —É–ø–æ–º–∏–Ω–∞–ª –æ —Å—Ç—Ä–∞—Ö–∞—Ö.' (—Å–ª–∏—à–∫–æ–º –æ–±—â–æ)\n"
"‚úÖ –•–û–†–û–®–û: '–†–∞–Ω—å—à–µ —Ç—ã –≥–æ–≤–æ—Ä–∏–ª: \"–≤–¥—Ä—É–≥ –æ–ø—è—Ç—å –≤—Å—ë –∏—Å–ø–æ—Ä—á—É?\". –í–∏–¥–∏—à—å, —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –±—ã–ª.'"
```

---

## ‚úÖ –ü–ª—é—Å—ã —Ä–µ—à–µ–Ω–∏—è:

1. **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ**: –ë–æ—Ç –≤–∏–¥–∏—Ç –æ—Ç–¥–µ–ª—å–Ω–æ "–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π" –∏ "evidence –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ"
2. **–Ø–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞**: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≥–æ–≤–æ—Ä—è—Ç –ö–ê–ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Ü–∏—Ç–∞—Ç
3. **Fallback**: –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã –Ω–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ—Å–∫–∞–∑ (*"—Ç—ã —É–ø–æ–º–∏–Ω–∞–ª..."*)
4. **–ù–µ –ª–æ–º–∞–µ—Ç –ª–æ–≥–∏–∫—É**: –ù–µ –º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
5. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead**: +1 –∑–∞–ø—Ä–æ—Å –∫ –ë–î, –Ω–æ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∫–µ—à–∏—Ä—É—é—Ç—Å—è

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Smoke test:
```python
def test_recent_messages_section_added(self):
    """FIX: –°–µ–∫—Ü–∏—è RECENT USER MESSAGES –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    import os
    service_path = 'bot/services/openai_service.py'
    
    with open(service_path, 'r', encoding='utf-8') as f:
        content = f.read()
        assert '–ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø' in content
        assert '–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è' in content
        assert '–ö–†–ò–¢–ò–ß–ù–û–ï –ü–†–ê–í–ò–õ–û –¶–ò–¢–ò–†–û–í–ê–ù–ò–Ø' in content
        assert '–ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–∏—Ç–∞—Ç—ã' in content
        assert "msg['role'] == 'user'" in content
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Passed

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (TODO)

1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç –ë  
2. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∞–≥–µ–Ω—Ç–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π `brief`  
3. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∞–≥–µ–Ω—Ç–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π `medium`  

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ü–æ—á–µ–º—É –í–∞—Ä–∏–∞–Ω—Ç –ë, –∞ –Ω–µ –ê –∏–ª–∏ –í?

- **–í–∞—Ä–∏–∞–Ω—Ç –ê** (—Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏) ‚Äî GPT –º–æ–∂–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
- **–í–∞—Ä–∏–∞–Ω—Ç –í** (–ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ regex) ‚Äî —Å–ª–æ–∂–Ω–æ, –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
- **–í–∞—Ä–∏–∞–Ω—Ç –ë** ‚Äî –±–∞–ª–∞–Ω—Å –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Å—Ç–æ—Ç—ã ‚≠ê

### Token overhead:

–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è ~100-200 —Ç–æ–∫–µ–Ω–æ–≤ (5 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ ~20-40 —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞–∂–¥–æ–µ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏).  
**–í –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã**, —É—á–∏—Ç—ã–≤–∞—è —á—Ç–æ –º—ã —É–∂–µ —É–¥–∞–ª–∏–ª–∏ embeddings –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `soul_bot/bot/services/openai_service.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `soul_bot/tests/smoke_tests.py` ‚Äî smoke test
- `LEVEL2_TEST_RESULTS_ANALYSIS.md` ‚Äî –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

---

*–¶–∏—Ç–∏—Ä—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–∫–∞–∑–∞–Ω–æ. –≠—Ç–æ –Ω–µ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, —ç—Ç–æ –∏–Ω–∂–µ–Ω–µ—Ä–∏—è.* üéØ


