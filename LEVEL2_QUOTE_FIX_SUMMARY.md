# üéØ Quote Hallucination Fix ‚Äî –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** ~20 –º–∏–Ω—É—Ç  
**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–µ—Ç)

---

## üêõ –ß—Ç–æ –±—ã–ª–æ

–ë–æ—Ç **–ø—Ä–∏–¥—É–º—ã–≤–∞–ª —Ü–∏—Ç–∞—Ç—ã** –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö:
```
‚ùå –ë–æ—Ç: "–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '–í–¥—Ä—É–≥ –æ–ø—è—Ç—å –≤—Å—ë –∏—Å–ø–æ—Ä—á—É?'"
   (John –ù–ò–ö–û–ì–î–ê —ç—Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª)

‚ùå –ë–æ—Ç: "–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '–ë–æ—é—Å—å, —á—Ç–æ –≤—ã–π–¥–µ—Ç –ø–ª–æ—Ö–æ'"
   (–Ω–µ—Ç —Ç–∞–∫–æ–π —Ñ—Ä–∞–∑—ã –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ)
```

**–ü—Ä–∏—á–∏–Ω–∞:** GPT –ø—É—Ç–∞–ª "—Å—Ç–∞—Ä—ã–µ —Ü–∏—Ç–∞—Ç—ã –∏–∑ –ë–î" (evidence) —Å "—Ç–µ–∫—É—â–∏–º –¥–∏–∞–ª–æ–≥–æ–º" (history).

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Å–µ–∫—Ü–∏—è –≤ system prompt:

```
## üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):
1. "–ù–µ –∑–Ω–∞—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –æ–±—Ä–∞—â–∞—é—Å—å... –Ø –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à"
2. "–í—á–µ—Ä–∞ –Ω–∞ –∫–æ–¥-—Ä–µ–≤—å—é –Ω–∞—à–ª–∏ –ø–∞—Ä—É –±–∞–≥–æ–≤"
3. "–ë–æ—é—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–ª–∞–∫–µ, –ø–æ–¥—É–º–∞—é—Ç —á—Ç–æ —è —Ç—É–ø–æ–π"
...

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–ï –ü–†–ê–í–ò–õ–û:
- –¶–∏—Ç–∏—Ä—É–π –¢–û–õ–¨–ö–û –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –∏–∑ evidence (–ø—Ä–æ—à–ª—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
- Evidence –ø–æ–º–µ—á–∞–π: "–í –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö —Ç—ã –≥–æ–≤–æ—Ä–∏–ª..."
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–∏—Ç–∞—Ç—ã!
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–ü–∞—Ç—Ç–µ—Ä–Ω—ã":

–¢–µ–ø–µ—Ä—å `evidence` —á–µ—Ç–∫–æ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ **"–ø—Ä–æ—à–ª—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã"**.

### 3. –î–æ–±–∞–≤–ª–µ–Ω smoke test:

```python
def test_recent_messages_section_added():
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ–∫—Ü–∏—è RECENT MESSAGES –¥–æ–±–∞–≤–ª–µ–Ω–∞"""
    # ...checks...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Passed

---

## üìä –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `soul_bot/bot/services/openai_service.py`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "RECENT USER MESSAGES" (—Å—Ç—Ä–æ–∫–∏ 195-227)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–ü–∞—Ç—Ç–µ—Ä–Ω—ã" (—Å—Ç—Ä–æ–∫–∏ 132-145)
   - **+35 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞**

2. `soul_bot/tests/smoke_tests.py`
   - –î–æ–±–∞–≤–ª–µ–Ω `test_recent_messages_section_added()` (—Å—Ç—Ä–æ–∫–∏ 467-483)
   - **+17 —Å—Ç—Ä–æ–∫**

3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
   - `LEVEL2_QUOTE_FIX.md` ‚Äî –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
   - `LEVEL2_TESTING_NEXT_STEPS.md` ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - `LEVEL2_QUOTE_FIX_SUMMARY.md` ‚Äî —ç—Ç–æ —Ä–µ–∑—é–º–µ

---

## üéØ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞—Ç—å

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç—å –ë–î –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
./scripts/clean_test_db.sh --all
cd soul_bot && ENV=test python bot.py
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏: **brief, sarcastic, mentor**
- 30 —Å–æ–æ–±—â–µ–Ω–∏–π —Å persona "John (imposter syndrome)"

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–∏—Ç–∞—Ç—ã
–î–ª—è –∫–∞–∂–¥–æ–π —Ñ—Ä–∞–∑—ã –≤ –∫–∞–≤—ã—á–∫–∞—Ö –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. –ï—Å—Ç—å –ª–∏ –≤ user messages (—Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥)? ‚úÖ
2. –ï—Å—Ç—å –ª–∏ –≤ evidence (–ø—Ä–æ—à–ª—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)? ‚úÖ
3. –ù–µ—Ç –Ω–∏–≥–¥–µ? ‚ùå **–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø**

**Target:** Accuracy ‚â• 95%

### –®–∞–≥ 4: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî —Ç–µ—Å—Ç –Ω–∞ "medium"
–î–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏.

---

## üí° –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –æ—Ç–≤–µ—Ç—ã (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞):
```
"–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '–Ø –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à –¥–ª—è —ç—Ç–æ–π —Ä–∞–±–æ—Ç—ã'. –°–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞."

"–í –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö —Ç—ã —É–ø–æ–º–∏–Ω–∞–ª —Å—Ç—Ä–∞—Ö, —á—Ç–æ '–≤–¥—Ä—É–≥ –≤—Å—ë –∏—Å–ø–æ—Ä—á—É'. 
 –í–∏–¥–∏—à—å, –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è."

"–¢—ã —É–ø–æ–º–∏–Ω–∞–ª —Å—Ç—Ä–∞—Ö —É–≤–æ–ª—å–Ω–µ–Ω–∏—è ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –∏–º–ø–æ—Å—Ç–µ—Ä—Å–∫–æ–≥–æ —Å–∏–Ω–¥—Ä–æ–º–∞."
```

### ‚ùå –ü–ª–æ—Ö–∏–µ –æ—Ç–≤–µ—Ç—ã (–¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å):
```
"–¢—ã –≥–æ–≤–æ—Ä–∏–ª: '–Ø –±–æ—é—Å—å —á—Ç–æ –º–µ–Ω—è —É–≤–æ–ª—è—Ç –∏–∑-–∑–∞ –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏'."
(–µ—Å–ª–∏ —Ç–∞–∫–æ–π —Ç–æ—á–Ω–æ–π —Ñ—Ä–∞–∑—ã –Ω–µ –±—ã–ª–æ)
```

---

## üîß –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫

### –ï—Å–ª–∏ accuracy < 95% –Ω–∞ brief:

**–ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–∫—Å:**
1. –£–≤–µ–ª–∏—á–∏—Ç—å `recent_user_messages` —Å 5 –¥–æ 10
2. –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –ø—Ä–∏–º–µ—Ä—ã –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
3. –°–¥–µ–ª–∞—Ç—å CAPS –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏: `üö® –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û`

### –ï—Å–ª–∏ accuracy < 95% –Ω–∞ medium:

**–°—Ä–µ–¥–Ω–∏–π —Ñ–∏–∫—Å:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É (–í–∞—Ä–∏–∞–Ω—Ç –í –∏–∑ –∞–Ω–∞–ª–∏–∑–∞)
- Regex validation —Ü–∏—Ç–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ —Ñ–∏–∫—Å–∞ | –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ (target) |
|---------|----------|---------------------|
| Quote Accuracy | ~60-70% | ‚â• 95% |
| Hallucinations | ~30-40% | ‚â§ 5% |
| Pattern occurrences | 1-2 | 3-5 |
| Evidence usage | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ (—Å –º–∞—Ä–∫–µ—Ä–æ–º "–ø—Ä–æ—à–ª–æ–µ") |

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** `LEVEL2_QUOTE_FIX.md`
- **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** `LEVEL2_TESTING_NEXT_STEPS.md`
- **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:** `LEVEL2_TEST_RESULTS_ANALYSIS.md`
- **Smoke tests:** `soul_bot/tests/smoke_tests.py::TestLevel2ContextualExamples`

---

## ‚è±Ô∏è Timeline

- **10:00** ‚Äî –í—ã—è–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ (–∞–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–∞)
- **10:20** ‚Äî –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ñ–∏–∫—Å (–í–∞—Ä–∏–∞–Ω—Ç –ë)
- **10:25** ‚Äî Smoke test passed ‚úÖ
- **10:30** ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ üìù
- **‚è≥ Next** ‚Äî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∞–≥–µ–Ω—Ç–µ

---

*–ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω. –¢–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ. –¢–µ–ø–µ—Ä—å —Ç–≤–æ–π —Ö–æ–¥ ‚Äî –∑–∞–ø—É—Å–∫–∞–π –∞–≥–µ–Ω—Ç–∞ –∏ —Å—á–∏—Ç–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏.* üéØ

**P.S.** –ï—Å–ª–∏ –±–æ—Ç —Å–Ω–æ–≤–∞ –Ω–∞—á–Ω—ë—Ç —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –®–µ–∫—Å–ø–∏—Ä–∞ ‚Äî —É –Ω–∞—Å –µ—Å—Ç—å –ü–ª–∞–Ω –í. –ù–æ —è —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ü–ª–∞–Ω –ë —Å—Ä–∞–±–æ—Ç–∞–µ—Ç. üòè

