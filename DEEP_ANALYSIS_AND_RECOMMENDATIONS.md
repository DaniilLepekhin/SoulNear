# üî¨ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

**–î–∞—Ç–∞:** 31 –æ–∫—Ç—è–±—Ä—è 2025  
**–§–æ–∫—É—Å:** –ü—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥, –∫–≤–∏–∑, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è, UX/UI, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è  
**–°—Ç–∞—Ç—É—Å:** Comprehensive Analysis

---

## üìä Executive Summary

–ü—Ä–æ–≤–µ–¥—ë–Ω –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞:
1. –°–∏—Å—Ç–µ–º—É –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–≤–∏–∑
3. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞
4. UI/UX –∏ —ç—Ä–≥–æ–Ω–æ–º–∏–∫—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
6. –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–æ–¥ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 7.5/10  
**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:** –û—Ç–ª–∏—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å, embeddings –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏  
**–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:** UX –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∏–ª—è, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤, —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç

---

## 1. üß† –°–ò–°–¢–ï–ú–ê –ü–†–û–§–ê–ô–õ–ò–ù–ì–ê –ò –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–ò

### 1.1 –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:**

‚úÖ **Pattern Analyzer** - –∏–∑—è—â–Ω–∞—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:
- Quick analysis (–∫–∞–∂–¥—ã–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è) ‚Üí –ø–∞—Ç—Ç–µ—Ä–Ω—ã + mood
- Deep analysis (–∫–∞–∂–¥—ã–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π) ‚Üí insights + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- Embeddings –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (similarity > 0.9)
- –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π merge: keyword match + semantic similarity

```python
# soul_bot/bot/services/pattern_analyzer.py:274-301
# FACTOR 1: Keyword match (exact title)
# FACTOR 2: Semantic similarity
```

‚úÖ **Moderate —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö** - —Ö–æ—Ä–æ—à–æ –ø—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞:
- Patterns —Å embeddings, evidence, occurrences, confidence
- Insights —Å derived_from, recommendations, priority
- Emotional state —Å –∏—Å—Ç–æ—Ä–∏–µ–π (30 –¥–Ω–µ–π)
- Learning preferences (—á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç/–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

‚úÖ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π system prompt** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞:
- Style instructions (—Ç–æ–Ω, –ª–∏—á–Ω–æ—Å—Ç—å, –¥–ª–∏–Ω–∞)
- User info (–∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª)
- Top-5 patterns —Å evidence
- Top-3 insights —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- Recent messages (last 5) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- Learning preferences

### 1.2 –ü—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

‚ùå **Problem 1: –°–ª–∞–±–∞—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç "–∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å"**

–ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ—Ç–ª–∏—á–Ω–æ –≤—ã—è–≤–ª—è—é—Ç—Å—è, –Ω–æ:
1. –ë–æ—Ç –Ω–µ –≤—Å–µ–≥–¥–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ **—Ç–µ–∫—É—â–µ–µ** —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
2. `emotional_state.current_mood` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π (quick analysis)
3. –ù–æ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –±–æ—Ç –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã

**–ü—Ä–∏–º–µ—Ä:**
```
User: "—É –º–µ–Ω—è –ø–∞–Ω–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å"
Bot: [—á–µ—Ä–µ–∑ general system prompt] "–ü–æ–º–Ω–∏—à—å, —Ç—ã –≥–æ–≤–æ—Ä–∏–ª..." ‚Üê –Ω–µ –ø—Ä–æ —Ç–æ!
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# –î–æ–±–∞–≤–∏—Ç—å: soul_bot/bot/services/realtime_mood_detector.py

async def detect_urgent_emotional_signals(message: str) -> Optional[dict]:
    """
    –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –ë–ï–ó GPT (regex + keywords)
    
    Returns:
        {
            'urgency': 'high|medium',
            'emotion': 'panic|anger|despair|joy',
            'suggested_response_style': 'calm|supportive|celebratory'
        }
    """
    urgent_keywords = {
        'panic': ['–ø–∞–Ω–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞', '–∑–∞–¥—ã—Ö–∞—é—Å—å', '—Å–µ—Ä–¥—Ü–µ –∫–æ–ª–æ—Ç–∏—Ç—Å—è'],
        'despair': ['–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å', '–≤—Å—ë –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ', '–∫–æ–Ω–µ—Ü'],
        'anger': ['–±–µ—Å–∏—Ç', '–Ω–µ–Ω–∞–≤–∏–∂—É', '—É–±–∏—Ç—å –≥–æ—Ç–æ–≤']
    }
    
    # Fast keyword matching (< 1ms)
    for emotion, keywords in urgent_keywords.items():
        if any(kw in message.lower() for kw in keywords):
            return {
                'urgency': 'high',
                'emotion': emotion,
                'suggested_response_style': EMOTION_RESPONSE_MAP[emotion]
            }
    
    return None
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ openai_service.py:**
```python
# –î–æ–±–∞–≤–∏—Ç—å –ü–ï–†–ï–î build_system_prompt()

urgent_signal = await realtime_mood_detector.detect_urgent_emotional_signals(message)

if urgent_signal and urgent_signal['urgency'] == 'high':
    # OVERRIDE —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å—Ç–∏–ª—è
    system_prompt = build_emergency_prompt(
        emotion=urgent_signal['emotion'],
        user_id=user_id,
        base_instructions=base_instructions
    )
else:
    system_prompt = await build_system_prompt(...)
```

---

‚ùå **Problem 2: Pattern evidence "–∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç" –≤ –ø—Ä–æ—à–ª–æ–º**

–°–µ–π—á–∞—Å evidence –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –Ω–æ:
1. –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ "—Å–≤–µ–∂–µ—Å—Ç–∏" —Ü–∏—Ç–∞—Ç
2. GPT –º–æ–∂–µ—Ç —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å evidence 3-–º–µ—Å—è—á–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–Ø —ç—Ç–æ –≥–æ–≤–æ—Ä–∏–ª –î–í–ê –ú–ï–°–Ø–¶–ê –ù–ê–ó–ê–î, —É –º–µ–Ω—è –≤—Å—ë –∏–∑–º–µ–Ω–∏–ª–æ—Å—å!"

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# soul_bot/database/models/user_profile.py

# –î–æ–±–∞–≤–∏—Ç—å –≤ Pattern structure:
"evidence": [
    {
        "quote": "–º–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ –¥–æ–∂–¥—å –∏–¥—ë—Ç",
        "timestamp": "2025-10-20T10:00:00",
        "is_recent": True  # –µ—Å–ª–∏ < 7 –¥–Ω–µ–π
    }
]
```

**–í prompt sections.py:**
```python
def render_patterns_section(profile) -> str:
    # ...
    if evidence:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Å–≤–µ–∂–∏–µ (< 7 –¥–Ω–µ–π) –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2
        recent_evidence = [e for e in evidence if e.get('is_recent')]
        if not recent_evidence:
            recent_evidence = evidence[-2:]  # Fallback: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2
        
        evidence_lines = [
            f'  ‚Ä¢ "{e["quote"]}" ({_days_ago(e["timestamp"])})'
            for e in recent_evidence
        ]
```

---

‚ùå **Problem 3: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ personalization/engine.py —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è**

–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:
```python
# soul_bot/bot/services/personalization/engine.py:131-197

async def build_personalized_response(...):
    # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç: "–¢—ã –ø–∏—Å–∞–ª: '[—Ü–∏—Ç–∞—Ç–∞]' ‚Äî —Ç—ã –ø–æ–≤—Ç–æ—Ä—è–ª —ç—Ç–æ N —Ä–∞–∑..."
    # –î–∞–∂–µ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –±—ã–ª –ø—Ä–æ—Å—Ç–æ–π
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
User: "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è?"
Bot: "–¢—ã –ø–∏—Å–∞–ª: '–æ–ø—è—Ç—å –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∏—Ä—É—é' ‚Äî —Ç—ã –ø–æ–≤—Ç–æ—Ä—è–ª —ç—Ç–æ 5 —Ä–∞–∑. –≠—Ç–æ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏. –°–¥–µ–ª–∞–π —à–∞–≥: –≤—ã–¥–µ–ª–∏ 5 –º–∏–Ω—É—Ç..."
User: "???"
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å **context relevance check**:

```python
async def build_personalized_response(...) -> str:
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    is_relevant = await _is_personalization_relevant(
        user_message=user_message,
        primary_pattern=primary_pattern
    )
    
    if not is_relevant:
        logger.debug("Skipping personalization: not relevant to current message")
        return base_response
    
    # 2. –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ç–∞—Ç—ã
    # ...

async def _is_personalization_relevant(user_message: str, primary_pattern: dict) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∫ —Ç–µ–∫—É—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    
    Fast heuristic (< 5ms):
    - Factual questions ‚Üí False ("–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç")
    - Emotional content ‚Üí True ("–≥—Ä—É—Å—Ç–Ω–æ", "–Ω–µ –º–æ–≥—É")
    - Pattern keywords in message ‚Üí True
    """
    # Factual question indicators
    factual_indicators = ['–∫–∞–∫–∞—è', '–∫–∞–∫–æ–π', '—Å–∫–æ–ª—å–∫–æ', '–∫–æ–≥–¥–∞', '–≥–¥–µ', '–∫—Ç–æ']
    if any(indicator in user_message.lower() for indicator in factual_indicators):
        return False
    
    # Pattern keywords present?
    pattern_tags = primary_pattern.get('tags', [])
    if any(tag.lower() in user_message.lower() for tag in pattern_tags):
        return True
    
    # Emotional content?
    emotional_keywords = ['—á—É–≤—Å—Ç–≤—É—é', '–≥—Ä—É—Å—Ç–Ω–æ', '—Ç—Ä–µ–≤–æ–∂–Ω–æ', '–±–æ—é—Å—å', '–∑–ª—é—Å—å']
    if any(kw in user_message.lower() for kw in emotional_keywords):
        return True
    
    return False
```

---

### 1.3 –û—Ü–µ–Ω–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 7/10

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ | 9/10 | –û—Ç–ª–∏—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (quick + deep analysis) |
| –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è | 9/10 | Embeddings —Ä–∞–±–æ—Ç–∞—é—Ç –∏–¥–µ–∞–ª—å–Ω–æ |
| –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | 8/10 | Moderate structure —É–¥–æ–±–Ω–∞ |
| –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–∞—Ö | 5/10 | –°–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ, –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç |
| –†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ "—Å–µ–π—á–∞—Å" | 4/10 | –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã |
| Freshness evidence | 3/10 | –¶–∏—Ç–∞—Ç—ã —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç, –Ω–µ—Ç TTL |

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:** 9/10

---

## 2. üß© –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –ö–í–ò–ó

### 2.1 –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:**

‚úÖ **Adaptive Quiz Service** - —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- Pattern analysis –ø–æ—Å–ª–µ Q5 (midpoint)
- Confidence threshold 0.7 –¥–ª—è branching
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 5 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí –≤—ã–±–æ—Ä top-3 –ø–æ quality_score
- Seamless injection –≤ quiz flow

```python
# soul_bot/bot/services/quiz/adaptive_quiz_service.py:42-66

async def should_branch(self, session: QuizSession) -> bool:
    # Only branch once at midpoint
    if session.current_question_index != self.BRANCH_AFTER_QUESTION:
        return False
```

‚úÖ **Quiz Generator** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:
- 8 –±–∞–∑–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ + 2-3 –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö = 10-11 total
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ user_profile –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–≥–æ—Ç–æ–≤–æ, –Ω–æ –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

‚úÖ **Quiz Flow** - —á–∏—Å—Ç–∞—è FSM –ª–æ–≥–∏–∫–∞:
- State: `QuizStates.waiting_for_answer`
- Resume/cancel support
- Progress tracking

### 2.2 –ü—Ä–æ–±–ª–µ–º—ã –∏ –∑–æ–Ω—ã —Ä–æ—Å—Ç–∞

‚ùå **Problem 1: –í–æ–ø—Ä–æ—Å—ã —Å–ª–∏—à–∫–æ–º "–æ–±—â–∏–µ" –Ω–∞ —Å—Ç–∞—Ä—Ç–µ**

–ö–≤–∏–∑ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8 –±–∞–∑–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ë–ï–ó —É—á—ë—Ç–∞:
1. –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–≤–∏–∑–æ–≤
3. Emotional state

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# soul_bot/bot/services/quiz_service/generator.py

async def generate_questions(
    category: str,
    count: int = 8,
    user_profile: Optional[dict] = None,  # üî• –£–ñ–ï –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä!
    previous_answers: Optional[list[dict]] = None
) -> list[dict]:
    """
    üî• UPGRADE: –ò—Å–ø–æ–ª—å–∑—É–µ–º user_profile –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
    """
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    existing_patterns = user_profile.get('patterns', []) if user_profile else []
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è GPT
    context = f"""
User has {len(existing_patterns)} existing patterns:
{_format_patterns_for_context(existing_patterns[:3])}

Generate {count} questions that:
1. AVOID topics already well-understood (patterns with occurrences > 5)
2. EXPLORE gaps in understanding
3. VALIDATE weak patterns (confidence < 0.7)
"""
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ GPT
    # ...
```

---

‚ùå **Problem 2: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã "–æ—Ç—Ä—ã–≤–∞—é—Ç—Å—è" –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ flow**

–ü–æ—Å–ª–µ Q5 –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è follow-up –≤–æ–ø—Ä–æ—Å—ã, –Ω–æ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç: "üí° –î–æ–±–∞–≤–ª—è—é 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞..."
2. –ù–æ **–Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∑–∞—á–µ–º** –∏ **—á—Ç–æ –∏–º–µ–Ω–Ω–æ** –±—É–¥–µ—Ç —É—Ç–æ—á–Ω—è—Ç—å—Å—è
3. Transparency –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# soul_bot/bot/handlers/user/quiz.py:205-209

# –ë–´–õ–û:
await call.message.answer(
    "üí° –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã!\n"
    f"–î–æ–±–∞–≤–ª—è—é {len(followup_questions)} —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞...",
    parse_mode='HTML'
)

# –°–¢–ê–õ–û:
pattern_title = followup_questions[0].get('trigger_pattern', '–ø–∞—Ç—Ç–µ—Ä–Ω')
await call.message.answer(
    f"üí° <b>–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω:</b> {pattern_title}\n\n"
    f"–•–æ—á—É —É—Ç–æ—á–Ω–∏—Ç—å {len(followup_questions)} –¥–µ—Ç–∞–ª–µ–π, —á—Ç–æ–±—ã –ª—É—á—à–µ —Ç–µ–±—è –ø–æ–Ω—è—Ç—å.\n"
    f"–≠—Ç–æ –∑–∞–π–º—ë—Ç –µ—â—ë ~2 –º–∏–Ω—É—Ç—ã üïê",
    parse_mode='HTML'
)
```

---

‚ùå **Problem 3: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞ - "wall of text"**

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–∏–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫:
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ò–Ω—Å–∞–π—Ç—ã

–í—Å—ë –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Üí overwhelm.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–†–∞–∑–±–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ **–ø–æ—ç—Ç–∞–ø–Ω—É—é** –ø–æ–¥–∞—á—É:

```python
# soul_bot/bot/services/quiz_service/analyzer.py

async def format_results_for_telegram(results: dict, user_id: int) -> list[str]:
    """
    üî• UPGRADE: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –°–ü–ò–°–û–ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    
    Returns:
        [
            "1Ô∏è‚É£ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã 3 –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞...",
            "2Ô∏è‚É£ –ò–Ω—Å–∞–π—Ç #1: Imposter Syndrome...",
            "3Ô∏è‚É£ –ò–Ω—Å–∞–π—Ç #2: ...",
            "4Ô∏è‚É£ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏..."
        ]
    """
    messages = []
    
    # Message 1: Overview
    messages.append(_format_overview(results))
    
    # Messages 2-4: Top patterns (–ø–æ –æ–¥–Ω–æ–º—É)
    for pattern in results['patterns'][:3]:
        messages.append(_format_pattern_card(pattern))
    
    # Message 5: Recommendations
    messages.append(_format_recommendations(results))
    
    return messages
```

**–í quiz.py:**
```python
async def _finish_quiz(...):
    # ...
    formatted_messages = await analyzer.format_results_for_telegram(results, user_id)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 2 —Å–µ–∫—É–Ω–¥—ã (—á–∏—Ç–∞–µ–º–æ—Å—Ç—å)
    for msg in formatted_messages:
        await message.answer(msg, parse_mode='HTML')
        await asyncio.sleep(2)
```

---

### 2.3 –û—Ü–µ–Ω–∫–∞ –∫–≤–∏–∑–∞

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 7.5/10

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (branching) | 9/10 | –û—Ç–ª–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç smooth |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ | 6/10 | –ë–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç –ø—Ä–æ—Ñ–∏–ª—å |
| UX –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è | 7/10 | FSM —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ |
| Transparency | 5/10 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç "–∑–∞—á–µ–º?" |
| –†–µ–∑—É–ª—å—Ç–∞—Ç—ã | 6/10 | Wall of text, –Ω–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:** 9.5/10

---

## 3. üé® UX/UI –ò –≠–†–ì–û–ù–û–ú–ò–ö–ê

### 3.1 –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

‚ùå **Problem 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è —Ç—Ä–µ–±—É—é—Ç 3-4 —Ç–∞–ø–∞**

–¢–µ–∫—É—â–∏–π flow:
```
/profile ‚Üí ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è ‚Üí üé≠ –ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ–Ω ‚Üí üòä –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π ‚Üí ‚Ü©Ô∏è –ù–∞–∑–∞–¥ ‚Üí ‚Ü©Ô∏è –ù–∞–∑–∞–¥
```

**–ú–∏–Ω–∏–º—É–º 5 —Ç–∞–ø–æ–≤** –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è!

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å—ë –≤ **–æ–¥–Ω–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é**:

```python
# soul_bot/bot/keyboards/profile.py

# –ù–û–í–ê–Ø –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:
style_settings_unified = InlineKeyboardMarkup(inline_keyboard=[
    [
        InlineKeyboardButton(text='üé©', callback_data='tone_formal'),
        InlineKeyboardButton(text='üòä', callback_data='tone_friendly'),
        InlineKeyboardButton(text='üòè', callback_data='tone_sarcastic'),
        InlineKeyboardButton(text='üî•', callback_data='tone_motivating'),
    ],
    [
        InlineKeyboardButton(text='üßô –ù–∞—Å—Ç–∞–≤–Ω–∏–∫', callback_data='personality_mentor'),
        InlineKeyboardButton(text='üë• –î—Ä—É–≥', callback_data='personality_friend'),
        InlineKeyboardButton(text='üí™ –ö–æ—É—á', callback_data='personality_coach'),
    ],
    [
        InlineKeyboardButton(text='‚ö°‚ö°', callback_data='length_ultra_brief'),
        InlineKeyboardButton(text='‚ö°', callback_data='length_brief'),
        InlineKeyboardButton(text='üìù', callback_data='length_medium'),
        InlineKeyboardButton(text='üìö', callback_data='length_detailed'),
    ],
    [InlineKeyboardButton(text='‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data='profile')]
])
```

**–° live preview:**
```python
@dp.callback_query(F.data.startswith('tone_'))
async def update_tone_inline(call: CallbackQuery):
    tone = call.data.replace('tone_', '')
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
    await db_user_profile.update_style(call.from_user.id, tone_style=tone)
    
    # –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –¥—Ä—É–≥–æ–π —ç–∫—Ä–∞–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    profile = await db_user_profile.get(call.from_user.id)
    
    await call.message.edit_text(
        text=_render_style_settings_text(profile),  # ‚Üê –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        reply_markup=style_settings_unified
    )
    
    await call.answer("‚úÖ –¢–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω", show_alert=False)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 1 —Ç–∞–ø –≤–º–µ—Å—Ç–æ 5!

---

‚ùå **Problem 2: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–æ**

```python
# soul_bot/bot/keyboards/start.py:7-18

menu = InlineKeyboardMarkup(inline_keyboard=[
    [InlineKeyboardButton(text='üí¨ –ß–∞—Ç —Å SOUL.near GPT', callback_data='support')],
    [InlineKeyboardButton(text='üë§ –ê–Ω–∞–ª–∏–∑ –ª–∏—á–Ω–æ—Å—Ç–∏', callback_data='analysis')],
    [InlineKeyboardButton(text='üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–≤–∏–∑', callback_data='quiz_start')],
    [InlineKeyboardButton(text='üí§ –°–Ω—ã', callback_data='soulsleep')],
    [InlineKeyboardButton(text='üßò –ü—Ä–∞–∫—Ç–∏–∫–∏', ...), InlineKeyboardButton(text='üóù –í–∏–¥–µ–æ', ...)],
    [InlineKeyboardButton(text='‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å', callback_data='profile')],
    [InlineKeyboardButton(text='‚ùì FAQ', url='...')],
])
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. 7 –ø—É–Ω–∫—Ç–æ–≤ ‚Üí cognitive overload
2. "–ü—Ä–∞–∫—Ç–∏–∫–∏" + "–í–∏–¥–µ–æ" –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ ‚Üí –ª–µ–≥–∫–æ –ø—Ä–æ–º–∞—Ö–Ω—É—Ç—å—Å—è
3. –ù–µ–ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ **–≥–ª–∞–≤–Ω–æ–µ**, –∞ —á—Ç–æ –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:

```python
menu_v2 = InlineKeyboardMarkup(inline_keyboard=[
    # üî• PRIMARY: –¢–æ, –∑–∞—á–µ–º –ø—Ä–∏—à—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    [InlineKeyboardButton(text='üí¨ –ß–∞—Ç —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º', callback_data='support')],
    [InlineKeyboardButton(text='üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–≤–∏–∑', callback_data='quiz_start')],
    
    # üéØ SECONDARY: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    [
        InlineKeyboardButton(text='üë§ –ê–Ω–∞–ª–∏–∑', callback_data='analysis'),
        InlineKeyboardButton(text='üí§ –°–Ω—ã', callback_data='soulsleep')
    ],
    
    # üìö RESOURCES: –ö–æ–Ω—Ç–µ–Ω—Ç
    [InlineKeyboardButton(text='üìö –ü—Ä–∞–∫—Ç–∏–∫–∏ –∏ –≤–∏–¥–µ–æ', callback_data='media_hub')],
    
    # ‚öôÔ∏è SETTINGS
    [
        InlineKeyboardButton(text='‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å', callback_data='profile'),
        InlineKeyboardButton(text='‚ùì –ü–æ–º–æ—â—å', url='...')
    ]
])
```

**–í–∏–∑—É–∞–ª—å–Ω–æ:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí¨ –ß–∞—Ç —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º     ‚îÇ  ‚Üê PRIMARY (focus)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–≤–∏–∑ ‚îÇ  ‚Üê PRIMARY
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üë§ –ê–Ω–∞–ª–∏–∑  ‚îÇ  üí§ –°–Ω—ã   ‚îÇ  ‚Üê SECONDARY (compact)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìö –ü—Ä–∞–∫—Ç–∏–∫–∏ –∏ –≤–∏–¥–µ–æ     ‚îÇ  ‚Üê RESOURCES
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å ‚îÇ  ‚ùì –ü–æ–º–æ—â—å ‚îÇ  ‚Üê SETTINGS
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

‚ùå **Problem 3: –ö–≤–∏–∑ - –Ω–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**

–í–æ –≤—Ä–µ–º—è –∫–≤–∏–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
```
‚ùì –í–æ–ø—Ä–æ—Å 3 –∏–∑ 10

–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ?
```

–ù–æ **–Ω–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞**.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# soul_bot/bot/services/quiz_service/generator.py

def format_question_for_telegram(
    question: dict,
    current: int,
    total: int
) -> str:
    # –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    progress = current / total
    filled = int(progress * 10)
    bar = "‚ñà" * filled + "‚ñë" * (10 - filled)
    
    text = f"""
<b>–í–æ–ø—Ä–æ—Å {current} –∏–∑ {total}</b>
{bar} {int(progress * 100)}%

{question['text']}
"""
    return text
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–í–æ–ø—Ä–æ—Å 3 –∏–∑ 10
‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 30%

–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ?
```

---

### 3.2 –û—Ü–µ–Ω–∫–∞ UI/UX

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 6/10

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é | 5/10 | –ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–æ, –Ω–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è | 4/10 | –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç–∞–ø–æ–≤ (5 –≤–º–µ—Å—Ç–æ 1) |
| –ö–≤–∏–∑ UI | 6/10 | –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ |
| Feedback | 7/10 | –ï—Å—Ç—å "‚úÖ –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω" |
| Consistency | 8/10 | –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä |

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:** 9/10

---

## 4. üí¨ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –û–¢–í–ï–¢–û–í

### 4.1 –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ **–Ω–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è** –∫ –¥–ª–∏–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

```python
# –°–µ–π—á–∞—Å parse_mode='HTML' –≤–µ–∑–¥–µ, –Ω–æ:

# –ö–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
"–û–∫–µ–π üëç"  # ‚Üê –Ω–µ –Ω—É–∂–Ω—ã bold/italic

# –î–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (300+ —Å–ª–æ–≤):
"–ê–ª–µ–∫—Å–µ–π, —Ç–≤–æ–π —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–¥ –Ω–µ—É–¥–∞—á–µ–π ‚Äî —ç—Ç–æ –∫–∞–∫ —Ç–µ–Ω—å..."  # ‚Üê –Ω—É–∂–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞!
```

### 4.2 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–ü—Ä–∞–≤–∏–ª–æ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

```python
# soul_bot/bot/services/formatting_service.py (–ù–û–í–´–ô –§–ê–ô–õ)

def format_bot_message(text: str, message_length_preference: str) -> str:
    """
    –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã
    
    Rules:
    - Ultra brief (< 50 words): NO formatting
    - Brief (50-80 words): Minimal bold for key points
    - Medium (200-300 words): Bold + lists + structure
    - Detailed (400-600 words): Full formatting + sections
    """
    word_count = len(text.split())
    
    if word_count < 50:
        # Ultra brief: –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        return text
    
    elif word_count < 100:
        # Brief: —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ bold
        return _apply_minimal_formatting(text)
    
    elif word_count < 300:
        # Medium: bold + —Å–ø–∏—Å–∫–∏
        return _apply_medium_formatting(text)
    
    else:
        # Detailed: –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
        return _apply_detailed_formatting(text)


def _apply_minimal_formatting(text: str) -> str:
    """
    Brief: –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ –°–ê–ú–´–ï –≤–∞–∂–Ω—ã–µ —Å–ª–æ–≤–∞
    
    Example:
    "–°—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏ ‚Äî —Ç–≤–æ—è —Ç–µ–Ω—å. –ù–∞—á–Ω–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å."
    ‚Üí
    "–°—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏ ‚Äî —Ç–≤–æ—è —Ç–µ–Ω—å. –ù–∞—á–Ω–∏ <b>–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</b>."
    """
    # –í—ã–¥–µ–ª—è–µ–º action verbs
    action_verbs = ['–Ω–∞—á–Ω–∏', '—Å–¥–µ–ª–∞–π', '–ø–æ–ø—Ä–æ–±—É–π', '–≤—ã–¥–µ–ª–∏', '–∑–∞–ø–∏—à–∏']
    
    for verb in action_verbs:
        text = text.replace(f' {verb} ', f' <b>{verb}</b> ')
    
    return text


def _apply_medium_formatting(text: str) -> str:
    """
    Medium: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ + —Å–ø–∏—Å–∫–∏
    
    Example:
    "–ê–ª–µ–∫—Å–µ–π, —Ç–≤–æ–π —Å—Ç—Ä–∞—Ö... –í–æ—Ç 3 —à–∞–≥–∞: 1. –®–∞–≥ 1 2. –®–∞–≥ 2 3. –®–∞–≥ 3"
    ‚Üí
    "<b>–ê–ª–µ–∫—Å–µ–π</b>, —Ç–≤–æ–π —Å—Ç—Ä–∞—Ö...
    
    –í–æ—Ç 3 —à–∞–≥–∞:
    ‚Ä¢ –®–∞–≥ 1
    ‚Ä¢ –®–∞–≥ 2
    ‚Ä¢ –®–∞–≥ 3"
    """
    # 1. –í—ã–¥–µ–ª—è–µ–º –∏–º—è (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ)
    lines = text.split('\n')
    if lines[0].strip().endswith(','):
        name = lines[0].strip()[:-1]
        lines[0] = f"<b>{name}</b>,"
    
    # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º numbered lists –≤ bullet points
    for i, line in enumerate(lines):
        if re.match(r'^\d+\.\s', line):
            lines[i] = '‚Ä¢ ' + re.sub(r'^\d+\.\s', '', line)
    
    return '\n'.join(lines)


def _apply_detailed_formatting(text: str) -> str:
    """
    Detailed: –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —Å–µ–∫—Ü–∏—è–º–∏
    
    Example:
    "–ë–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç –ø—Ä–æ –ø–∞—Ç—Ç–µ—Ä–Ω... –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: ..."
    ‚Üí
    "<b>üß† –ü–∞—Ç—Ç–µ—Ä–Ω:</b>
    –ë–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç...
    
    <b>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
    ‚Ä¢ –†–µ–∫ 1
    ‚Ä¢ –†–µ–∫ 2"
    """
    # Detect sections by keywords
    sections = {
        '–ø–∞—Ç—Ç–µ—Ä–Ω': 'üß†',
        '–∏–Ω—Å–∞–π—Ç': 'üí°',
        '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü': 'üìå',
        '–ø—Ä–∏–º–µ—Ä—ã': 'üìù',
        '—à–∞–≥–∏': 'üî¢'
    }
    
    formatted = text
    for keyword, emoji in sections.items():
        # Find lines starting with keyword
        formatted = re.sub(
            rf'^({keyword}.*?):\s*',
            rf'<b>{emoji} \1:</b>\n',
            formatted,
            flags=re.IGNORECASE | re.MULTILINE
        )
    
    return formatted
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
# soul_bot/bot/services/openai_service.py:404-405

if profile and profile.message_length:
    assistant_message = _enforce_message_length(assistant_message, profile.message_length)
    
    # üî• –ù–û–í–û–ï: –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    from bot.services.formatting_service import format_bot_message
    assistant_message = format_bot_message(assistant_message, profile.message_length)
```

---

### 4.3 –û—Ü–µ–Ω–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 5/10

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å | 3/10 | –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏–Ω |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å | 6/10 | –ï—Å—Ç—å, –Ω–æ –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å | 7/10 | –í —Ü–µ–ª–æ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ |
| –≠–º–æ–¥–∑–∏ | 8/10 | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —É–º–µ—Å—Ç–Ω–æ |

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:** 9/10

---

## 5. üóëÔ∏è –£–°–¢–ê–†–ï–í–®–ò–ô –ö–û–î –ò –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –î–û–õ–ì

### 5.1 Legacy Assistant API

**–§–∞–π–ª:** `soul_bot/bot/functions/ChatGPT.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# Lines 59-63: DEPRECATED –∫–æ–¥

if is_feature_enabled('USE_CHAT_COMPLETION'):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π API
else:
    # ‚ö†Ô∏è LEGACY: Assistant API (DEPRECATED)
    logging.warning("‚ö†Ô∏è Using deprecated Assistant API...")
```

**–§–∞–∫—Ç—ã:**
- Legacy –∫–æ–¥ –∑–∞–Ω–∏–º–∞–µ—Ç 60% —Ñ–∞–π–ª–∞ (148 —Å—Ç—Ä–æ–∫)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π thread-based API
- –°–ª–æ–∂–Ω–∞—è retry –ª–æ–≥–∏–∫–∞ (5 attempts)
- –•—Ä–∞–Ω–∏—Ç thread_id –≤ –ë–î (–∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```bash
# 1. –£–¥–∞–ª–∏—Ç—å legacy –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é
# soul_bot/bot/functions/ChatGPT.py

async def get_assistant_response(...):
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ ChatCompletion API
    """
    # –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫ —Å if is_feature_enabled('USE_CHAT_COMPLETION')
    # –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ:
    return await openai_service.get_chat_completion(...)

# 2. –£–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é new_context() (lines 150-181)
# 3. –£–¥–∞–ª–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é thread_id –∏–∑ –ë–î:
#    - user.helper_thread_id
#    - user.sleeper_thread_id
#    - user.assistant_thread_id

# 4. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
# soul_bot/database/migrations/003_remove_thread_ids.sql

ALTER TABLE users DROP COLUMN IF EXISTS helper_thread_id;
ALTER TABLE users DROP COLUMN IF EXISTS sleeper_thread_id;
ALTER TABLE users DROP COLUMN IF EXISTS assistant_thread_id;
```

**–≠–∫–æ–Ω–æ–º–∏—è:**
- ~150 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- ~3 –∫–æ–ª–æ–Ω–∫–∏ –≤ –ë–î (VARCHAR 255 –∫–∞–∂–¥–∞—è)
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏

---

### 5.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ handlers

```bash
grep -r "parse_mode='HTML'" soul_bot/bot/handlers | wc -l
# ‚Üí 30 files
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–°–æ–∑–¥–∞—Ç—å **wrapper** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:

```python
# soul_bot/bot/utils/message_helpers.py (–ù–û–í–´–ô –§–ê–ô–õ)

from aiogram.types import Message, CallbackQuery

async def send_formatted(
    target: Message | CallbackQuery,
    text: str,
    reply_markup=None,
    auto_format: bool = True
):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    
    Args:
        target: Message –∏–ª–∏ CallbackQuery
        text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        reply_markup: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        auto_format: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (True –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    """
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    if auto_format:
        from bot.services.formatting_service import format_bot_message
        text = format_bot_message(text, message_length_preference='medium')
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏
    if isinstance(target, CallbackQuery):
        await target.message.answer(text, reply_markup=reply_markup, parse_mode='HTML')
    else:
        await target.answer(text, reply_markup=reply_markup, parse_mode='HTML')
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –ë–´–õ–û:
await message.answer(text=..., parse_mode='HTML', reply_markup=...)

# –°–¢–ê–õ–û:
from bot.utils.message_helpers import send_formatted
await send_formatted(message, text=..., reply_markup=...)
```

---

### 5.3 config_old.py

**–§–∞–π–ª:** `soul_bot/config_old.py` (—É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ grep —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
grep -r "config_old" soul_bot/

# 2. –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —É–¥–∞–ª–∏—Ç—å:
rm soul_bot/config_old.py
```

---

### 5.4 –û—Ü–µ–Ω–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 6/10

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| Legacy –∫–æ–¥ | 4/10 | Assistant API deprecated, –Ω–æ –Ω–µ —É–¥–∞–ª—ë–Ω |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | 6/10 | parse_mode='HTML' –≤–µ–∑–¥–µ |
| Dead code | 7/10 | –ù–µ–º–Ω–æ–≥–æ (config_old.py?) |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 7/10 | Docstrings –µ—Å—Ç—å, –Ω–æ –Ω–µ–ø–æ–ª–Ω—ã–µ |

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏:** 9/10

---

## 6. üöÄ –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò (–ò–î–ï–ò)

### 6.1 "–£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏" –≤ —á–∞—Ç–µ

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–ë–æ—Ç –≤–∏–¥–∏—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–∑–∞—Å—Ç—Ä—è–ª** (–¥–æ–ª–≥–æ –ø–µ—á–∞—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º —Å—Ç–∏—Ä–∞–µ—Ç):

```python
# soul_bot/bot/middlewares/typing_detector.py (–ù–û–í–´–ô)

class TypingDetectorMiddleware(BaseMiddleware):
    """
    –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç typing actions –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–º–æ—â—å
    """
    
    async def __call__(self, handler, event, data):
        if event.type == 'typing':
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç...
            user_id = event.from_user.id
            
            # –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è
            typing_start = time.time()
            
            # –ï—Å–ª–∏ –ø–µ—á–∞—Ç–∞–µ—Ç > 30 —Å–µ–∫—É–Ω–¥ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–º–æ—â—å
            await asyncio.sleep(30)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–∫ –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª
            recent_messages = await conversation_history.get_context(
                user_id=user_id,
                assistant_type='helper',
                max_messages=1
            )
            
            if not recent_messages or (time.time() - typing_start) > 30:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                await bot.send_message(
                    chat_id=user_id,
                    text=(
                        "–í–∏–∂—É, —Ç—ã –∑–∞–¥—É–º–∞–ª—Å—è... ü§î\n\n"
                        "–ï—Å–ª–∏ —Å–ª–æ–∂–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª—å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏. "
                        "–Ø –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è!"
                    )
                )
```

---

### 6.2 "–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ Quick Actions"

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å **–±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**:

```python
# –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å inline –∫–Ω–æ–ø–∫–∏:

if primary_pattern.get('title') == '–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è':
    quick_actions = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text='‚è∞ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä 15 –º–∏–Ω', callback_data='action_timer_15')],
        [InlineKeyboardButton(text='üìù –ó–∞–ø–∏—Å–∞—Ç—å 1 –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥', callback_data='action_note_step')],
        [InlineKeyboardButton(text='üí™ –ù–∞—á–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å', callback_data='action_start_now')]
    ])
    
    await message.answer(
        "–ß—Ç–æ –≤—ã–±–µ—Ä–µ—à—å?",
        reply_markup=quick_actions
    )
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```python
@dp.callback_query(F.data.startswith('action_timer_'))
async def handle_timer_action(call: CallbackQuery):
    minutes = int(call.data.replace('action_timer_', ''))
    
    await call.message.answer(f"‚è∞ –¢–∞–π–º–µ—Ä –Ω–∞ {minutes} –º–∏–Ω—É—Ç –∑–∞–ø—É—â–µ–Ω!")
    
    # –ß–µ—Ä–µ–∑ {minutes} –º–∏–Ω—É—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    await asyncio.sleep(minutes * 60)
    await call.message.answer("üéâ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ö–∞–∫ –ø—Ä–æ—à–ª–æ? –ù–∞–ø–∏—à–∏ –º–Ω–µ.")
```

---

### 6.3 "Mood Journal" - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–Ω–µ–≤–Ω–∏–∫

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞ emotional_state:

```python
# soul_bot/bot/workers.py (–¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É)

async def send_weekly_mood_summary():
    """
    –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 20:00 ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å mood summary
    """
    users = await db_user.get_all_active()
    
    for user in users:
        profile = await db_user_profile.get(user.user_id)
        
        if not profile or not profile.emotional_state:
            continue
        
        # –ë–µ—Ä—ë–º mood_history –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        mood_history = profile.emotional_state.get('mood_history', [])
        last_week = [m for m in mood_history if _is_last_7_days(m['date'])]
        
        if len(last_week) < 3:
            continue  # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        summary_text = _format_mood_summary(last_week)
        
        await bot.send_message(
            chat_id=user.user_id,
            text=(
                f"üìä <b>–¢–≤–æ—è –Ω–µ–¥–µ–ª—è –≤ —Ü–∏—Ñ—Ä–∞—Ö</b>\n\n"
                f"{summary_text}\n\n"
                f"–ß—Ç–æ –ø–æ–º–æ–≥–ª–æ? –ß—Ç–æ –º–µ—à–∞–ª–æ? –î–∞–≤–∞–π –æ–±—Å—É–¥–∏–º üí¨"
            ),
            parse_mode='HTML'
        )


def _format_mood_summary(mood_history: list) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç mood history –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
    
    Example:
    –ü–Ω: üòî (slightly_down)
    –í—Ç: üòê (neutral)
    –°—Ä: üôÇ (good)
    """
    mood_emojis = {
        'slightly_down': 'üòî',
        'neutral': 'üòê',
        'good': 'üôÇ',
        'energetic': 'üòÑ'
    }
    
    lines = []
    for entry in mood_history[-7:]:
        date = datetime.fromisoformat(entry['date'])
        weekday = WEEKDAY_MAP[date.weekday()]
        mood = entry['mood']
        emoji = mood_emojis.get(mood, 'üòê')
        
        lines.append(f"{weekday}: {emoji}")
    
    return '\n'.join(lines)
```

---

### 6.4 –û—Ü–µ–Ω–∫–∞ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

| –§—É–Ω–∫—Ü–∏—è | Priority | –°–ª–æ–∂–Ω–æ—Å—Ç—å | Impact |
|---------|----------|-----------|--------|
| –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ | Medium | Low (2/10) | High (8/10) |
| Quick Actions | High | Medium (5/10) | Very High (9/10) |
| Mood Journal | Medium | Low (3/10) | Medium (7/10) |
| Realtime mood detection | High | Medium (4/10) | Very High (9/10) |

---

## 7. üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 7.1 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (Must Have)

1. **Realtime mood detection** (Priority: üî• CRITICAL)
   - –§–∞–π–ª: `soul_bot/bot/services/realtime_mood_detector.py` (–Ω–æ–≤—ã–π)
   - Impact: 9/10
   - Complexity: 4/10
   - Timeline: 2-3 —á–∞—Å–∞

2. **Context relevance check –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏** (Priority: HIGH)
   - –§–∞–π–ª: `soul_bot/bot/services/personalization/engine.py`
   - Impact: 8/10
   - Complexity: 3/10
   - Timeline: 1-2 —á–∞—Å–∞

3. **Unified style settings UI** (Priority: HIGH)
   - –§–∞–π–ª: `soul_bot/bot/keyboards/profile.py`
   - Impact: 8/10
   - Complexity: 2/10
   - Timeline: 1 —á–∞—Å

4. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (Priority: HIGH)
   - –§–∞–π–ª: `soul_bot/bot/services/formatting_service.py` (–Ω–æ–≤—ã–π)
   - Impact: 7/10
   - Complexity: 5/10
   - Timeline: 3-4 —á–∞—Å–∞

5. **–£–¥–∞–ª–∏—Ç—å legacy Assistant API** (Priority: MEDIUM)
   - –§–∞–π–ª: `soul_bot/bot/functions/ChatGPT.py`
   - Impact: 6/10 (code health)
   - Complexity: 2/10
   - Timeline: 30 –º–∏–Ω—É—Ç

---

### 7.2 Nice to Have (Phase 2)

6. **Quiz: –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤**
   - –§–∞–π–ª: `soul_bot/bot/services/quiz_service/generator.py`
   - Impact: 7/10
   - Complexity: 6/10

7. **Quiz: –ø–æ—ç—Ç–∞–ø–Ω–∞—è –ø–æ–¥–∞—á–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
   - –§–∞–π–ª: `soul_bot/bot/services/quiz_service/analyzer.py`
   - Impact: 7/10
   - Complexity: 4/10

8. **Pattern evidence —Å TTL (freshness)**
   - –§–∞–π–ª: `soul_bot/database/models/user_profile.py`
   - Impact: 6/10
   - Complexity: 5/10

9. **Quick Actions –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤**
   - –§–∞–π–ª: `soul_bot/bot/handlers/user/helper.py`
   - Impact: 9/10
   - Complexity: 6/10

10. **Weekly Mood Journal**
    - –§–∞–π–ª: `soul_bot/bot/workers.py`
    - Impact: 7/10
    - Complexity: 4/10

---

## 8. üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å, separation of concerns)  
‚úÖ Pattern Analyzer —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ (embeddings, deduplication)  
‚úÖ Adaptive Quiz - —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è  
‚úÖ Moderate data structure - future-proof  

**–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:**
‚ùå –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è (–Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç)  
‚ùå UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∏–ª—è —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏  
‚ùå –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –¥–ª–∏–Ω–µ  
‚ùå Legacy –∫–æ–¥ –Ω–µ —É–¥–∞–ª—ë–Ω  

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

**–¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥:** 7.5/10  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (–ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π):** 9.2/10  

**Timeline –¥–ª—è Phase 1 (Must Have):**
- Realtime mood detection: 2-3 —á–∞—Å–∞
- Context relevance: 1-2 —á–∞—Å–∞
- Unified UI: 1 —á–∞—Å
- Adaptive formatting: 3-4 —á–∞—Å–∞
- Legacy cleanup: 30 –º–∏–Ω—É—Ç

**–ò—Ç–æ–≥–æ:** ~8-10 —á–∞—Å–æ–≤ —á–∏—Å—Ç–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

**Prepared by:** AI Analysis Agent  
**Date:** October 31, 2025  
**Version:** 1.0

